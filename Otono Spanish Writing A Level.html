<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üü£ Otono Spanish ‚Äî AS/A level Writing (Paper 4) ‚Äî El Drummond Tinta-Cre√≠ble</title>
  <style>
    :root{
      --bg1:#2b0a3d; --bg2:#7a0036;
      --text:#f4efff; --muted:#c9b9ff;
      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --good:#19ff9a; --warn:#ffd166; --bad:#ff4d6d;
      --accent:#b000ff; --accent2:#ff1b6a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(176,0,255,.22), transparent 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(255,27,106,.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:22px;}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky; top:14px; z-index:20; backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0; font-size:16px; letter-spacing:.3px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); font-family:var(--mono); font-size:12px;
      display:flex; gap:10px; align-items:center;
    }
    .pill strong{color:#fff}
    .btn{
      border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.33); border-color:rgba(255,255,255,.22)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(176,0,255,.55), rgba(255,27,106,.45));
      border-color:rgba(255,255,255,.22);
    }
    .btn.danger{background:rgba(255,77,109,.18); border-color:rgba(255,77,109,.35)}
    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:16px; margin-top:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .topbar{position:static} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .hd .meta{font-size:12px; color:var(--muted); line-height:1.25}
    .card .bd{padding:16px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; outline:none;
      font-family:var(--sans);
    }
    textarea{min-height:150px; resize:vertical; line-height:1.55}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > div{flex:1 1 180px}
    .note{
      font-size:12px; color:var(--muted); line-height:1.4;
      padding:10px 12px; border-radius:14px; border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
    }
    .badge{
      font-family:var(--mono); font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.20);
      display:inline-flex; align-items:center; gap:6px;
    }
    .badge.good{border-color:rgba(25,255,154,.35); background:rgba(25,255,154,.12)}
    .badge.warn{border-color:rgba(255,209,102,.35); background:rgba(255,209,102,.12)}
    .badge.bad{border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.12)}
    .divider{height:1px; background:var(--line); margin:14px 0}
    .task{
      padding:12px 14px; border:1px solid var(--line); border-radius:16px;
      background:rgba(0,0,0,.22);
    }
    .task h3{margin:0 0 8px; font-size:13px}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 980px){ .kpi{grid-template-columns:repeat(2,1fr)} }
    .kpi .box{
      border:1px solid var(--line); border-radius:16px; padding:10px 12px;
      background:rgba(0,0,0,.22);
    }
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .kpi .box .v{font-size:18px; font-weight:800; margin-top:4px}
    .small{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:rgba(0,0,0,.22); cursor:pointer; font-weight:700}
    .tab.active{background:linear-gradient(135deg, rgba(176,0,255,.35), rgba(255,27,106,.22)); border-color:rgba(255,255,255,.22)}
    .resultsList{display:grid; gap:10px}
    .attempt{
      border:1px solid var(--line); border-radius:16px; padding:12px 14px;
      background:rgba(0,0,0,.20);
    }
    .attempt .top{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .attempt .top strong{font-family:var(--mono)}
    .attempt .meta{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.4}
    .copy{font-family:var(--mono); font-size:12px; white-space:pre-wrap; word-break:break-word}
    .hide{display:none !important}
    .choice{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      padding:10px 12px; border-radius:14px; margin-top:8px;
    }
    .rubricRow{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .rubPill{
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.18); font-size:12px; color:var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>üü£ Otono Spanish ‚Äî Paper 4 ‚Ä¢ Writing ‚Ä¢ El Drummond Tinta-Cre√≠ble</h1>
        <div class="sub">AS or A level ‚Ä¢ 2 essays (40 + 40) + 1 translation (20) ‚Ä¢ Centre: <strong>50749</strong></div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
        <div class="pill"><span>‚è±Ô∏è Timer:</span><strong id="timerText">--:--</strong></div>
        <button class="btn" id="btnResults">Results</button>
        <button class="btn primary" id="btnHome">Test</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card" id="panelHome">
        <div class="hd">
          <div>
            <h2>Candidate setup</h2>
            <div class="meta">
              Random paper: <strong>2 choices</strong> for Section A + <strong>2 choices</strong> for Section B.
              Auto-marking checks: structure + language signals + <strong>UNDERSTANDING</strong> (anchor hits).
            </div>
          </div>
          <span class="badge" id="statusBadge">Ready</span>
        </div>

        <div class="bd" id="homeBody">
          <div class="row">
            <div>
              <label>Centre number (fixed)</label>
              <input type="text" value="50749" disabled />
            </div>
            <div>
              <label>Candidate number (required)</label>
              <input type="number" id="candidateNo" placeholder="e.g. 9932" min="1" />
            </div>
            <div>
              <label>Candidate name (optional)</label>
              <input type="text" id="candidateName" placeholder="Name" />
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <div>
              <label>Level</label>
              <select id="level">
                <option value="AS">AS level (‚âà 250 words per essay)</option>
                <option value="AL" selected>A level (‚âà 300 words per essay)</option>
              </select>
            </div>

            <div>
              <label>Time allowed</label>
              <select id="timeAllowed"></select>
              <div class="small" id="timeNote" style="margin-top:6px"></div>
            </div>

            <div>
              <label>On timer end</label>
              <select id="autoSubmit">
                <option value="yes" selected>Auto-submit</option>
                <option value="no">Do not auto-submit</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>What ‚Äúunderstanding‚Äù means here:</strong><br/>
            ‚Ä¢ Section B: your answer must clearly reference real <strong>events + characters</strong> from <em>El Drummond Tinta-Cre√≠ble</em> (anchors).<br/>
            ‚Ä¢ Section A: your answer must reference real <strong>Otono Team details</strong> (anchors).<br/>
            ‚Ä¢ Vague essays = low AO2. Clear, specific references = high AO2.
          </div>

          <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap">
            <button class="btn" id="btnPreview">Preview random selection</button>
            <button class="btn primary" id="btnStart">Start random paper</button>
          </div>

          <div id="previewBox" class="note hide" style="margin-top:12px"></div>
        </div>

        <!-- TEST BODY -->
        <div class="bd hide" id="testBody">
          <div class="kpi">
            <div class="box"><div class="t">Candidate</div><div class="v" id="kpiCandidate">‚Äî</div></div>
            <div class="box"><div class="t">Level</div><div class="v" id="kpiLevel">‚Äî</div></div>
            <div class="box"><div class="t">Max score</div><div class="v" id="kpiMax">100</div></div>
            <div class="box"><div class="t">Word targets</div><div class="v" id="kpiWords">‚Äî</div></div>
          </div>

          <div class="divider"></div>

          <div class="note" id="paperInfo"></div>
          <div id="paper"></div>

          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btnSubmit">Submit & Auto-Mark</button>
            <button class="btn" id="btnReset">Reset (new random paper)</button>
          </div>

          <div id="markingBox" class="hide" style="margin-top:14px"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="panelSide">
        <div class="hd">
          <div>
            <h2 id="sideTitle">Grading rules</h2>
            <div class="meta" id="sideMeta">Pass/Merit/Distinction + Grades are returned for every attempt.</div>
          </div>
        </div>

        <div class="bd" id="sideBody">
          <div class="note">
            <strong>Pass / Merit / Distinction</strong><br/>
            PASS: 66+<br/>
            MERIT: 80+<br/>
            DISTINCTION: 90+<br/>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>9‚Äì1 system (out of 100)</strong><br/>
            9: 90+ ‚Ä¢ 8: 80+ ‚Ä¢ 7: 70+ ‚Ä¢ 6: 60+ ‚Ä¢ 5: 50+ ‚Ä¢ 4: 40+ ‚Ä¢ 3: 35+ ‚Ä¢ below 35 = U
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>A‚ÄìH system (out of 100)</strong><br/>
            A*: 95+ ‚Ä¢ A: 90+ ‚Ä¢ B: 80+ ‚Ä¢ C: 70+ ‚Ä¢ D: 66+ ‚Ä¢ E: 55+ ‚Ä¢ F: 45+ ‚Ä¢ G: 40+ ‚Ä¢ below 40 = U
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>UNDERSTANDING check</strong><br/>
            Section A (Otono Team): counts Otono anchors (mansion/airline/rules/roles).<br/>
            Section B (Book): counts book <strong>events + characters</strong> anchors.<br/>
            More anchor hits = stronger AO2.
          </div>

          <div class="divider"></div>
          <div class="small">Results are saved locally on this browser (localStorage).</div>
        </div>

        <!-- RESULTS PANEL -->
        <div class="bd hide" id="resultsBody">
          <div class="tabs">
            <div class="tab active" id="tabAll">All attempts</div>
            <div class="tab" id="tabCandidate">By candidate</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Filter candidate number</label>
              <input type="number" id="filterCandidate" placeholder="e.g. 1105" min="1" />
            </div>
            <div>
              <label>Actions</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" id="btnExport">Export JSON</button>
                <button class="btn danger" id="btnClear">Clear stored results</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="resultsList" id="resultsList"></div>

          <div id="exportBox" class="note hide" style="margin-top:12px">
            <div><strong>Exported JSON</strong> (copy/save it):</div>
            <div class="divider"></div>
            <div class="copy" id="exportText"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   HELPERS
========================================================= */
const $ = (sel) => document.querySelector(sel);

function escapeHtml(str){
  return (str ?? "").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function nowISO(){ return new Date().toISOString(); }
function norm(s){
  return (s ?? "")
    .toString().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ").trim();
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function pickRandom(arr, n){ return shuffle(arr).slice(0,n); }
function wordCount(text){
  const t = (text ?? "").trim();
  if(!t) return 0;
  return t.split(/\s+/).filter(Boolean).length;
}
function setBadge(text, cls="badge"){ const b=$("#statusBadge"); b.className=cls; b.textContent=text; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

/* =========================================================
   TIMER
========================================================= */
let timer = null;
let remainingSec = 0;
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function startTimer(minutes, onEnd){
  stopTimer();
  remainingSec = Math.max(1, Math.floor(minutes*60));
  const tick = () => {
    const m = Math.floor(remainingSec/60);
    const s = remainingSec%60;
    $("#timerText").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    remainingSec--;
    if(remainingSec < 0){
      stopTimer();
      onEnd?.();
    }
  };
  tick();
  timer = setInterval(tick, 1000);
}

/* =========================================================
   STORAGE
========================================================= */
const STORE_KEY = "otonoSpanish_AlevelWriting_v2_understanding";
function loadResults(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveResults(list){ localStorage.setItem(STORE_KEY, JSON.stringify(list)); }
function addResult(attempt){
  const list = loadResults();
  list.unshift(attempt);
  saveResults(list);
}

/* =========================================================
   REQUIRED: REAL EVENTS ‚Äî El Drummond Tinta-Cre√≠ble
   (French -> Spanish only)
========================================================= */
const BOOK_EVENTS = {
  events: [
    {
      id:"E_RESULTS_ENVELOPES",
      label:"Los sobres morados de resultados",
      anchors:[
        "sobre morado",
        "sobres morados",
        "hoja de resultados",
        "resultado detallado",
        "copia original",
        "no pueden modificar",
        "dinero en el sobre",
        "pagar a red",
        "tarjeta de penalizacion",
        "raw mark",
        "scaled mark"
      ]
    },
    {
      id:"E_BLACK_INK_RULE",
      label:"La regla estricta de la tinta negra",
      anchors:[
        "tinta negra obligatoria",
        "boligrafo negro obligatorio",
        "prohibido usar tinta amarilla",
        "penalizacion de tinta",
        "cero por presentacion",
        "presentacion incorrecta",
        "perdio puntos por la tinta",
        "black ink trap"
      ]
    },
    {
      id:"E_PENCIL_REBELLION",
      label:"La rebeli√≥n del examen en l√°piz",
      anchors:[
        "todo el mundo escribio a lapiz",
        "paper 2 en lapiz",
        "pencil not marked",
        "copia no corregida",
        "invigiladores",
        "se negaron a corregir",
        "solo se corrigieron los diagramas"
      ]
    },
    {
      id:"E_CLAYTON_160",
      label:"Clayton y el 160 sobre 160",
      anchors:[
        "160 sobre 160",
        "160 out of 160",
        "mates perfecto",
        "igcse adelantado",
        "arrogancia academica",
        "destruir gary",
        "nota maxima"
      ]
    },
    {
      id:"E_MARKING_PROCESS",
      label:"El proceso de correcci√≥n estricta",
      anchors:[
        "proceso de correccion",
        "correccion estricta",
        "penalizacion de presentacion",
        "nota penalizada",
        "nota original",
        "nota ajustada",
        "perdida de diez puntos",
        "la presentacion mas importante que el contenido"
      ]
    },
    {
      id:"E_BLACK_INK_CONFLICT",
      label:"El conflicto alrededor de la identidad y la tinta",
      anchors:[
        "identidad ligada a la tinta",
        "control academico",
        "obsesion de la perfeccion",
        "disciplina extrema",
        "cultura de rendimiento",
        "presion colectiva",
        "comparacion entre alumnos"
      ]
    },
    {
      id:"E_ROOM_47_IMPORTANT",
      label:"La pila importante de la sala 47",
      anchors:[
        "sala 47",
        "pila importante",
        "solo grade 9",
        "guion guardado",
        "copia excepcional",
        "enviado a la sala 47"
      ]
    },
    {
      id:"E_MONEY_REWARD_SYSTEM",
      label:"El sistema de recompensa y reembolso",
      anchors:[
        "recompensa financiera",
        "reembolsar red",
        "contrato academico",
        "dinero si aprueba",
        "pagar si suspende",
        "acuerdo antes del examen"
      ]
    },
    {
      id:"E_YELLOW_INK_ZERO",
      label:"El cero por tinta amarilla",
      anchors:[
        "cero por tinta amarilla",
        "tinta amarilla prohibida",
        "respuesta no corregida",
        "ciencia en frances cero",
        "perdida de catorce puntos",
        "penalizacion automatica"
      ]
    },
    {
      id:"E_PERFECTION_CRISIS",
      label:"La crisis de la perfecci√≥n acad√©mica",
      anchors:[
        "crisis de identidad academica",
        "obsesion por la nota",
        "perfeccion imposible",
        "ansiedad por los resultados",
        "miedo de perder un punto",
        "presion interna"
      ]
    }
  ]
};

/* =========================================================
   BOOK CHARACTERS ‚Äî El Drummond Tinta-Cre√≠ble (UNDERSTANDING)
   (French -> Spanish only)
========================================================= */
const BOOK_CHARACTERS = {
  chars: [
    {
      id:"C_RED",
      label:"Red",
      anchors:[
        "red",
        "corrector",
        "el corrector",
        "yo soy el marker",
        "sobres morados",
        "sistema de recompensa",
        "reembolsar red",
        "reglas de tinta",
        "tinta amarilla prohibida",
        "penalizacion de tinta",
        "frances",
        "la marseillaise",
        "la marsella",
        "la marsellesa",
      ]
    },
    {
      id:"C_LUKE",
      label:"Luke",
      anchors:[
        "luke",
        "tinta negra",
        "boligrafo negro",
        "diagramas",
        "graficos",
        "sohcahtoa",
        "obsesion del negro",
        "precision",
        "detalles"
      ]
    },
    {
      id:"C_OWING",
      label:"OWing",
      anchors:[
        "owing",
        "organizacion",
        "estrategia",
        "revision",
        "disciplina",
        "lider",
        "co lider",
        "rutinas",
        "porsche",
        "mates",
        "matematicas",
        "arrogancia",
      ]
    },
    {
      id:"C_JESSICA",
      label:"Jessica",
      anchors:[
        "jessica",
        "piano",
        "metodo",
        "perfeccionismo",
        "analisis",
        "muy buena en mates",
        "rigor"
      ]
    },
    {
      id:"C_BENJAMIN_NELSON",
      label:"Benjamin Nelson",
      anchors:[
        "benjamin nelson",
        "black ink trap",
        "trampa de tinta negra",
        "no te compares",
        "compararse con otros",
        "tinta negra",
        "escritura",
        "mejor en redaccion",
        "96",
        "96 marks",
        "nota 9",
      ]
    },
    {
      id:"C_WYATT",
      label:"Wyatt",
      anchors:[
        "wyatt",
        "doritos",
        "tinta negra",
        "odia la tinta amarilla",
        "hate yellow ink",
        "odia la ciencia"
      ]
    },
    {
      id:"C_THOMAS",
      label:"Thomas",
      anchors:[
        "thomas",
        "tardis",
        "lenfer",
        "l enfer",
        "dispraxia",
        "ordenador",
        "noche",
        "darkness"
      ]
    },
    {
      id:"C_JOSHUA",
      label:"Joshua",
      anchors:[
        "joshua",
        "dinosaurios",
        "bromas",
        "odia perder educacion",
        "missing education",
        "inaceptable llegar tarde",
        "nunca castigo",
        "detention"
      ]
    },
    {
      id:"C_SHIREEN",
      label:"Shireen",
      anchors:[
        "shireen",
        "espanol",
        "frances",
        "idiomas",
        "mfl"
      ]
    },
    {
      id:"C_TORRAN",
      label:"Torran",
      anchors:[
        "torran",
        "apenas aprobo",
        "just passed",
        "un punto mas y suspende",
        "limite",
        "aprobado"
      ]
    },
    {
      id:"C_RAPHAEL",
      label:"Raphael",
      anchors:[
        "raphael",
        "poco activo",
        "snapchat",
        "casi no activo"
      ]
    },
    {
      id:"C_CLAYTON",
      label:"Clayton",
      anchors:[
        "clayton",
        "160 sobre 160",
        "160 out of 160",
        "mates perfecto",
        "arrogancia academica",
        "destruir gary",
        "nota maxima"
      ]
    },
    {
      id:"C_ANGUS",
      label:"Angus",
      anchors:[
        "angus",
        "inkredible",
        "tinta negra",
        "siempre negro",
        "odia el lapiz",
        "resit",
        "tiene que repetir"
      ]
    }
  ]
};

/* =========================================================
   OTONO TEAM ANCHORS (UNDERSTANDING CHECK FOR SECTION A)
   (French -> Spanish only)
========================================================= */
const OTONO_ANCHORS = [
  { id:"OT_MANSION_90", label:"La mansi√≥n Otono (90 habitaciones)", anchors:["mansion otono","mansi√≥n otono","90 habitaciones","90 pieces","90 pi√®ces","border of bristol","bristol","bath"] },
  { id:"OT_ROOMS", label:"N√∫meros de salas (47/64‚Äì71/84)", anchors:["sala 47","room 47","sala 84","room 84","64","65","66","67","68","69","70","71"] },
  { id:"OT_AIRWAYS", label:"Otono Airways / A380 / clases", anchors:["otono airways","a380","clase turista","economy","business","first","lounge","salon","heathrow"] },
  { id:"OT_BLACK_INK_CULTURE", label:"Cultura de tinta negra (equipo)", anchors:["tinta negra","boligrafo negro","black ink","tinta amarilla","yellow ink","penalizacion"] },
  { id:"OT_TEAM_STRUCTURE", label:"Estructura del equipo", anchors:["otono team","leaders","lideres","co leader","co lider","assistant leader","residencia","mansion assistants"] },
];

/* =========================================================
   QUESTION BANKS (>= 12 per section)
   (French -> Spanish only)
========================================================= */
const BANK_A = [
  { id:"A1", level:"AL", title:"¬øHasta qu√© punto el Otono Team representa un modelo de disciplina y ambici√≥n acad√©mica?", keywords:["disciplina","ambicion","examenes","reglas","resultados","presion","organizacion"] },
  { id:"A2", level:"AL", title:"Analiza la importancia de las reglas (tinta, instrucciones, presentaci√≥n) en la din√°mica del grupo.", keywords:["reglas","instrucciones","tinta","presentacion","cohesion","conflictos","justicia"] },
  { id:"A3", level:"AL", title:"¬øC√≥mo influyen las diferencias de personalidad en los conflictos y los √©xitos del equipo?", keywords:["personalidad","conflicto","exito","cooperacion","comunicacion","celos"] },
  { id:"A4", level:"AL", title:"¬øLa competencia acad√©mica es beneficiosa o peligrosa para el Otono Team?", keywords:["competencia","comparacion","motivacion","estres","perfeccion","progreso"] },
  { id:"A5", level:"AL", title:"Estudia el papel del liderazgo en el Otono Team: ¬øqui√©n influye m√°s y por qu√©?", keywords:["liderazgo","influencia","decisiones","responsabilidad","equilibrio","autoridad"] },
  { id:"A6", level:"AL", title:"¬øHasta qu√© punto la presi√≥n de los resultados afecta las relaciones entre los miembros?", keywords:["presion","resultados","relaciones","celos","admiracion","confianza"] },
  { id:"A7", level:"AL", title:"Comenta la importancia de la precisi√≥n (detalles, organizaci√≥n, m√©todo) para triunfar en el Otono Team.", keywords:["precision","metodo","organizacion","detalles","eficacia","revision"] },
  { id:"A8", level:"AL", title:"¬øEl Otono Team valora m√°s el rendimiento o el bienestar? Justifica.", keywords:["rendimiento","bienestar","estres","apoyo","prioridades","equilibrio"] },
  { id:"A9", level:"AL", title:"Analiza el papel de los ‚Äúrituales‚Äù (h√°bitos, sistemas, rutinas) en el √©xito del grupo.", keywords:["rituales","rutinas","habitos","sistema","disciplina","resultados"] },
  { id:"A10", level:"AL", title:"¬øHasta qu√© punto la identidad del grupo depende de sus reglas y de sus s√≠mbolos?", keywords:["identidad","simbolos","reglas","cohesion","cultura","valores"] },
  { id:"A11", level:"AL", title:"Comenta el efecto de las comparaciones entre alumnos en la motivaci√≥n y la confianza.", keywords:["comparaciones","motivacion","confianza","celos","admiracion","presion"] },
  { id:"A12", level:"AL", title:"Explica c√≥mo el equipo gestiona las reglas y las excepciones. ¬øEs coherente?", keywords:["excepciones","coherencia","justicia","consecuencias","reglas","autoridad"] },

  { id:"A13", level:"AS", title:"Explica por qu√© las reglas son importantes para el Otono Team.", keywords:["reglas","organizacion","disciplina","examenes","instrucciones"] },
  { id:"A14", level:"AS", title:"¬øC√≥mo influye la presi√≥n de los ex√°menes en los miembros?", keywords:["presion","examenes","estres","revision","resultados"] },
  { id:"A15", level:"AS", title:"Describe lo que hace √∫nico al Otono Team.", keywords:["unico","grupo","valores","reglas","ambicion"] },
  { id:"A16", level:"AS", title:"En tu opini√≥n, ¬øel Otono Team es un grupo unido? ¬øPor qu√©?", keywords:["unido","cohesion","conflictos","apoyo","amistad"] },
];

const BANK_B = [
  { id:"B1", level:"AL", title:"¬øC√≥mo presenta la novela el tema de la perfecci√≥n acad√©mica en El Drummond Tinta-Cre√≠ble?", keywords:["perfeccion","academica","presion","notas","consecuencias","critica"] },
  { id:"B2", level:"AL", title:"Analiza la evoluci√≥n psicol√≥gica de un personaje clave a lo largo de la novela.", keywords:["evolucion","psicologica","personaje","motivacion","cambio","crisis"] },
  { id:"B3", level:"AL", title:"¬øHasta qu√© punto la novela critica el sistema educativo moderno?", keywords:["critica","sistema","educativo","reglas","calificacion","injusticia"] },
  { id:"B4", level:"AL", title:"Comenta el simbolismo de la tinta negra en la novela.", keywords:["simbolismo","tinta","negra","identidad","poder","control"] },
  { id:"B5", level:"AL", title:"¬øLa novela es una tragedia acad√©mica o una s√°tira? Justifica.", keywords:["tragedia","satira","tono","mensaje","ironia","tension"] },
  { id:"B6", level:"AL", title:"¬øC√≥mo contribuyen las rivalidades escolares a la tensi√≥n narrativa?", keywords:["rivalidades","tension","narrativa","conflictos","riesgos","ritmo"] },
  { id:"B7", level:"AL", title:"Analiza el papel de las reglas y los castigos en el desarrollo de la trama.", keywords:["reglas","castigos","trama","consecuencias","justicia","escalada"] },
  { id:"B8", level:"AL", title:"¬øHasta qu√© punto el autor muestra que un detalle puede cambiarlo todo?", keywords:["detalle","precision","instrucciones","resultados","errores","contraste"] },
  { id:"B9", level:"AL", title:"Comenta c√≥mo la novela trata la comparaci√≥n entre alumnos y sus efectos.", keywords:["comparacion","alumnos","celos","admiracion","presion","autoestima"] },
  { id:"B10", level:"AL", title:"Analiza la relaci√≥n entre disciplina y libertad en la novela.", keywords:["disciplina","libertad","control","eleccion","resistencia","equilibrio"] },
  { id:"B11", level:"AL", title:"¬øHasta qu√© punto la novela presenta una ‚Äúcultura del rendimiento‚Äù?", keywords:["cultura","rendimiento","resultados","reputacion","presion","valores"] },
  { id:"B12", level:"AL", title:"¬øEl estilo de la novela refuerza el mensaje? Comenta.", keywords:["estilo","mensaje","narracion","tono","ironia","efecto"] },

  { id:"B13", level:"AS", title:"Describe un personaje importante de la novela y explica su papel.", keywords:["personaje","papel","historia","relaciones","decisiones"] },
  { id:"B14", level:"AS", title:"Explica la importancia de los ex√°menes en la novela.", keywords:["examenes","presion","resultados","consecuencias","trama"] },
  { id:"B15", level:"AS", title:"¬øC√≥mo se presenta la rivalidad en el relato?", keywords:["rivalidad","conflicto","tension","comparacion","motivacion"] },
  { id:"B16", level:"AS", title:"¬øQu√© importancia tiene la tinta negra en la historia?", keywords:["tinta","negra","reglas","simbolismo","identidad"] },
];

/* (These are English source texts; keep them English) */
const TRANSLATION_POOL = [
  {
    id:"T1",
    en:`During the mock exams, the students believed that small details did not matter. However, the marking process proved the opposite. One candidate lost marks because of presentation, while another succeeded thanks to precision and discipline. In the future, they will understand that perfection is not only about knowledge, but also about attitude.`,
    keyIdeas: [
      ["simulacros","ex√°menes simulados","ex√°menes de prueba","mocks"],
    ["peque√±os detalles","detalles peque√±os","detalles menores","detalles"],
    ["no importaban","no eran importantes","no ten√≠a importancia","no importaba"],
    ["sin embargo","no obstante","pero"],
    ["proceso de correcci√≥n","proceso de calificaci√≥n","correcci√≥n","evaluaci√≥n"],
    ["demostr√≥ lo contrario","prob√≥ lo contrario","mostr√≥ lo contrario"],
    ["perdi√≥ puntos","le quitaron puntos","perdi√≥ notas"],
    ["presentaci√≥n","presentaci√≥n del examen","la presentaci√≥n"],
    ["otro tuvo √©xito","otro lo consigui√≥","otro logr√≥","tuvo √©xito"],
    ["gracias a","debido a"],
    ["precisi√≥n","la precisi√≥n"],
    ["disciplina","la disciplina"],
    ["en el futuro","en un futuro","futuro"],
    ["no solo por el conocimiento","no solo se trata de conocimiento","no solo sobre el conocimiento"],
    ["sino tambi√©n por la actitud","pero tambi√©n la actitud","actitud"]
    ]
  },
  {
    id:"T2",
    en:`In school, rules can protect students, but they can also create anxiety. If someone follows the instructions carefully, they feel safer. On the other hand, one mistake can become a big problem. Next year, the class wants a fairer system.`,
    keyIdeas: [
      ["reglas","normas","instrucciones"],
    ["proteger","protegen","pueden proteger"],
    ["pero","sin embargo","no obstante"],
    ["ansiedad","estr√©s","estres","nerviosismo"],
    ["sigue","seguir","cumple","hacer caso de"],
    ["cuidadosamente","con cuidado","con mucha atenci√≥n","atentamente"],
    ["m√°s seguro","m√°s segura","se siente seguro","se siente segura","m√°s seguros"],
    ["por otro lado","en cambio"],
    ["error","un error","un fallo","una equivocaci√≥n"],
    ["gran problema","problema grande","problema importante"],
    ["el a√±o que viene","el pr√≥ximo a√±o","pr√≥ximo a√±o"],
    ["sistema m√°s justo","sistema m√°s equitativo","sistema justo","m√°s justo"]
    ]
  }
];

/* =========================================================
   LANGUAGE SIGNALS
   (French -> Spanish only)
========================================================= */
const SPANISH_MARKERS = [
  // core pronouns / function words
  "yo","tu","t√∫","√©l","el","ella","nosotros","vosotros","ustedes",
  "mi","mis","un","una","unos","unas","de","del","al","con","sin","para","por","en",

  // time markers
  "hoy","ayer","ma√±ana","manana","ahora","en el futuro","la semana que viene",
  "antes","despu√©s","despues","mientras","cuando",

  // core discourse
  "porque","pero","aunque","sin embargo","por eso","adem√°s","ademas","tambi√©n","tambien",
  "por ejemplo","en cambio","mientras que",

  // A-level essay / analytical signals
  "en efecto","en realidad","de hecho","por una parte","por otra parte",
  "es evidente que","est√° claro que","cabe se√±alar que","hay que destacar que",
  "se puede afirmar que","esto demuestra que","esto significa que",
  "en resumen","en definitiva","en conclusi√≥n"
];

const CONNECTORS = [
  // cause
  "porque","ya que","puesto que","debido a","gracias a","a causa de",

  // contrast / concession
  "pero","sin embargo","no obstante","aunque","aun asi","a√∫n as√≠",
  "a pesar de","pese a","si bien",

  // result / consequence
  "por eso","asi que","as√≠ que","por lo tanto","por consiguiente","en consecuencia",

  // addition / structure
  "adem√°s","ademas","tambi√©n","tambien","de hecho","en efecto","por ejemplo",
  "por una parte","por otra parte","por un lado","por otro lado",
  "primero","en primer lugar","luego","despu√©s","despues","finalmente",

  // comparison / contrast structures
  "en cambio","mientras","mientras que","en vez de"
];

const RANGE_MARKERS = [
  // subordination / clause depth
  "que","si","cuando","mientras","mientras que","aunque","ya que",

  // purpose + subjunctive triggers (huge at A-level)
  "para que","a fin de que","con el fin de que",
  "es posible que","es probable que","es importante que","es necesario que",
  "quiero que","prefiero que","no creo que","dudo que",

  // relatives + formal reference
  "lo que","lo cual","el cual","la cual","los cuales","las cuales",

  // infinitive structures
  "antes de","despu√©s de","despues de","al",
  "al + infinitivo","para + infinitivo",

  // concessive / advanced frames
  "a pesar de","pese a","si bien",

  // exemplification / argumentation
  "por ejemplo","de hecho","en efecto"
];

const NEGATION = [
  "no","nunca","jam√°s","jamas","nadie","nada","ning√∫n","ningun","ninguna","ni"
];

function countHits(textNorm, vocab){
  let hits = 0;
  vocab.forEach(w=>{
    const k = norm(w);
    if(k && textNorm.includes(k)) hits++;
  });
  return hits;
}
function langSignalScore(textNorm){
  let markerHits=0;
  SPANISH_MARKERS.forEach(m=>{ if(textNorm.includes(norm(m))) markerHits++; });
  const markerScore = clamp(Math.round((markerHits/12)*6), 0, 6);
  const conn = countHits(textNorm, CONNECTORS);
  const connScore = clamp(conn >= 3 ? 2 : (conn >= 1 ? 1 : 0), 0, 2);
  const range = countHits(textNorm, RANGE_MARKERS);
  const rangeScore = clamp(range >= 3 ? 2 : (range >= 1 ? 1 : 0), 0, 2);
  const neg = countHits(textNorm, NEGATION);
  const negScore = clamp(neg >= 2 ? 1 : (neg >= 1 ? 0.5 : 0), 0, 1);
  return clamp(markerScore + connScore + rangeScore + negScore, 0, 10);
}

/* =========================================================
   UNDERSTANDING ENGINE (ANCHOR HITS)
========================================================= */
function anchorReport(textNorm, packs){
  let packHits = 0;
  let totalAnchorHits = 0;
  const hitPacks = [];

  packs.forEach(p=>{
    let thisPackHit = 0;
    (p.anchors || []).forEach(a=>{
      const k = norm(a);
      if(k && textNorm.includes(k)){
        thisPackHit++;
        totalAnchorHits++;
      }
    });
    if(thisPackHit > 0){
      packHits++;
      hitPacks.push({ id:p.id, label:p.label, anchorsHit:thisPackHit });
    }
  });

  return { packHits, totalAnchorHits, hitPacks };
}

function understandingScoreSectionB(textNorm){
  const combined = BOOK_EVENTS.events.concat(BOOK_CHARACTERS.chars);
  const rep = anchorReport(textNorm, combined);

  const packScore = clamp(Math.round((rep.packHits / 3) * 8), 0, 8);
  const densityBonus = clamp(Math.min(2, Math.floor(rep.totalAnchorHits / 4)), 0, 2);
  const score10 = clamp(packScore + densityBonus, 0, 10);

  return { score10, rep };
}

function understandingScoreSectionA(textNorm){
  const rep = anchorReport(textNorm, OTONO_ANCHORS);

  const packScore = clamp(Math.round((rep.packHits / 3) * 8), 0, 8);
  const densityBonus = clamp(Math.min(2, Math.floor(rep.totalAnchorHits / 4)), 0, 2);
  const score10 = clamp(packScore + densityBonus, 0, 10);

  return { score10, rep };
}

/* =========================================================
   GRADES (English stays English)
========================================================= */
function passMeritDistinction(score){
  if(score >= 90) return "DISTINCTION";
  if(score >= 80) return "MERIT";
  if(score >= 66) return "PASS";
  return "FAIL";
}
function grade9to1_100(score){
  if(score >= 90) return 9;
  if(score >= 80) return 8;
  if(score >= 70) return 7;
  if(score >= 60) return 6;
  if(score >= 50) return 5;
  if(score >= 40) return 4;
  if(score >= 35) return 3;
  return "U";
}
function gradeAH_100(score){
  if(score >= 95) return "A*";
  if(score >= 90) return "A";
  if(score >= 80) return "B";
  if(score >= 70) return "C";
  if(score >= 66) return "D";
  if(score >= 55) return "E";
  if(score >= 45) return "F";
  if(score >= 40) return "G";
  return "U";
}
function badgeForScore(score){
  if(score >= 90) return ["badge good","üèÜ Excelente"];
  if(score >= 80) return ["badge good","‚≠ê Muy bien"];
  if(score >= 66) return ["badge warn","‚úÖ Ok"];
  return ["badge bad","‚ùå Malo"];
}

/* =========================================================
   PAPER GENERATION
========================================================= */
function bankForLevel(bank, level){
  if(level==="AS"){
    const as = bank.filter(q=>q.level==="AS");
    const al = bank.filter(q=>q.level==="AL");
    return shuffle([].concat(as, as, as, al));
  }else{
    const al = bank.filter(q=>q.level==="AL");
    const as = bank.filter(q=>q.level==="AS");
    return shuffle([].concat(al, al, al, as));
  }
}
function generatePaper(level){
  const A = bankForLevel(BANK_A, level);
  const B = bankForLevel(BANK_B, level);
  const pickA = pickRandom(A, 2);
  const pickB = pickRandom(B, 2);
  const trans = pickRandom(TRANSLATION_POOL, 1)[0];

  const wordTargets = (level==="AS")
    ? { essayTarget:250, essayMin:220, essayMax:320, transMin:80 }
    : { essayTarget:300, essayMin:260, essayMax:380, transMin:80 };

  return { level, wordTargets, sectionA:pickA, sectionB:pickB, translation:trans };
}

/* =========================================================
   TIME OPTIONS (English stays English)
========================================================= */
function populateTimeOptions(){
  const level = $("#level").value;
  const sel = $("#timeAllowed");
  const prev = sel.value;
  sel.innerHTML = "";

  const options = (level==="AS")
    ? [{ v:105, label:"105 minutes (recommended)" }, { v:90, label:"90 minutes" }, { v:75, label:"75 minutes" }]
    : [{ v:120, label:"120 minutes (recommended)" }, { v:105, label:"105 minutes" }, { v:90, label:"90 minutes" }];

  $("#timeNote").innerHTML = (level==="AS")
    ? "AS: recommended <strong>105 minutes</strong>."
    : "A level: recommended <strong>120 minutes</strong>.";

  const valid = new Set(options.map(o=>String(o.v)));
  const useValue = valid.has(String(prev)) ? String(prev) : String(options[0].v);

  options.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = String(o.v);
    opt.textContent = o.label;
    if(opt.value === useValue) opt.selected = true;
    sel.appendChild(opt);
  });
}
$("#level").addEventListener("change", populateTimeOptions);

/* =========================================================
   RENDERING
========================================================= */
let state = {
  submitted:false,
  candidateNo:null,
  candidateName:"",
  paper:null
};

function renderHome(){
  $("#homeBody").classList.remove("hide");
  $("#testBody").classList.add("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideBody").classList.remove("hide");
  $("#sideTitle").textContent = "Grading rules";
  $("#sideMeta").textContent = "Pass/Merit/Distinction + Grades + Understanding anchors.";
  $("#timerText").textContent = "--:--";
  setBadge("Ready","badge");
}

function makeTaskCard(title, meta, innerHtml){
  const wrap = document.createElement("div");
  wrap.className = "task";
  wrap.innerHTML = `
    <h3>${escapeHtml(title)}</h3>
    <div class="small">${escapeHtml(meta)}</div>
    <div class="divider"></div>
    ${innerHtml}
  `;
  return wrap;
}
function wireWordCount(textareaId, outId){
  const ta = $("#"+textareaId);
  const out = $("#"+outId);
  if(!ta || !out) return;
  const draw = () => out.textContent = `Word count: ${wordCount(ta.value)}`;
  ta.addEventListener("input", draw);
  draw();
}

function renderTest(){
  $("#homeBody").classList.add("hide");
  $("#testBody").classList.remove("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideBody").classList.remove("hide");

  const p = state.paper;
  const cand = `${state.candidateNo}${state.candidateName ? " ‚Ä¢ "+state.candidateName : ""}`;
  $("#kpiCandidate").textContent = cand;
  $("#kpiLevel").textContent = p.level === "AS" ? "AS" : "A LEVEL";
  $("#kpiWords").textContent = `Essays ${p.wordTargets.essayTarget} ‚Ä¢ Trans ‚â• ${p.wordTargets.transMin}`;
  $("#kpiMax").textContent = "100";

  const mins = parseInt($("#timeAllowed").value,10);
  const auto = $("#autoSubmit").value === "yes";
  $("#paperInfo").innerHTML = `
    <strong>Instructions:</strong> no dictionary/translator. Choose 1 option in each section. Spanish only.
    <br/><strong>Level:</strong> ${escapeHtml(p.level)} ‚Ä¢ <strong>Time:</strong> ${mins} min ‚Ä¢ <strong>Auto-submit:</strong> ${auto ? "ON" : "OFF"}
  `;

  const paperDiv = $("#paper");
  paperDiv.innerHTML = "";
  $("#markingBox").classList.add("hide");
  $("#markingBox").innerHTML = "";
  state.submitted = false;

  paperDiv.appendChild(renderSectionA(p.sectionA, p.wordTargets));
  paperDiv.appendChild(renderSectionB(p.sectionB, p.wordTargets));
  paperDiv.appendChild(renderTranslation(p.translation, p.wordTargets));

  startTimer(mins, () => {
    if($("#autoSubmit").value==="yes") submitPaper(true);
    else alert("Time is up. You can still submit manually.");
  });

  setBadge("In progress","badge warn");
}

/* Section bodies: English scaffolding stays English, only French -> Spanish parts changed */
function renderSectionA(choices, targets){
  const html = `
    <div class="note">
      <strong>SECTION A ‚Äî Otono Team</strong> (40 marks)<br/>
      Choose <strong>ONE</strong> question. Write about <strong>${targets.essayTarget} words</strong>.
      <div class="rubricRow">
        <span class="rubPill">argumento</span><span class="rubPill">an√°lisis</span>
        <span class="rubPill">detalles Otono</span><span class="rubPill">conclusi√≥n</span>
      </div>
    </div>

    <div id="A_choices">
      ${choices.map((q,i)=>`
        <div class="choice">
          <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer">
            <input type="radio" name="A_pick" value="${i}" style="margin-top:3px" ${i===0?"checked":""}/>
            <div>
              <strong>Option ${i+1} ‚Äî ${escapeHtml(q.title)}</strong>
              <div class="small">Code: ${escapeHtml(q.id)} ‚Ä¢ Palabras clave: ${escapeHtml(q.keywords.join(", "))}</div>
            </div>
          </label>
        </div>
      `).join("")}
    </div>

    <label>Your essay (Section A)</label>
    <textarea id="essayA" placeholder="‚âà ${targets.essayTarget} words... (Spanish)"></textarea>
    <div class="small" id="essayA_wc"></div>
  `;
  const card = makeTaskCard("Q1 Essay ‚Äî Section A", "40 marks ‚Ä¢ includes Otono understanding anchors (AO2)", html);
  setTimeout(()=>wireWordCount("essayA","essayA_wc"), 0);
  return card;
}

function renderSectionB(choices, targets){
  const html = `
    <div class="note">
      <strong>SECTION B ‚Äî El Drummond Tinta-Cre√≠ble</strong> (40 marks)<br/>
      Choose <strong>ONE</strong> question. Write about <strong>${targets.essayTarget} words</strong>.
      <div class="rubricRow">
        <span class="rubPill">temas</span><span class="rubPill">eventos</span>
        <span class="rubPill">personajes</span><span class="rubPill">an√°lisis</span>
      </div>
    </div>

    <div id="B_choices">
      ${choices.map((q,i)=>`
        <div class="choice">
          <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer">
            <input type="radio" name="B_pick" value="${i}" style="margin-top:3px" ${i===0?"checked":""}/>
            <div>
              <strong>Option ${i+1} ‚Äî ${escapeHtml(q.title)}</strong>
              <div class="small">Code: ${escapeHtml(q.id)} ‚Ä¢ Palabras clave: ${escapeHtml(q.keywords.join(", "))}</div>
            </div>
          </label>
        </div>
      `).join("")}
    </div>

    <label>Your essay (Section B)</label>
    <textarea id="essayB" placeholder="‚âà ${targets.essayTarget} words... (Spanish)"></textarea>
    <div class="small" id="essayB_wc"></div>
  `;
  const card = makeTaskCard("Q2 Essay ‚Äî Section B", "40 marks ‚Ä¢ includes book understanding anchors (AO2)", html);
  setTimeout(()=>wireWordCount("essayB","essayB_wc"), 0);
  return card;
}

function renderTranslation(item, targets){
  const html = `
    <div class="note">
      <strong>SECTION C ‚Äî Translation EN ‚Üí ES</strong> (20 marks)<br/>
      Minimum <strong>${targets.transMin} words</strong>.
      <div class="divider"></div>
      <div class="small">${escapeHtml(item.en)}</div>
      <div class="small" style="margin-top:10px">Code: ${escapeHtml(item.id)}</div>
    </div>

    <label>Your translation (Spanish)</label>
    <textarea id="trans" placeholder="‚â• ${targets.transMin} words... (Spanish)"></textarea>
    <div class="small" id="trans_wc"></div>
  `;
  const card = makeTaskCard("Q3 Translation", "20 marks ‚Ä¢ accuracy (10) + quality (10) + min words", html);
  setTimeout(()=>wireWordCount("trans","trans_wc"), 0);
  return card;
}

/* =========================================================
   MARKING
========================================================= */
function essayWordBand(wc, targets){
  if(wc >= targets.essayMin && wc <= targets.essayMax) return 6;
  if(wc >= Math.round(targets.essayMin*0.85)) return 4;
  if(wc >= Math.round(targets.essayMin*0.70)) return 2;
  return 1;
}
function essayStructure(textNorm){
  const hasIntro = (
    textNorm.includes("en esta redaccion") ||
    textNorm.includes("en esta redacci√≥n") ||
    textNorm.includes("voy a demostrar") ||
    textNorm.includes("voy a analizar") ||
    textNorm.includes("en este ensayo")
  ) ? 1 : 0;

  const hasConclusion = (
    textNorm.includes("en conclusion") ||
    textNorm.includes("en conclusi√≥n") ||
    textNorm.includes("para concluir") ||
    textNorm.includes("en resumen") ||
    textNorm.includes("finalmente")
  ) ? 1 : 0;

  const conn = countHits(textNorm, CONNECTORS);
  const connPts = clamp(Math.round((conn/6)*6), 0, 6);
  return clamp(hasIntro + hasConclusion + connPts, 0, 8);
}
function essayRelevance(textNorm, keywords){
  const hits = countHits(textNorm, keywords || []);
  const score = clamp(Math.round((hits/6)*8), 0, 8);
  return { score, hits };
}

function markEssay40(text, chosenQ, section, targets){
  const t = norm(text);
  const wc = wordCount(text);
  if(!t) return {score:0, max:40, detail:"Blank.", parts:{}};

  const w = essayWordBand(wc, targets);                      // /6
  const s = essayStructure(t);                               // /8
  const rel = essayRelevance(t, chosenQ.keywords);           // /8
  const lang = clamp(Math.round((langSignalScore(t)/10)*8), 0, 8);  // /8
  const u = (section==="A") ? understandingScoreSectionA(t) : understandingScoreSectionB(t); // /10

  const score = clamp(w + s + rel.score + lang + u.score10, 0, 40);
  const detail = `WC ${wc} => ${w}/6; structure ${s}/8; relevance ${rel.score}/8 (kw hits ${rel.hits}); language ${lang}/8; understanding ${u.score10}/10 (packs ${u.rep.packHits}, anchors ${u.rep.totalAnchorHits}).`;
  return {score, max:40, detail, parts:{wc,w,s,rel:rel.score,lang,u}};
}

function markTranslation20(text, keyIdeas, targets){
  const t = norm(text);
  const wc = wordCount(text);
  if(!t) return {score:0, max:20, detail:"Blank.", parts:{ideas:0,quality:0,minWords:0}};
  const minWords = (wc >= targets.transMin) ? 1 : 0;

  let ideaHits = 0;
  (keyIdeas || []).forEach(group=>{
    const alts = Array.isArray(group) ? group : [group];
    if(alts.some(k => t.includes(norm(k)))) ideaHits++;
  });
  const ideas = clamp(Math.round((ideaHits / Math.min(10, (keyIdeas||[]).length)) * 10), 0, 10);

  let quality = clamp(Math.round(langSignalScore(t)), 0, 10);
  if(!minWords) quality = Math.max(0, quality - 3);

  const score = clamp(ideas + quality, 0, 20);
  const detail = `WC ${wc} (min ${targets.transMin}); ideas ${ideas}/10 (hits ${ideaHits}); quality ${quality}/10.`;
  return {score, max:20, detail, parts:{ideas,quality,minWords,wc}};
}

/* =========================================================
   TOTAL + SUBMIT
========================================================= */
function computeTotal(){
  const p = state.paper;
  const targets = p.wordTargets;

  const pickA = parseInt(($("input[name='A_pick']:checked")?.value ?? "0"),10);
  const pickB = parseInt(($("input[name='B_pick']:checked")?.value ?? "0"),10);

  const chosenA = p.sectionA[pickA];
  const chosenB = p.sectionB[pickB];

  const aText = $("#essayA").value;
  const bText = $("#essayB").value;
  const tText = $("#trans").value;

  const aMark = markEssay40(aText, chosenA, "A", targets);
  const bMark = markEssay40(bText, chosenB, "B", targets);
  const tMark = markTranslation20(tText, p.translation.keyIdeas, targets);

  const total = clamp(Math.round(aMark.score + bMark.score + tMark.score), 0, 100);

  const breakdown = [
    {part:`Q1 Essay A (${chosenA.id})`, score:aMark.score, max:aMark.max, detail:aMark.detail, understanding:aMark.parts.u},
    {part:`Q2 Essay B (${chosenB.id})`, score:bMark.score, max:bMark.max, detail:bMark.detail, understanding:bMark.parts.u},
    {part:`Q3 Translation (${p.translation.id})`, score:tMark.score, max:tMark.max, detail:tMark.detail},
  ];

  return { total, max:100, breakdown, chosen:{A:chosenA.id, B:chosenB.id, T:p.translation.id} };
}

function submitPaper(fromAuto=false){
  if(state.submitted) return;
  state.submitted = true;
  stopTimer();

  const res = computeTotal();
  const total = res.total;

  const pmd = passMeritDistinction(total);
  const g9 = grade9to1_100(total);
  const gah = gradeAH_100(total);
  const [cls, txt] = badgeForScore(total);

  const attempt = {
    centre:"50749",
    candidateNo:String(state.candidateNo),
    candidateName:state.candidateName || "",
    level: state.paper.level,
    submittedAt: nowISO(),
    timeAllowedMin: parseInt($("#timeAllowed").value,10),
    maxScore: res.max,
    score: total,
    passMeritDistinction: pmd,
    grade9to1: g9,
    gradeAH: gah,
    chosen: res.chosen,
    breakdown: res.breakdown
  };
  addResult(attempt);

  const uA = res.breakdown[0].understanding;
  const uB = res.breakdown[1].understanding;

  const understandsOtono = (uA?.rep?.packHits ?? 0) >= 2;
  const understandsBook  = (uB?.rep?.packHits ?? 0) >= 2;

  const box = $("#markingBox");
  box.classList.remove("hide");
  box.innerHTML = `
    <div class="card">
      <div class="hd">
        <div>
          <h2 style="margin:0;font-size:14px">‚úÖ Marked${fromAuto ? " (auto-submitted)" : ""}</h2>
          <div class="meta">Saved to Results ‚Ä¢ Candidate ${escapeHtml(attempt.candidateNo)} ‚Ä¢ Level ${escapeHtml(attempt.level)}</div>
        </div>
        <span class="${cls}">${escapeHtml(txt)}</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box"><div class="t">Score</div><div class="v">${attempt.score} / ${attempt.maxScore}</div></div>
          <div class="box"><div class="t">PMD</div><div class="v">${escapeHtml(attempt.passMeritDistinction)}</div></div>
          <div class="box"><div class="t">9‚Äì1</div><div class="v">${escapeHtml(String(attempt.grade9to1))}</div></div>
          <div class="box"><div class="t">A‚ÄìH</div><div class="v">${escapeHtml(String(attempt.gradeAH))}</div></div>
        </div>

        <div class="divider"></div>

        <div class="note">
          <strong>UNDERSTANDING verdict</strong><br/>
          Section A (Otono Team): <strong>${understandsOtono ? "YES" : "NO / WEAK"}</strong> ‚Äî packs referenced: ${uA?.rep?.packHits ?? 0}<br/>
          Section B (Book): <strong>${understandsBook ? "YES" : "NO / WEAK"}</strong> ‚Äî packs referenced (events+characters): ${uB?.rep?.packHits ?? 0}
        </div>

        <div class="divider"></div>

        <button class="btn" id="btnShowBreakdown">Show breakdown</button>
        <div id="bdList" class="hide" style="margin-top:12px"></div>
      </div>
    </div>
  `;

  $("#btnShowBreakdown").addEventListener("click", ()=>{
    const d = $("#bdList");
    d.classList.toggle("hide");
    if(!d.classList.contains("hide")){
      d.innerHTML = res.breakdown.map(b=>{
        const extra = b.understanding
          ? `<div class="small" style="margin-top:6px">Understanding packs hit: ${b.understanding.rep.packHits} ‚Ä¢ anchors: ${b.understanding.rep.totalAnchorHits}</div>`
          : "";
        const packList = b.understanding
          ? (b.understanding.rep.hitPacks || []).map(p=>`<div class="small">‚Ä¢ ${escapeHtml(p.label)} (anchors hit: ${p.anchorsHit})</div>`).join("")
          : "";
        return `
          <div class="attempt">
            <div class="top">
              <div><strong>${escapeHtml(b.part)}</strong></div>
              <div><span class="badge">${b.score} / ${b.max}</span></div>
            </div>
            <div class="meta">${escapeHtml(b.detail)}</div>
            ${extra}
            ${packList ? `<div class="divider"></div>${packList}` : ""}
          </div>
        `;
      }).join("");
    }
  });

  setBadge("Submitted","badge good");
}

/* =========================================================
   RESULTS PANEL
========================================================= */
function drawResults(){
  const listEl = $("#resultsList");
  const all = loadResults();
  const filter = ($("#filterCandidate").value || "").trim();
  const filtered = filter ? all.filter(a => String(a.candidateNo) === String(filter)) : all;

  if(filtered.length === 0){
    listEl.innerHTML = `<div class="note">No stored attempts${filter ? " for this candidate" : ""}.</div>`;
    return;
  }

  listEl.innerHTML = filtered.map(a=>{
    const [cls, txt] = badgeForScore(a.score);
    return `
      <div class="attempt">
        <div class="top">
          <div>
            <strong>${escapeHtml(a.candidateNo)}</strong>${a.candidateName ? " ‚Ä¢ " + escapeHtml(a.candidateName) : ""}
            <span class="badge" style="margin-left:8px">Centre ${escapeHtml(a.centre)}</span>
            <span class="badge" style="margin-left:8px">${escapeHtml(a.level)}</span>
          </div>
          <div class="${cls}">${escapeHtml(txt)} ‚Ä¢ ${escapeHtml(String(a.score))}/${escapeHtml(String(a.maxScore))}</div>
        </div>
        <div class="meta">
          <div><strong>Date:</strong> ${escapeHtml(new Date(a.submittedAt).toLocaleString())}</div>
          <div><strong>PMD:</strong> ${escapeHtml(a.passMeritDistinction)} ‚Ä¢ <strong>9‚Äì1:</strong> ${escapeHtml(String(a.grade9to1))} ‚Ä¢ <strong>A‚ÄìH:</strong> ${escapeHtml(String(a.gradeAH))}</div>
          <div><strong>Chosen:</strong> ${escapeHtml(a.chosen.A)} ‚Ä¢ ${escapeHtml(a.chosen.B)} ‚Ä¢ Translation ${escapeHtml(a.chosen.T)} ‚Ä¢ <strong>Time:</strong> ${escapeHtml(String(a.timeAllowedMin))} min</div>
        </div>
      </div>
    `;
  }).join("");
}
function exportResults(){
  const all = loadResults();
  $("#exportText").textContent = JSON.stringify(all, null, 2);
  $("#exportBox").classList.remove("hide");
}
function clearResults(){
  if(!confirm("Clear ALL stored results on this browser?")) return;
  localStorage.removeItem(STORE_KEY);
  $("#exportBox").classList.add("hide");
  drawResults();
}

/* =========================================================
   NAVIGATION / EVENTS
========================================================= */
$("#btnHome").addEventListener("click", ()=>{
  renderHome();
});
$("#btnResults").addEventListener("click", ()=>{
  $("#sideBody").classList.add("hide");
  $("#resultsBody").classList.remove("hide");
  $("#sideTitle").textContent = "Saved results";
  $("#sideMeta").textContent = "Stored in this browser (localStorage).";
  setBadge("Results","badge");
  stopTimer();
  $("#timerText").textContent="--:--";
  drawResults();
});

$("#tabAll").addEventListener("click", ()=>{
  $("#tabAll").classList.add("active");
  $("#tabCandidate").classList.remove("active");
  $("#filterCandidate").value="";
  drawResults();
});
$("#tabCandidate").addEventListener("click", ()=>{
  $("#tabCandidate").classList.add("active");
  $("#tabAll").classList.remove("active");
  $("#filterCandidate").focus();
});
$("#filterCandidate").addEventListener("input", drawResults);
$("#btnExport").addEventListener("click", exportResults);
$("#btnClear").addEventListener("click", clearResults);

$("#btnPreview").addEventListener("click", ()=>{
  const c = ($("#candidateNo").value || "").trim();
  if(!c){ alert("Enter a candidate number first."); return; }

  const level = $("#level").value;
  const paper = generatePaper(level);

  const box = $("#previewBox");
  box.classList.remove("hide");

  box.innerHTML = `
    <strong>Preview (not started)</strong><br/>
    Level: <strong>${escapeHtml(level)}</strong><br/>
    Section A options: <strong>${escapeHtml(paper.sectionA.map(q=>q.id).join(", "))}</strong><br/>
    Section B options: <strong>${escapeHtml(paper.sectionB.map(q=>q.id).join(", "))}</strong><br/>
    Translation: <strong>${escapeHtml(paper.translation.id)}</strong><br/>
    Word target: essays ‚âà <strong>${paper.wordTargets.essayTarget}</strong> ‚Ä¢ translation ‚â• <strong>${paper.wordTargets.transMin}</strong>
  `;
});

$("#btnStart").addEventListener("click", ()=>{
  const c = ($("#candidateNo").value || "").trim();
  if(!c){ alert("Candidate number is required."); return; }

  state.candidateNo = c;
  state.candidateName = ($("#candidateName").value || "").trim();

  const level = $("#level").value;
  state.paper = generatePaper(level);

  populateTimeOptions();
  renderTest();
});

$("#btnReset").addEventListener("click", ()=>{
  if(!confirm("Reset and generate a NEW random A/AS paper?")) return;
  stopTimer();
  const level = $("#level").value;
  state.paper = generatePaper(level);
  renderTest();
});

$("#btnSubmit").addEventListener("click", ()=>submitPaper(false));

/* =========================================================
   INITIALISE
========================================================= */
populateTimeOptions();
renderHome();

/* =========================================================
   Anti-cheat (English stays English)
========================================================= */
const disabledKeys = ["u", "I"];
const showAlert = e => {
  e.preventDefault();
  return alert("Hahaha, I challenge you, valiant soldier, to uproot the source codes yourself!!!");
};
document.addEventListener("contextmenu", e => { showAlert(e); });
document.addEventListener("keydown", e => {
  if ((e.ctrlKey && disabledKeys.includes(e.key)) || e.key === "F12") showAlert(e);
});
</script>

</body>
</html>
