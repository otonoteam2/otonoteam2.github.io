<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üü£ Otono Spanish ‚Äî Reading (SAM) ‚Ä¢ Sample set 1</title>
  <style>
    :root{
      --bg1:#2b0a3d; --bg2:#7a0036;
      --card:#0f0b18cc; --card2:#120c22e6;
      --text:#f4efff; --muted:#c9b9ff;
      --accent:#b000ff; --accent2:#ff1b6a;
      --good:#19ff9a; --warn:#ffd166; --bad:#ff4d6d;
      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(176,0,255,.22), transparent 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(255,27,106,.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:22px;}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky; top:14px; z-index:20; backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0; font-size:16px; letter-spacing:.3px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); font-family:var(--mono); font-size:12px;
      display:flex; gap:10px; align-items:center;
    }
    .pill strong{color:#fff}
    .btn{
      border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.33); border-color:rgba(255,255,255,.22)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(176,0,255,.55), rgba(255,27,106,.45));
      border-color:rgba(255,255,255,.22);
    }
    .btn.danger{background:rgba(255,77,109,.18); border-color:rgba(255,77,109,.35)}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .topbar{position:static} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .hd .meta{font-size:12px; color:var(--muted); line-height:1.25}
    .card .bd{padding:16px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}

    input[type="text"], input[type="number"], textarea, select{
      width:100%; border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; outline:none;
      font-family:var(--sans);
    }
    textarea{min-height:90px; resize:vertical}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > div{flex:1 1 180px}

    .note{
      font-size:12px; color:var(--muted); line-height:1.4;
      padding:10px 12px; border-radius:14px; border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
    }
    .badge{
      font-family:var(--mono); font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.20);
      display:inline-flex; align-items:center; gap:6px;
    }
    .badge.good{border-color:rgba(25,255,154,.35); background:rgba(25,255,154,.12)}
    .badge.warn{border-color:rgba(255,209,102,.35); background:rgba(255,209,102,.12)}
    .badge.bad{border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.12)}
    .divider{height:1px; background:var(--line); margin:14px 0}
    .passage{
      padding:12px 14px; border:1px solid var(--line); border-radius:16px;
      background:rgba(0,0,0,.22); line-height:1.5;
    }
    .q{
      margin-top:14px; padding:12px 14px; border:1px solid var(--line);
      border-radius:16px; background:rgba(0,0,0,.20);
    }
    .q h3{margin:0 0 8px; font-size:13px}
    .opts{display:grid; gap:8px; margin-top:8px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px; border-radius:14px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      cursor:pointer;
    }
    .opt input{margin-top:3px}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 980px){ .kpi{grid-template-columns:repeat(2,1fr)} }
    .kpi .box{
      border:1px solid var(--line); border-radius:16px; padding:10px 12px;
      background:rgba(0,0,0,.22);
    }
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .kpi .box .v{font-size:18px; font-weight:800; margin-top:4px}
    .small{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:rgba(0,0,0,.22); cursor:pointer; font-weight:700}
    .tab.active{background:linear-gradient(135deg, rgba(176,0,255,.35), rgba(255,27,106,.22)); border-color:rgba(255,255,255,.22)}
    .resultsList{display:grid; gap:10px}
    .attempt{
      border:1px solid var(--line); border-radius:16px; padding:12px 14px;
      background:rgba(0,0,0,.20);
    }
    .attempt .top{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .attempt .top strong{font-family:var(--mono)}
    .attempt .meta{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.4}
    .copy{font-family:var(--mono); font-size:12px; white-space:pre-wrap; word-break:break-word}
    .hide{display:none !important}

    /* Candidate number 4 squares */
    .digitRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .digitRow .digit{
      width:52px; text-align:center; font-family:var(--mono);
      font-size:18px; font-weight:900; padding:12px 0;
      border-radius:14px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); color:var(--text);
      outline:none;
    }
    .digitRow .hint{font-size:12px; color:var(--muted)}
    .miniRow{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    .miniRow > *{flex:1 1 160px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>üü£ Otono Spanish ‚Äî Paper 3 ‚Ä¢ Reading ‚Ä¢ Sample Assessment Material ‚Ä¢ Sample set 1</h1>
        <div class="sub">
          Auto marking ‚Ä¢ 4 random passages √ó 20 + 1 translation √ó 20 = 100 ‚Ä¢ Centre:
          <strong id="centreTop">50749</strong>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
        <div class="pill">
          <span>‚è±Ô∏è Timer:</span>
          <strong id="timerText">--:--</strong>
        </div>
        <button class="btn" id="btnResults">Results</button>
        <button class="btn primary" id="btnHome">Test</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: main -->
      <div class="card" id="panelHome">
        <div class="hd">
          <div>
            <h2>Candidate setup</h2>
            <div class="meta">No dictionary ‚Ä¢ No translator ‚Ä¢ Answer from the text ‚Ä¢ Auto marking for written answers uses keywords (not perfect).</div>
          </div>
          <span class="badge" id="statusBadge">Ready</span>
        </div>

        <div class="bd" id="homeBody">
          <div class="miniRow">
            <div>
              <label>Centre number</label>
              <input type="text" id="centreNo" value="50749" disabled />
              <div class="small" style="margin-top:6px">
                Default is <strong>50749</strong>. You can change it (optional) with the button.
              </div>
            </div>
            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
              <button class="btn" id="btnEditCentre">Customise centre</button>
              <button class="btn" id="btnResetCentre">Reset centre</button>
            </div>
          </div>

          <div class="divider"></div>

          <div>
            <label>Candidate number (required, 4 digits)</label>
            <div class="digitRow" aria-label="Candidate number 4 digits">
              <input class="digit" id="candD1" inputmode="numeric" maxlength="1" />
              <input class="digit" id="candD2" inputmode="numeric" maxlength="1" />
              <input class="digit" id="candD3" inputmode="numeric" maxlength="1" />
              <input class="digit" id="candD4" inputmode="numeric" maxlength="1" />
              <span class="hint">Digits only ‚Ä¢ auto-advance</span>
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <div>
              <label>Candidate surname (optional)</label>
              <input type="text" id="candSurname" placeholder="Surname" />
            </div>
            <div>
              <label>Candidate forename(s) (optional)</label>
              <input type="text" id="candForenames" placeholder="Forename(s)" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>How the random paper works (SAM set 1):</strong><br/>
            ‚Ä¢ The system selects <strong>4 random passages</strong> (each worth <strong>20</strong>) and <strong>1 random translation</strong> (worth <strong>20</strong>).<br/>
            ‚Ä¢ You‚Äôll get a mix of <strong>MCQ</strong>, <strong>P/N/P+N</strong>, <strong>True/False/Not mentioned</strong>, and <strong>written answers</strong>.<br/>
            ‚Ä¢ Some passages include <strong>questions answered in Spanish</strong> (you must answer in Spanish).<br/>
            ‚Ä¢ Written + translation answers are marked by <strong>keyword coverage</strong> (so write clear, direct answers).<br/>
            ‚Ä¢ Your attempt is saved to this browser using <strong>localStorage</strong>.
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label>Time allowed</label>
              <select id="timeAllowed">
                <option value="75" selected>75 minutes (recommended)</option>
                <option value="60">60 minutes</option>
                <option value="45">45 minutes</option>
              </select>
            </div>
            <div>
              <label>Question order</label>
              <select id="shuffleMode">
                <option value="shuffleAll" selected>Shuffle questions (harder)</option>
                <option value="keepOrder">Keep original order</option>
              </select>
            </div>
            <div>
              <label>On timer end</label>
              <select id="autoSubmit">
                <option value="yes" selected>Auto-submit</option>
                <option value="no">Do not auto-submit</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap">
            <button class="btn primary" id="btnStart">Start Random Paper</button>
            <button class="btn" id="btnPreview">Preview Random Selection</button>
          </div>

          <div id="previewBox" class="note hide" style="margin-top:12px"></div>
        </div>

        <!-- Test body -->
        <div class="bd hide" id="testBody">
          <div class="kpi">
            <div class="box"><div class="t">Candidate</div><div class="v" id="kpiCandidate">‚Äî</div></div>
            <div class="box"><div class="t">Selected passages</div><div class="v" id="kpiPassages">‚Äî</div></div>
            <div class="box"><div class="t">Translation</div><div class="v" id="kpiTranslation">‚Äî</div></div>
            <div class="box"><div class="t">Max score</div><div class="v">100</div></div>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>Instructions reminder:</strong>
            No dictionary. Do not copy from outside. Base answers on the passage. For written answers, include the key idea(s) clearly.
          </div>

          <div id="paper"></div>

          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btnSubmit">Submit & Auto-Mark</button>
            <button class="btn" id="btnReset">Reset (new random paper)</button>
          </div>

          <div id="markingBox" class="hide" style="margin-top:14px"></div>
        </div>
      </div>

      <!-- Right: results / help -->
      <div class="card" id="panelSide">
        <div class="hd">
          <div>
            <h2 id="sideTitle">Otono grading</h2>
            <div class="meta" id="sideMeta">Score ‚Üí Otono grade + GCSE estimate + Pass/Merit/Distinction.</div>
          </div>
        </div>

        <div class="bd" id="sideBody">
          <div class="note">
            <strong>Pass/Merit/Distinction</strong><br/>
            PASS: 66+<br/>
            MERIT: 80+<br/>
            DISTINCTION: 90+<br/>
          </div>
          <div class="divider"></div>
          <div class="note">
            <strong>Otono grades (A‚ÄìH + secret S)</strong><br/>
            S: 101+ (secret)<br/>
            A*: 95‚Äì100<br/>
            A: 90‚Äì94<br/>
            B: 80‚Äì89<br/>
            C: 70‚Äì79<br/>
            D: 66‚Äì69<br/>
            E: 55‚Äì65<br/>
            F: 45‚Äì54<br/>
            G: 30‚Äì44<br/>
            H: 15‚Äì29<br/>
            U: 0‚Äì14
          </div>
          <div class="divider"></div>
          <div class="note">
            <strong>GCSE 9‚Äì1 estimate (simple mapping)</strong><br/>
            9: 90‚Äì100 ‚Ä¢ 8: 80‚Äì89 ‚Ä¢ 7: 70‚Äì79 ‚Ä¢ 6: 60‚Äì69 ‚Ä¢ 5: 50‚Äì59<br/>
            4: 40‚Äì49 ‚Ä¢ 3: 30‚Äì39 ‚Ä¢ 2: 20‚Äì29 ‚Ä¢ 1: 10‚Äì19 ‚Ä¢ U: 0‚Äì9
          </div>
          <div class="divider"></div>
          <div class="small">
            Tip: results are stored locally on this device/browser only. If you clear site data, they disappear.
          </div>
        </div>

        <!-- Results panel -->
        <div class="bd hide" id="resultsBody">
          <div class="tabs">
            <div class="tab active" id="tabAll">All attempts</div>
            <div class="tab" id="tabCandidate">By candidate</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Filter candidate number (4 digits)</label>
              <input type="text" id="filterCandidate" placeholder="e.g. 1105" inputmode="numeric" />
            </div>
            <div>
              <label>Actions</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" id="btnExport">Export JSON</button>
                <button class="btn danger" id="btnClear">Clear stored results</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="resultsList" id="resultsList"></div>

          <div id="exportBox" class="note hide" style="margin-top:12px">
            <div><strong>Exported JSON</strong> (copy/save it):</div>
            <div class="divider"></div>
            <div class="copy" id="exportText"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   OTONO BANK (STRAIGHTFORWARD TEXT, SIMILAR LENGTH)
   Each passage total = 20 marks
--------------------------------*/

const PASSAGES = [
  {
    id: 1,
    title: "Pasaje 1 ‚Äî Monsieur Barley y el m√©todo",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 1 (Monsieur Barley)",
    text: `Monsieur Barley es profesor de ciencias en la escuela Otono. Habla con calma y le gusta que todo sea claro. En su aula hay reglas sencillas: los cuadernos est√°n guardados, las mesas est√°n limpias y el material est√° listo antes de la clase. Los alumnos dicen que es estricto, pero Monsieur Barley responde: ¬´Quiero sobre todo que sea preciso¬ª.

Antes de cada prueba, repite la misma idea: hay que leer la consigna y responder exactamente a la pregunta. Explica que un alumno puede conocer el tema, pero perder puntos si la respuesta no es completa. Por ejemplo, si la pregunta pide una justificaci√≥n, escribir una sola palabra no basta. Si la pregunta pide dos razones, dar una sola raz√≥n no es suficiente.

Red escucha e intenta cambiar su forma de trabajar. Vuelve a leer la pregunta, subraya las palabras importantes y comprueba cu√°ntos detalles se piden. Piensa que este peque√±o esfuerzo puede evitar errores simples.`,
    questions: [
      { id:"p1q1", type:"mcq", marks:2,
        prompt:"(E) What subject does Monsieur Barley teach?",
        options:["Science","Music","PE","English"],
        answerIndex:0
      },
      { id:"p1q2", type:"pn", marks:2,
        prompt:"(E) ‚ÄòMonsieur Barley likes clear rules.‚Äô (P / N / P+N)",
        answerLabel:"P",
        correct:"P"
      },
      { id:"p1q3", type:"short", marks:4,
        prompt:"(E) Give TWO signs that the classroom is organised.",
        rubric:"Any two: notebooks are put away; tables are clean; equipment is ready; simple rules; everything is clear.",
        keywords:[
          ["notebooks","cuadernos","guardados","guardar"],
          ["tables","mesas","clean","limpias","limpia"],
          ["equipment","material","ready","listo","lista"],
          ["rules","reglas","simple","sencillas"]
        ]
      },
      { id:"p1q4", type:"tfnm", marks:2,
        prompt:"(E) The text says Red never rereads questions. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p1q5", type:"short", marks:6,
        prompt:"(H) Give ONE example from the passage of how someone could lose marks, and say what they should do instead.",
        rubric:"Example: justification needed ‚Üí give an explanation; two reasons needed ‚Üí give two reasons.",
        keywords:[
          ["justify","justification","explain","explicar","porque","porque","ya que"],
          ["two reasons","dos razones","two","dos","reasons","razones"],
          ["instead","en lugar","should","debe","hay que"]
        ]
      },
      { id:"p1q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© Red subraya palabras importantes?",
        rubric:"Para responder exactamente a la consigna / evitar errores / estar m√°s seguro.",
        keywords:[
          ["responder","exactamente","consigna","pregunta"],
          ["evitar","errores","simples"],
          ["mas seguro","m√°s seguro","seguro","segura"]
        ]
      }
    ]
  },

  {
    id: 2,
    title: "Pasaje 2 ‚Äî La tinta y las consignas",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 2 (Sistema de tinta)",
    text: `Antes de los ex√°menes en Otono, se habla a menudo de los bol√≠grafos. Algunos alumnos escriben sin hacerse preguntas. Otros se estresan, porque tienen miedo de usar el bol√≠grafo equivocado y perder puntos.

A Luke le gusta la tinta negra. Dice que es limpia y f√°cil de leer. En matem√°ticas, a menudo se pide escribir en negro, porque los ex√°menes se escanean. Pero en ciencias, los alumnos a veces oyen consignas diferentes: se puede pedir evitar ciertas tintas o seguir una regla particular para un documento.

Esta situaci√≥n puede crear confusi√≥n. La v√≠spera de un examen, algunos alumnos preparan dos bol√≠grafos. Otros preguntan al profesor. Red elige una estrategia simple: se mantiene tranquilo y lee la consigna escrita en la hoja del examen, porque esa es la regla oficial.`,
    questions: [
      { id:"p2q1", type:"mcq", marks:2,
        prompt:"(E) Why do some students stress before exams?",
        options:["They want more homework","They fear using the wrong pen","They dislike reading","They forget lunch"],
        answerIndex:1
      },
      { id:"p2q2", type:"tfnm", marks:2,
        prompt:"(E) Maths copies are scanned. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p2q3", type:"short", marks:4,
        prompt:"(E) Give TWO reasons Luke likes black ink.",
        rubric:"Any two: neat/clean; easy to read; serious; clear.",
        keywords:[
          ["clean","limpia","limpio","ordenada","pulcra"],
          ["easy to read","f√°cil","leer","legible"],
          ["clear","clara","claro"],
          ["serious","serio","seria","seria"]
        ]
      },
      { id:"p2q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòThe rules are always the same in every subject.‚Äô (P / N / P+N)",
        correct:"N"
      },
      { id:"p2q5", type:"short", marks:6,
        prompt:"(H) What is Red‚Äôs strategy, and why is it sensible?",
        rubric:"He stays calm and checks the written instructions; sensible because written instructions are official.",
        keywords:[
          ["calm","tranquilo","tranquila","calma"],
          ["check","comprobar","verificar","read","leer"],
          ["written","escrita","escrito","hoja","papel"],
          ["official","oficial","rule","regla","consigna"]
        ]
      },
      { id:"p2q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: Da una soluci√≥n para evitar la confusi√≥n sobre los bol√≠grafos.",
        rubric:"Ej: preparar dos bol√≠grafos / preguntar al profesor / leer la consigna.",
        keywords:[
          ["dos bol√≠grafos","dos","bol√≠grafos"],
          ["preguntar","profesor"],
          ["leer","consigna","hoja"]
        ]
      }
    ]
  },

  {
    id: 3,
    title: "Pasaje 3 ‚Äî Elegir las opciones GCSE",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 3 (Opciones GCSE)",
    text: `Elegir las opciones del GCSE es importante para muchos alumnos. Algunos eligen r√°pido, porque ya saben lo que quieren hacer. Otros dudan, porque les gustan varias asignaturas o tienen miedo de equivocarse.

En Otono, tambi√©n hay limitaciones: puede haber un n√∫mero limitado de plazas en una clase, y algunas asignaturas pueden coincidir en el horario. Thomas duda sobre el franc√©s. Le gusta la asignatura, pero se pregunta si ser√° lo bastante bueno. Habla con otros alumnos y comprende que tienen las mismas preocupaciones.

Al final, Thomas elige franc√©s. La escuela acepta su elecci√≥n, aunque sea un poco tarde. Para √©l, es tranquilizador: si uno explica bien su situaci√≥n, el sistema puede ser flexible.`,
    questions: [
      { id:"p3q1", type:"mcq", marks:2,
        prompt:"(E) Choosing GCSE options is described as‚Ä¶",
        options:["Important","Impossible","A joke","Only for Year 7"],
        answerIndex:0
      },
      { id:"p3q2", type:"tfnm", marks:2,
        prompt:"(E) Thomas hates Spanish. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p3q3", type:"short", marks:4,
        prompt:"(E) Give TWO reasons why some students hesitate.",
        rubric:"Any two: like several subjects; fear wrong choice; worry about being good enough; timetable clashes; limited places.",
        keywords:[
          ["varias","varios","asignaturas","materias"],
          ["fear","miedo","equivocarse","elecci√≥n"],
          ["good enough","lo bastante bueno","suficiente"],
          ["timetable","horario","coincidir","mismo tiempo"],
          ["limited","limitado","plazas","plaza"]
        ]
      },
      { id:"p3q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòThe school can be flexible in some cases.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p3q5", type:"short", marks:6,
        prompt:"(H) What should a student do if they need a late change, according to the text?",
        rubric:"Explain the situation clearly; communicate; ask.",
        keywords:[
          ["explain","explicar","situaci√≥n"],
          ["clearly","claramente","bien","claro"],
          ["ask","pedir","solicitar","acepta","aceptar"]
        ]
      },
      { id:"p3q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øQu√© ayuda a Thomas a decidir?",
        rubric:"Habla con otros alumnos y ve que tienen las mismas preocupaciones.",
        keywords:[
          ["habla","hablar"],
          ["otros","alumnos","estudiantes"],
          ["mismas","preocupaciones"]
        ]
      }
    ]
  },

  {
    id: 4,
    title: "Pasaje 4 ‚Äî En la sala de examen",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 4 (Reglas de examen)",
    text: `El d√≠a del examen, el ambiente cambia en el pasillo. Los alumnos hablan menos. Algunos vuelven a leer sus apuntes por √∫ltima vez. Otros esperan en silencio. Cuando se abre la puerta, todos entran con calma.

En la sala, las mesas est√°n separadas y las mochilas se colocan al frente. El vigilante espera a que todos est√©n sentados y luego lee las consignas: escribir con claridad, nada de m√≥vil y respetar la lista de objetos prohibidos.

Cuando habla de esa lista, algunos alumnos entran en p√°nico. Se preguntan si han olvidado algo en un bolsillo. Red, en cambio, se mantiene concentrado. Se repite que un peque√±o error puede costar puntos, pero que lo m√°s importante es seguir las consignas hasta el final.`,
    questions: [
      { id:"p4q1", type:"mcq", marks:2,
        prompt:"(E) How do students enter the exam room?",
        options:["Calmly","Running","Singing","Shouting"],
        answerIndex:0
      },
      { id:"p4q2", type:"short", marks:4,
        prompt:"(E) Give TWO details that show the room is prepared for an exam.",
        rubric:"Any two: spaced tables; bags placed at the front; invigilator reads instructions; list of forbidden items.",
        keywords:[
          ["tables","mesas","separadas"],
          ["bags","mochilas","al frente","frente"],
          ["invigilator","vigilante","reads","lee","consignas"],
          ["forbidden","prohibidos","lista"]
        ]
      },
      { id:"p4q3", type:"tfnm", marks:2,
        prompt:"(E) Students are allowed to use phones. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p4q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòSome students panic because they think they forgot something.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p4q5", type:"short", marks:6,
        prompt:"(H) What is Red‚Äôs mindset at the end, and how can it help?",
        rubric:"Stay focused and follow instructions; helps avoid small mistakes and keeps calm.",
        keywords:[
          ["focused","concentrado","concentrada","concentrarse"],
          ["follow","seguir","respetar"],
          ["instructions","consignas","instrucciones"],
          ["avoid","evitar","mistakes","errores"],
          ["calm","calma","tranquilo"]
        ]
      },
      { id:"p4q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© la lista de objetos prohibidos hace que algunos alumnos entren en p√°nico?",
        rubric:"Porque tienen miedo de haber olvidado algo en un bolsillo.",
        keywords:[
          ["p√°nico","entrar en p√°nico"],
          ["miedo","preocupados"],
          ["olvidado","olvidar"],
          ["bolsillo","bolsillos"]
        ]
      }
    ]
  },

  {
    id: 5,
    title: "Pasaje 5 ‚Äî El servidor de Minecraft Otono",
    theme: "Tema 2 ‚Äî Tiempo libre",
    unit: "Unidad 5 (Servidor de Minecraft)",
    text: `En el servidor de Minecraft Otono, los jugadores tienen que trabajar juntos. Antes de una gran construcci√≥n, hablan del plan y deciden las etapas. Cada uno tiene un papel y hay que ponerse de acuerdo.

A Red le gusta ir r√°pido: prefiere empezar enseguida y ver resultados pronto. OWing es diferente: se toma su tiempo, comprueba los detalles y corrige los peque√±os errores. A veces no est√°n de acuerdo, pero cuando cooperan, el proyecto avanza mejor. Red aporta la velocidad y OWing aporta la precisi√≥n. Juntos, el servidor progresa.`,
    questions: [
      { id:"p5q1", type:"mcq", marks:2,
        prompt:"(E) On the server, players must‚Ä¶",
        options:["Work together","Play alone","Ignore the plan","Stop building"],
        answerIndex:0
      },
      { id:"p5q2", type:"tfnm", marks:2,
        prompt:"(E) The players never discuss plans. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p5q3", type:"short", marks:4,
        prompt:"(E) Give TWO things players do before a big build.",
        rubric:"Discuss the plan; decide steps; agree roles.",
        keywords:[
          ["discuss","hablan","plan"],
          ["steps","etapas","decide","deciden"],
          ["role","papel","roles","funci√≥n"]
        ]
      },
      { id:"p5q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòOWing checks details.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p5q5", type:"short", marks:6,
        prompt:"(H) Why does teamwork help their project succeed?",
        rubric:"Their strengths combine: speed + precision; fewer mistakes; better progress.",
        keywords:[
          ["speed","r√°pido","velocidad"],
          ["precision","precisi√≥n","details","detalles"],
          ["together","juntos","cooperate","cooperan","cooperar"],
          ["mistakes","errores","corrige","corregir"],
          ["progress","avanza","progresa"]
        ]
      },
      { id:"p5q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: Da una diferencia entre Red y OWing.",
        rubric:"Red va r√°pido / OWing comprueba los detalles.",
        keywords:[
          ["red","r√°pido","velocidad"],
          ["owing","comprueba","verifica","detalles"]
        ]
      }
    ]
  },

  {
    id: 6,
    title: "Pasaje 6 ‚Äî Viajar con Otono Airways",
    theme: "Tema 3 ‚Äî Otono Team",
    unit: "Unidad 8 (Otono Airways)",
    text: `Viajar con Otono Airways suele ser c√≥modo. Los pasajeros notan la organizaci√≥n en la cabina y la disposici√≥n de los asientos. Incluso en clase turista, hay suficiente espacio para sentarse c√≥modamente.

Red observa todo con atenci√≥n. Mira la cabina, los asientos y los detalles t√©cnicos. Para √©l, cada vuelo es una oportunidad de aprender: compara las decisiones de la compa√±√≠a y anota lo que funciona bien.`,
    questions: [
      { id:"p6q1", type:"mcq", marks:2,
        prompt:"(E) Passengers notice‚Ä¶",
        options:["Organisation and comfort","Only pilots","Only luggage","Only exams"],
        answerIndex:0
      },
      { id:"p6q2", type:"pn", marks:2,
        prompt:"(E) ‚ÄòEconomy class has enough space in this passage.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p6q3", type:"tfnm", marks:2,
        prompt:"(E) The passage says Red sleeps on every flight. (True / False / Not mentioned)",
        correct:"Not mentioned"
      },
      { id:"p6q4", type:"short", marks:4,
        prompt:"(E) Give TWO things Red observes.",
        rubric:"Cabin; seats; layout; technical details; organisation.",
        keywords:[
          ["cabine","cabina"],
          ["sieges","asientos"],
          ["details","detalles","technical","t√©cnicos"],
          ["organisation","organizaci√≥n"]
        ]
      },
      { id:"p6q5", type:"short", marks:6,
        prompt:"(H) Why does Red like analysing flights in this text?",
        rubric:"He likes learning, comparing, and noting what works well; he focuses on details.",
        keywords:[
          ["learn","aprender"],
          ["compare","comparar"],
          ["note","anotar","anota"],
          ["details","detalles"],
          ["works well","funciona","bien"]
        ]
      },
      { id:"p6q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© cada vuelo es una oportunidad de aprender para Red?",
        rubric:"Porque compara y observa los detalles.",
        keywords:[
          ["comparar","compara"],
          ["observa","observar"],
          ["detalles"],
          ["aprender"]
        ]
      }
    ]
  },

  {
    id: 7,
    title: "Pasaje 7 ‚Äî La gesti√≥n del tiempo",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 4 (T√©cnicas de estudio)",
    text: `Para tener √©xito en la escuela, la gesti√≥n del tiempo es esencial. Algunos alumnos empiezan los deberes muy tarde y se sienten estresados. Otros prefieren trabajar un poco cada d√≠a para evitar la presi√≥n.

Red intenta organizar su trabajo con antelaci√≥n. Usa un horario sencillo donde anota sus deberes y sus repasos. No siempre trabaja mucho tiempo, pero trabaja con regularidad. Seg√∫n √©l, este m√©todo permite mantenerse concentrado y evitar el cansancio antes de los ex√°menes.`,
    questions: [
      { id:"p7q1", type:"mcq", marks:2,
        prompt:"(E) Time management is described as‚Ä¶",
        options:["Useless","Essential","Confusing","Optional"],
        answerIndex:1
      },
      { id:"p7q2", type:"tfnm", marks:2,
        prompt:"(E) Some students feel stressed because they start homework late. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p7q3", type:"short", marks:4,
        prompt:"(E) Give TWO advantages of working a little every day.",
        rubric:"Avoid pressure; stay focused; reduce stress; avoid fatigue.",
        keywords:[
          ["avoid","evitar","pressure","presi√≥n"],
          ["focused","concentrado","concentrarse"],
          ["stress","estr√©s"],
          ["fatigue","cansancio"]
        ]
      },
      { id:"p7q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòRed works for very long hours every day.‚Äô (P / N / P+N)",
        correct:"N"
      },
      { id:"p7q5", type:"short", marks:6,
        prompt:"(H) Explain why Red‚Äôs method is effective.",
        rubric:"Planning; regular work; better focus; less stress.",
        keywords:[
          ["planning","plan","horario"],
          ["regular","regularidad","con regularidad"],
          ["focus","concentraci√≥n"],
          ["stress","estr√©s","cansancio"]
        ]
      },
      { id:"p7q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© Red usa un horario?",
        rubric:"Para organizar su trabajo / anotar los deberes / repasar mejor.",
        keywords:[
          ["organizar"],
          ["anotar","deberes"],
          ["repasar","repaso"]
        ]
      }
    ]
  },

  {
    id: 8,
    title: "Pasaje 8 ‚Äî El estr√©s antes de una prueba",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 4 (Ex√°menes)",
    text: `Antes de una prueba importante, muchos alumnos sienten estr√©s. Algunos tienen miedo de olvidar lo que saben, aunque hayan repasado bien. Otros se preocupan por el tiempo o por el silencio en el aula.

Red piensa que el estr√©s es normal, pero que hay que aprender a gestionarlo. Respira con calma, lee las preguntas despacio y empieza por los ejercicios m√°s f√°ciles. Para √©l, mantenerse tranquilo ayuda a pensar mejor.`,
    questions: [
      { id:"p8q1", type:"mcq", marks:2,
        prompt:"(E) Many students feel stress before a test because they‚Ä¶",
        options:["Hate school","Forget knowledge","Like exams","Finish early"],
        answerIndex:1
      },
      { id:"p8q2", type:"pn", marks:2,
        prompt:"(E) ‚ÄòStress before an exam is completely abnormal.‚Äô (P / N / P+N)",
        correct:"N"
      },
      { id:"p8q3", type:"short", marks:4,
        prompt:"(E) Give TWO causes of stress mentioned.",
        rubric:"Fear of forgetting; time pressure; silence.",
        keywords:[
          ["forget","olvidar","olvidar lo que sabe"],
          ["time","tiempo","presi√≥n del tiempo"],
          ["silence","silencio"]
        ]
      },
      { id:"p8q4", type:"tfnm", marks:2,
        prompt:"(E) Red listens to music during exams. (True / False / Not mentioned)",
        correct:"Not mentioned"
      },
      { id:"p8q5", type:"short", marks:6,
        prompt:"(H) How does Red manage stress, and why does it help?",
        rubric:"Breathing; reading slowly; starting with easy questions; helps thinking.",
        keywords:[
          ["breathe","respira","respirar"],
          ["read","leer","despacio","lentamente"],
          ["easy","f√°ciles","m√°s f√°ciles"],
          ["think","pensar","reflexionar"]
        ]
      },
      { id:"p8q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© es importante mantenerse tranquilo?",
        rubric:"Porque ayuda a pensar mejor y a responder correctamente.",
        keywords:[
          ["ayuda","permite"],
          ["pensar","reflexionar"],
          ["correctamente","bien"]
        ]
      }
    ]
  },

  {
    id: 9,
    title: "Pasaje 9 ‚Äî El trabajo en grupo",
    theme: "Tema 2 ‚Äî Tiempo libre",
    unit: "Unidad 5 (Trabajo en equipo)",
    text: `En algunas clases, los alumnos tienen que trabajar en grupo. Este m√©todo puede ser eficaz, pero tambi√©n tiene dificultades. A veces, una persona trabaja mucho mientras otra participa poco.

Red prefiere grupos organizados. Piensa que cada alumno debe tener un papel claro. Cuando todos participan, el trabajo avanza m√°s r√°pido y las ideas son m√°s variadas.`,
    questions: [
      { id:"p9q1", type:"mcq", marks:2,
        prompt:"(E) Group work can be‚Ä¶",
        options:["Only negative","Effective","Useless","Forbidden"],
        answerIndex:1
      },
      { id:"p9q2", type:"tfnm", marks:2,
        prompt:"(E) Everyone always works equally in groups. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p9q3", type:"short", marks:4,
        prompt:"(E) Give TWO problems of group work mentioned.",
        rubric:"Unequal work; lack of participation.",
        keywords:[
          ["one person","una persona","trabaja mucho"],
          ["poco","little","participate","participa poco"]
        ]
      },
      { id:"p9q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòClear roles improve group work.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p9q5", type:"short", marks:6,
        prompt:"(H) Why does Red prefer organised groups?",
        rubric:"Clear roles; faster progress; more ideas.",
        keywords:[
          ["roles","papel","claro"],
          ["faster","m√°s r√°pido","m√°s deprisa"],
          ["ideas","ideas","variadas"]
        ]
      },
      { id:"p9q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øCu√°l es la ventaja principal del trabajo en grupo?",
        rubric:"El trabajo avanza m√°s r√°pido / hay m√°s ideas.",
        keywords:[
          ["avanza","m√°s r√°pido","r√°pido"],
          ["ideas","m√°s ideas"]
        ]
      }
    ]
  },

  {
    id: 10,
    title: "Pasaje 10 ‚Äî El entorno de trabajo",
    theme: "Tema 2 ‚Äî Tu regi√≥n",
    unit: "Unidad 7 (Entorno)",
    text: `El entorno de trabajo influye mucho en la concentraci√≥n. Algunos alumnos prefieren el silencio total, mientras que otros prefieren un poco de ruido de fondo. Una habitaci√≥n ordenada tambi√©n puede ayudar a concentrarse mejor.

OWing piensa que un espacio claro y tranquilo da ganas de trabajar. Ordena su escritorio antes de empezar y evita las distracciones. Seg√∫n √©l, un buen entorno mejora la calidad del trabajo.`,
    questions: [
      { id:"p10q1", type:"mcq", marks:2,
        prompt:"(E) A tidy space can help students‚Ä¶",
        options:["Sleep","Concentrate","Talk","Eat"],
        answerIndex:1
      },
      { id:"p10q2", type:"pn", marks:2,
        prompt:"(E) ‚ÄòAll students need complete silence.‚Äô (P / N / P+N)",
        correct:"N"
      },
      { id:"p10q3", type:"short", marks:4,
        prompt:"(E) Give TWO things that can improve concentration.",
        rubric:"Silence; light background noise; tidy room; fewer distractions.",
        keywords:[
          ["silence","silencio"],
          ["noise","ruido","de fondo"],
          ["tidy","ordenada","ordenado","ordenar"],
          ["distractions","distracciones"]
        ]
      },
      { id:"p10q4", type:"tfnm", marks:2,
        prompt:"(E) OWing studies only at night. (True / False / Not mentioned)",
        correct:"Not mentioned"
      },
      { id:"p10q5", type:"short", marks:6,
        prompt:"(H) Why does OWing believe environment affects work quality?",
        rubric:"Calm; organisation; fewer distractions; better focus.",
        keywords:[
          ["calm","tranquilo","tranquilidad"],
          ["organise","organizado","organizaci√≥n","orden"],
          ["focus","concentraci√≥n"],
          ["quality","calidad"]
        ]
      },
      { id:"p10q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© OWing ordena su escritorio?",
        rubric:"Para concentrarse mejor / evitar distracciones.",
        keywords:[
          ["concentrar","concentrarse","mejor"],
          ["evitar","distracciones"]
        ]
      }
    ]
  },

  {
    id: 11,
    title: "Pasaje 11 ‚Äî Clayton y el GCSE adelantado",
    theme: "Tema extra 4 ‚Äî Resultados",
    unit: "Unidad 10 (Clayton GCSE)",
    text: `Clayton hizo su examen de matem√°ticas mucho antes que la mayor√≠a de los alumnos. Sac√≥ 160 de 160, lo cual es una nota perfecta. Muchas personas admiran su √©xito y reconocen su trabajo serio.

Sin embargo, algunas personas piensan que habla demasiado de su resultado. Creen que el √©xito es importante, pero que la humildad tambi√©n lo es. Para Clayton, esa nota representa a√±os de esfuerzo y concentraci√≥n. Dice que la disciplina y la pr√°ctica regular son las claves de su √©xito.`,
    questions: [
      { id:"p11q1", type:"mcq", marks:2,
        prompt:"(E) Clayton‚Äôs score was‚Ä¶",
        options:["150/160","160/160","100/100","140/160"],
        answerIndex:1
      },
      { id:"p11q2", type:"tfnm", marks:2,
        prompt:"(E) Clayton failed his early exam. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p11q3", type:"short", marks:4,
        prompt:"(E) Give TWO reactions people have to his result.",
        rubric:"Admiration; think he talks too much; respect his work.",
        keywords:[
          ["admire","admiration","admiran"],
          ["habla demasiado","too often","too much"],
          ["respect","reconocen","reconocer","respeto"]
        ]
      },
      { id:"p11q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòSome people think humility is important.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p11q5", type:"short", marks:6,
        prompt:"(H) According to Clayton, what leads to success?",
        rubric:"Discipline; regular practice; effort; concentration.",
        keywords:[
          ["discipline","disciplina"],
          ["pratique","pr√°ctica","practice"],
          ["regulier","regular","regularidad"],
          ["efforts","esfuerzo","esfuerzos"],
          ["concentration","concentraci√≥n"]
        ]
      },
      { id:"p11q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© algunas personas critican a Clayton?",
        rubric:"Porque habla demasiado de su nota / le falta humildad.",
        keywords:[
          ["habla demasiado"],
          ["nota","resultado","puntuaci√≥n"],
          ["humildad","falta de humildad"]
        ]
      }
    ]
  },

  {
    id: 12,
    title: "Pasaje 12 ‚Äî Las notas perfectas",
    theme: "Tema extra 4 ‚Äî Resultados",
    unit: "Unidad 10 (Reacciones)",
    text: `Cuando un alumno saca una nota perfecta, las reacciones var√≠an. Algunos se sienten motivados y quieren trabajar m√°s duro. Otros se sienten desanimados y piensan que nunca podr√°n alcanzar ese nivel.

Red piensa que un excelente resultado debe inspirar a los dem√°s. Seg√∫n √©l, la competici√≥n puede ser sana si empuja a cada uno a mejorar sin crear celos innecesarios.`,
    questions: [
      { id:"p12q1", type:"mcq", marks:2,
        prompt:"(E) Reactions to perfect scores are‚Ä¶",
        options:["Identical","Varied","Always negative","Always positive"],
        answerIndex:1
      },
      { id:"p12q2", type:"short", marks:4,
        prompt:"(E) Give TWO different reactions mentioned.",
        rubric:"Motivated; discouraged; work harder; feel they cannot reach level.",
        keywords:[
          ["motiver","motivados","motivaci√≥n","motivado"],
          ["desanimados","desanimado","discouraged"],
          ["work harder","trabajar m√°s","m√°s duro"],
          ["never reach","nunca alcanzar","no podr√°n alcanzar"]
        ]
      },
      { id:"p12q3", type:"pn", marks:2,
        prompt:"(E) ‚ÄòRed believes competition can be healthy.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p12q4", type:"tfnm", marks:2,
        prompt:"(E) The text says competition should create jealousy. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p12q5", type:"short", marks:6,
        prompt:"(H) What is Red‚Äôs message about success?",
        rubric:"Inspire others; healthy competition; avoid jealousy.",
        keywords:[
          ["inspire","inspirar"],
          ["competition","competici√≥n","competencia"],
          ["sain","sana","healthy","saludable"],
          ["jalousie","celos"]
        ]
      },
      { id:"p12q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© la competici√≥n puede ser positiva?",
        rubric:"Porque empuja a mejorar.",
        keywords:[
          ["mejorar","progresar","avanzar"]
        ]
      }
    ]
  },

  {
    id: 13,
    title: "Pasaje 13 ‚Äî La presi√≥n de los ex√°menes",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 4 (Presi√≥n de ex√°menes)",
    text: `La √©poca de ex√°menes puede ser intensa. Los alumnos tienen que repasar varias asignaturas al mismo tiempo. Algunos organizan un horario detallado, mientras que otros trabajan de manera m√°s espont√°nea.

OWing prefiere planificar cada d√≠a. Piensa que eso reduce la presi√≥n y evita sorpresas. Para √©l, la preparaci√≥n es la mejor forma de mantenerse seguro.`,
    questions: [
      { id:"p13q1", type:"mcq", marks:2,
        prompt:"(E) Exams are described as‚Ä¶",
        options:["Relaxing","Intense","Boring","Easy"],
        answerIndex:1
      },
      { id:"p13q2", type:"tfnm", marks:2,
        prompt:"(E) All students use detailed planning. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p13q3", type:"short", marks:4,
        prompt:"(E) Give TWO study approaches mentioned.",
        rubric:"Detailed planning; spontaneous work.",
        keywords:[
          ["planning","plan","horario","detallado"],
          ["spontane","espont√°nea","espont√°neo","spontaneous"]
        ]
      },
      { id:"p13q4", type:"pn", marks:2,
        prompt:"(E) ‚ÄòPreparation increases confidence.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p13q5", type:"short", marks:6,
        prompt:"(H) Why does OWing prefer planning?",
        rubric:"Reduces pressure; avoids surprises; builds confidence.",
        keywords:[
          ["reduce","reduce","presi√≥n","menos presi√≥n"],
          ["avoid","evitar","sorpresas"],
          ["confidence","confianza","seguro","segura"]
        ]
      },
      { id:"p13q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øC√≥mo organiza OWing sus repasos?",
        rubric:"Con un horario detallado.",
        keywords:[
          ["horario","detallado","planificar"]
        ]
      }
    ]
  },

  {
    id: 14,
    title: "Pasaje 14 ‚Äî La concentraci√≥n en clase",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 4 (Concentraci√≥n)",
    text: `En clase, la concentraci√≥n es esencial para entender las explicaciones del profesor. Algunos alumnos se distraen f√°cilmente por ruidos o por sus pensamientos.

Red piensa que hay que escuchar activamente y tomar apuntes claros. Evita usar el m√≥vil durante las clases, porque eso puede reducir la atenci√≥n.`,
    questions: [
      { id:"p14q1", type:"mcq", marks:2,
        prompt:"(E) Concentration helps students‚Ä¶",
        options:["Sleep","Understand lessons","Skip class","Talk more"],
        answerIndex:1
      },
      { id:"p14q2", type:"short", marks:4,
        prompt:"(E) Give TWO distractions mentioned.",
        rubric:"Noise; thoughts.",
        keywords:[
          ["bruits","ruidos","noise"],
          ["pensees","pensamientos","thoughts"]
        ]
      },
      { id:"p14q3", type:"pn", marks:2,
        prompt:"(E) ‚ÄòRed avoids using his phone in class.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p14q4", type:"tfnm", marks:2,
        prompt:"(E) The teacher uses music during lessons. (True / False / Not mentioned)",
        correct:"Not mentioned"
      },
      { id:"p14q5", type:"short", marks:6,
        prompt:"(H) How can active listening improve results?",
        rubric:"Better understanding; clearer notes; fewer mistakes.",
        keywords:[
          ["understand","entender","comprender"],
          ["notes","apuntes","notas"],
          ["mistakes","errores","menos errores"]
        ]
      },
      { id:"p14q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© hay que evitar las distracciones?",
        rubric:"Para concentrarse mejor y entender.",
        keywords:[
          ["concentrar","concentrarse"],
          ["entender","comprender"]
        ]
      }
    ]
  },

  {
    id: 15,
    title: "Pasaje 15 ‚Äî La organizaci√≥n de Otono Mansion",
    theme: "Tema 3 ‚Äî Otono Team",
    unit: "Unidad 9 (Otono Mansion)",
    text: `Otono Mansion tiene m√°s de noventa habitaciones. Cada espacio tiene una funci√≥n precisa. Algunas salas est√°n destinadas al trabajo y otras al descanso.

Esta organizaci√≥n ayuda a evitar el caos. Los habitantes saben ad√≥nde ir seg√∫n sus necesidades. Red aprecia especialmente los espacios tranquilos para estudiar.`,
    questions: [
      { id:"p15q1", type:"mcq", marks:2,
        prompt:"(E) Otono Mansion has‚Ä¶",
        options:["Less than 20 rooms","Over 90 rooms","Exactly 50 rooms","One room"],
        answerIndex:1
      },
      { id:"p15q2", type:"pn", marks:2,
        prompt:"(E) ‚ÄòOrganisation reduces chaos.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p15q3", type:"short", marks:4,
        prompt:"(E) Give TWO types of rooms mentioned.",
        rubric:"Work rooms; rest rooms.",
        keywords:[
          ["travail","trabajo","work"],
          ["repos","descanso","rest"]
        ]
      },
      { id:"p15q4", type:"tfnm", marks:2,
        prompt:"(E) Red dislikes quiet spaces. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p15q5", type:"short", marks:6,
        prompt:"(H) Why is structure important in a large building?",
        rubric:"Avoid chaos; clear functions; easier organisation.",
        keywords:[
          ["chaos","caos"],
          ["fonction","funci√≥n","funciones"],
          ["organiser","organizaci√≥n","organizar"]
        ]
      },
      { id:"p15q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© le gustan a Red algunos espacios?",
        rubric:"Porque son tranquilos para estudiar.",
        keywords:[
          ["tranquilo","tranquilos","calma"],
          ["estudiar","para estudiar"]
        ]
      }
    ]
  },

  {
    id: 16,
    title: "Pasaje 16 ‚Äî El equilibrio entre velocidad y precisi√≥n",
    theme: "Tema 2 ‚Äî Tiempo libre",
    unit: "Unidad 5 (Equilibrio)",
    text: `En los proyectos de Otono, algunos prefieren ir r√°pido, mientras que otros prefieren la precisi√≥n. La velocidad permite terminar pronto, pero la precisi√≥n reduce los errores.

OWing piensa que hay que encontrar un equilibrio. Seg√∫n √©l, trabajar demasiado r√°pido puede crear problemas, pero trabajar demasiado lento puede retrasar el proyecto.`,
    questions: [
      { id:"p16q1", type:"mcq", marks:2,
        prompt:"(E) Speed helps to‚Ä¶",
        options:["Create errors","Finish quickly","Sleep","Delay work"],
        answerIndex:1
      },
      { id:"p16q2", type:"pn", marks:2,
        prompt:"(E) ‚ÄòPrecision reduces errors.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p16q3", type:"short", marks:4,
        prompt:"(E) Give TWO risks mentioned.",
        rubric:"Working too fast; working too slowly.",
        keywords:[
          ["trop vite","demasiado r√°pido","too fast"],
          ["trop lentement","demasiado lento","too slow","muy lento"]
        ]
      },
      { id:"p16q4", type:"tfnm", marks:2,
        prompt:"(E) The project is always delayed. (True / False / Not mentioned)",
        correct:"Not mentioned"
      },
      { id:"p16q5", type:"short", marks:6,
        prompt:"(H) Why is balance important?",
        rubric:"Avoid errors; avoid delays; improve quality.",
        keywords:[
          ["erreurs","errores"],
          ["retard","retraso","retrasar"],
          ["qualite","calidad","mejorar"]
        ]
      },
      { id:"p16q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øQu√© piensa OWing del trabajo demasiado r√°pido?",
        rubric:"Puede crear problemas.",
        keywords:[
          ["problemas","crear problemas"]
        ]
      }
    ]
  },

  {
    id: 17,
    title: "Pasaje 17 ‚Äî La importancia de la disciplina",
    theme: "Tema 1 ‚Äî Escuela",
    unit: "Unidad 4 (Disciplina)",
    text: `La disciplina es una cualidad importante para tener √©xito. Implica trabajar con regularidad y respetar las reglas. Sin disciplina, es f√°cil perder la motivaci√≥n.

Red piensa que la disciplina no es solo escolar: tambi√©n es √∫til en la m√∫sica, el deporte e incluso en los juegos. Seg√∫n √©l, la regularidad crea resultados s√≥lidos.`,
    questions: [
      { id:"p17q1", type:"mcq", marks:2,
        prompt:"(E) Discipline helps you‚Ä¶",
        options:["Lose motivation","Succeed","Avoid school","Break rules"],
        answerIndex:1
      },
      { id:"p17q2", type:"short", marks:4,
        prompt:"(E) Give TWO areas where discipline is useful.",
        rubric:"School; music; sport; games.",
        keywords:[
          ["school","escolar","escuela"],
          ["musique","m√∫sica"],
          ["sport","deporte"],
          ["jeux","juegos"]
        ]
      },
      { id:"p17q3", type:"pn", marks:2,
        prompt:"(E) ‚ÄòDiscipline prevents loss of motivation.‚Äô (P / N / P+N)",
        correct:"P"
      },
      { id:"p17q4", type:"tfnm", marks:2,
        prompt:"(E) Discipline is only useful at school. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p17q5", type:"short", marks:6,
        prompt:"(H) Why does regular work create solid results?",
        rubric:"Consistency; improvement over time; stability.",
        keywords:[
          ["regular","regularidad","con regularidad"],
          ["improve","mejorar","progresar"],
          ["stable","s√≥lidos","estabilidad","solidez"]
        ]
      },
      { id:"p17q6", type:"es_short", marks:4,
        prompt:"(M) En espa√±ol: ¬øPor qu√© es importante la disciplina?",
        rubric:"Porque ayuda a tener √©xito y a mantener la motivaci√≥n.",
        keywords:[
          ["√©xito","tener √©xito","lograr"],
          ["motivaci√≥n","mantenerse motivado","motivado"]
        ]
      }
    ]
  },
];

/* -----------------------------
   TRANSLATIONS (LONGER + STRICT KEY IDEAS)
   Each translation = 20 marks
   Marking: 5 idea-groups √ó 4 marks = 20
--------------------------------*/

const TRANSLATIONS = [
  {
    id: "T1",
    title: "Traducci√≥n ‚Äî Rutina de examen",
    theme: "Tema 1 ‚Äî Escuela",
    text: "Before an exam, I stay calm and I read the instructions carefully. I underline the important words, and I check how many details the question needs. This method helps me avoid simple mistakes and lose fewer marks.",
    keyIdeas: [
      ["before an exam","before the exam"],
      ["stay calm","calm"],
      ["read the instructions","read instructions","instructions carefully"],
      ["underline","important words"],
      ["avoid simple mistakes","lose fewer marks","lose fewer points"]
    ],
    sampleAnswer:
      "Antes de un examen, me mantengo tranquilo y leo las consignas con atenci√≥n. Subrayo las palabras importantes y compruebo cu√°ntos detalles pide la pregunta. Este m√©todo me ayuda a evitar errores simples y a perder menos puntos."
  },

  {
    id: "T2",
    title: "Traducci√≥n ‚Äî Trabajo en equipo en un juego",
    theme: "Tema 2 ‚Äî Tiempo libre",
    text: "On our game server, teamwork is essential. If someone rushes, they can make mistakes, but if someone checks everything, the project is cleaner. When we combine speed and precision, the build progresses faster and the result is better.",
    keyIdeas: [
      ["teamwork","work together"],
      ["rush","go too fast","rushed"],
      ["make mistakes","errors"],
      ["checks everything","check details","precision"],
      ["combine speed and precision","better result","progresses faster"]
    ],
    sampleAnswer:
      "En nuestro servidor, el trabajo en equipo es esencial. Si alguien se apresura, puede cometer errores, pero si alguien lo comprueba todo, el proyecto queda m√°s limpio. Cuando combinamos velocidad y precisi√≥n, la construcci√≥n avanza m√°s r√°pido y el resultado es mejor."
  },

  {
    id: "T3",
    title: "Traducci√≥n ‚Äî Otono Airways",
    theme: "Tema 3 ‚Äî Otono Team",
    text: "With Otono Airways, passengers notice the organisation in the cabin and the comfort of the seats. Even in economy class, there is enough space to sit comfortably. For some people, these details show the quality of the airline.",
    keyIdeas: [
      ["with Otono Airways","Otono Airways"],
      ["passengers notice","passengers"],
      ["organisation in the cabin","organisation","cabin"],
      ["comfort of the seats","comfort","seats"],
      ["economy class","enough space","quality of the airline","quality"]
    ],
    sampleAnswer:
      "Con Otono Airways, los pasajeros notan la organizaci√≥n en la cabina y la comodidad de los asientos. Incluso en clase turista, hay suficiente espacio para sentarse c√≥modamente. Para algunas personas, estos detalles muestran la calidad de la aerol√≠nea."
  },

  {
    id: "T4",
    title: "Traducci√≥n ‚Äî Reglas y √©xito",
    theme: "Tema 1 ‚Äî Escuela",
    text: "Knowing the topic is not always enough in an exam. If you do not follow the instructions, you can lose marks even with the correct idea. That is why it is important to answer fully and to include the details the question asks for.",
    keyIdeas: [
      ["not always enough","not enough"],
      ["follow the instructions","follow instructions"],
      ["lose marks","lose points"],
      ["correct idea","correct answer"],
      ["answer fully","include details","the question asks for"]
    ],
    sampleAnswer:
      "Conocer el tema no siempre es suficiente en un examen. Si no sigues las consignas, puedes perder puntos incluso con la idea correcta. Por eso es importante responder completamente e incluir los detalles que pide la pregunta."
  }
];

/* -----------------------------
   Utilities
--------------------------------*/
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function nowISO(){ return new Date().toISOString(); }

function norm(s){
  return (s ?? "")
    .toString()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function pickRandom(arr, n){
  return shuffle(arr).slice(0, n);
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function otonoLetterGrade(score){
  if(score >= 101) return "S";
  if(score >= 95) return "A*";
  if(score >= 90) return "A";
  if(score >= 80) return "B";
  if(score >= 70) return "C";
  if(score >= 66) return "D";
  if(score >= 55) return "E";
  if(score >= 45) return "F";
  if(score >= 30) return "G";
  if(score >= 15) return "H";
  return "U";
}

function passMeritDistinction(score){
  if(score >= 90) return "DISTINCTION";
  if(score >= 80) return "MERIT";
  if(score >= 66) return "PASS";
  return "FAIL";
}

function gcseEstimate(score){
  if(score >= 90) return 9;
  if(score >= 80) return 8;
  if(score >= 70) return 7;
  if(score >= 60) return 6;
  if(score >= 50) return 5;
  if(score >= 40) return 4;
  if(score >= 30) return 3;
  if(score >= 20) return 2;
  if(score >= 10) return 1;
  return "U";
}

function badgeForScore(score){
  if(score >= 90) return ["badge good","üèÜ DISTINCTION"];
  if(score >= 80) return ["badge good","‚≠ê MERIT"];
  if(score >= 66) return ["badge warn","‚úÖ PASS"];
  return ["badge bad","‚ùå FAIL"];
}

/* -----------------------------
   Local storage
--------------------------------*/
const STORE_KEY = "otonoSpanishReadingSAM_set1_results_v2";

function loadResults(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveResults(list){
  localStorage.setItem(STORE_KEY, JSON.stringify(list));
}
function addResult(attempt){
  const list = loadResults();
  list.unshift(attempt);
  saveResults(list);
}

/* -----------------------------
   App state
--------------------------------*/
let state = {
  mode: "home",
  timer: null,
  remainingSec: 0,
  startedAt: null,

  centreNo: "50749",

  candidateNo: null,         // 4 digits
  candSurname: "",
  candForenames: "",

  selection: null,
  answers: {},               // qid -> user answer (string)
  mcqCorrectValue: {},       // qid -> correct radio value after shuffling
  submitted: false
};

/* -----------------------------
   Centre number controls
--------------------------------*/
function setCentre(no){
  state.centreNo = String(no);
  $("#centreNo").value = state.centreNo;
  $("#centreTop").textContent = state.centreNo;
}

$("#btnEditCentre").addEventListener("click", () => {
  const val = prompt("Enter centre number (digits only, e.g. 50749):", state.centreNo);
  if(val === null) return;
  const clean = String(val).replace(/\D/g,"").slice(0, 10);
  if(clean.length < 3){
    alert("Centre number must be digits only (at least 3 digits).");
    return;
  }
  setCentre(clean);
});

$("#btnResetCentre").addEventListener("click", () => setCentre("50749"));

/* -----------------------------
   Candidate number 4 squares
--------------------------------*/
const digitIds = ["#candD1","#candD2","#candD3","#candD4"];

function getCandidateNoFromSquares(){
  const d = digitIds.map(id => ($(id).value || "").trim());
  if(d.some(x => x.length !== 1 || !/^\d$/.test(x))) return "";
  return d.join("");
}

function focusDigit(i){
  const el = $(digitIds[i]);
  if(el) el.focus();
}

function wireDigitSquares(){
  digitIds.forEach((id, idx) => {
    const el = $(id);

    el.addEventListener("input", () => {
      // keep digits only
      el.value = (el.value || "").replace(/\D/g,"").slice(0,1);
      if(el.value && idx < digitIds.length-1) focusDigit(idx+1);
    });

    el.addEventListener("keydown", (e) => {
      if(e.key === "Backspace" && !el.value && idx > 0){
        focusDigit(idx-1);
      }
      if(e.key === "ArrowLeft" && idx > 0){
        e.preventDefault(); focusDigit(idx-1);
      }
      if(e.key === "ArrowRight" && idx < digitIds.length-1){
        e.preventDefault(); focusDigit(idx+1);
      }
    });

    el.addEventListener("paste", (e) => {
      e.preventDefault();
      const txt = (e.clipboardData || window.clipboardData).getData("text") || "";
      const digits = txt.replace(/\D/g,"").slice(0,4).split("");
      digits.forEach((ch, j) => {
        const target = $(digitIds[j]);
        if(target) target.value = ch;
      });
      // focus next empty
      const joined = getCandidateNoFromSquares();
      if(joined.length === 4) focusDigit(3);
      else{
        const firstEmpty = digitIds.findIndex(did => !$(did).value);
        if(firstEmpty >= 0) focusDigit(firstEmpty);
      }
    });
  });
}
wireDigitSquares();

/* -----------------------------
   Build paper (4 passages + 1 translation)
--------------------------------*/
function generateSelection(){
  const passages = pickRandom(PASSAGES, 4);
  const translation = pickRandom(TRANSLATIONS, 1)[0];
  return { passages, translation };
}
function selectionSummary(sel){
  const p = sel.passages.map(x=>`#${x.id}`).join(", ");
  return `Passages: ${p} ‚Ä¢ Translation: ${sel.translation.id}`;
}

/* -----------------------------
   Rendering
--------------------------------*/
function setBadge(text, cls="badge"){
  const b = $("#statusBadge");
  b.className = cls;
  b.textContent = text;
}

function renderHome(){
  $("#homeBody").classList.remove("hide");
  $("#testBody").classList.add("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideTitle").textContent = "Otono grading";
  $("#sideMeta").textContent = "Score ‚Üí Otono grade + GCSE estimate + Pass/Merit/Distinction.";
  $("#sideBody").classList.remove("hide");
  setBadge("Ready","badge");
  $("#timerText").textContent = "--:--";
}

function renderResults(){
  $("#homeBody").classList.add("hide");
  $("#testBody").classList.add("hide");
  $("#sideBody").classList.add("hide");
  $("#resultsBody").classList.remove("hide");
  $("#sideTitle").textContent = "Saved results";
  $("#sideMeta").textContent = "Stored per candidate in this browser (localStorage).";
  setBadge("Results","badge");
  $("#timerText").textContent = "--:--";
  drawResults();
}

function stopTimer(){
  if(state.timer){
    clearInterval(state.timer);
    state.timer = null;
  }
}

function startTimer(minutes){
  stopTimer();
  state.remainingSec = Math.max(1, Math.floor(minutes*60));
  state.startedAt = Date.now();

  const tick = () => {
    if(state.submitted) return;
    const m = Math.floor(state.remainingSec/60);
    const s = state.remainingSec%60;
    $("#timerText").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    state.remainingSec--;
    if(state.remainingSec < 0){
      stopTimer();
      const auto = $("#autoSubmit").value === "yes";
      if(auto) submitPaper(true);
      else alert("Time is up. You can still submit manually.");
    }
  };

  tick();
  state.timer = setInterval(tick, 1000);
}

function renderTest(){
  $("#homeBody").classList.add("hide");
  $("#testBody").classList.remove("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideBody").classList.remove("hide");

  const candNameLine = [
    state.candSurname ? state.candSurname : "",
    state.candForenames ? state.candForenames : ""
  ].filter(Boolean).join(", ");

  const cand = `${state.candidateNo}${candNameLine ? " ‚Ä¢ " + candNameLine : ""}`;
  $("#kpiCandidate").textContent = cand;
  $("#kpiPassages").textContent = state.selection.passages.map(p=>`#${p.id}`).join(" ");
  $("#kpiTranslation").textContent = state.selection.translation.id;

  const shuffleMode = $("#shuffleMode").value;
  const paper = $("#paper");
  paper.innerHTML = "";

  // reset per-paper MCQ mapping
  state.mcqCorrectValue = {};

  const sel = state.selection;
  const themes = sel.passages.map(p => `${p.title} (${p.theme}, ${p.unit})`);
  const head = document.createElement("div");
  head.className = "note";
  head.innerHTML = `<strong>Selected content</strong><br/>` +
    themes.map(t => `‚Ä¢ ${escapeHtml(t)}`).join("<br/>") +
    `<br/>‚Ä¢ ${escapeHtml(sel.translation.title)} (${escapeHtml(sel.translation.theme)})`;
  paper.appendChild(head);

  let allBlocks = [];

  sel.passages.forEach(p => {
    const block = document.createElement("div");
    block.className = "card";
    block.style.marginTop = "14px";

    block.innerHTML = `
      <div class="hd">
        <div>
          <h2>${escapeHtml(p.title)}</h2>
          <div class="meta">${escapeHtml(p.theme)} ‚Ä¢ ${escapeHtml(p.unit)} ‚Ä¢ <strong>20 marks</strong></div>
        </div>
        <span class="badge">${escapeHtml("#"+p.id)}</span>
      </div>
      <div class="bd">
        <div class="passage">${escapeHtml(p.text).replace(/\n/g,"<br/>")}</div>
        <div class="divider"></div>
        <div class="small">MCQ/choice options are always shuffled. Written answers are auto-marked using keyword coverage.</div>
        <div class="qs"></div>
      </div>
    `;

    const qs = block.querySelector(".qs");
    let qsList = p.questions.slice();
    if(shuffleMode === "shuffleAll") qsList = shuffle(qsList);

    qsList.forEach(q => {
      const qWrap = document.createElement("div");
      qWrap.className = "q";
      qWrap.dataset.qid = q.id;

      const markTag = `<span class="badge" title="Marks for this question">${q.marks} marks</span>`;
      const instruction = (q.type === "fr_short")
        ? "Answer in Spanish. Auto-mark uses keywords."
        : (["mcq","pn","tfnm"].includes(q.type) ? "Select one option." : "Auto-mark uses keywords. Write concise, direct answers.");

      qWrap.innerHTML = `
        <h3>${escapeHtml(q.prompt)} ${markTag}</h3>
        ${renderQuestion(q)}
        <div class="small" style="margin-top:8px">${escapeHtml(instruction)}</div>
      `;
      qs.appendChild(qWrap);
    });

    allBlocks.push(block);
  });

  // Translation block
  const t = sel.translation;
  const tBlock = document.createElement("div");
  tBlock.className = "card";
  tBlock.style.marginTop = "14px";
  tBlock.innerHTML = `
    <div class="hd">
      <div>
        <h2>${escapeHtml(t.title)}</h2>
        <div class="meta">${escapeHtml(t.theme)} ‚Ä¢ <strong>20 marks</strong></div>
      </div>
      <span class="badge">TRANSLATION</span>
    </div>
    <div class="bd">
      <div class="passage">${escapeHtml(t.text)}</div>
      <div class="divider"></div>
      <div class="q" data-qid="translation">
        <h3>Translate into Spanish (write naturally). <span class="badge">20 marks</span></h3>
        <textarea id="ans_translation" placeholder="Type your Spanish translation here..."></textarea>
        <div class="small" style="margin-top:8px">Auto-mark checks key ideas. It‚Äôs strict: include the meaning clearly.</div>
      </div>
    </div>
  `;
  allBlocks.push(tBlock);

  allBlocks.forEach(b => paper.appendChild(b));

  bindInputs();

  const mins = parseInt($("#timeAllowed").value,10);
  startTimer(mins);
  state.submitted = false;

  $("#markingBox").classList.add("hide");
  $("#markingBox").innerHTML = "";
  setBadge("In progress","badge warn");
}

function renderQuestion(q){
  if(q.type === "mcq"){
    const opts = q.options.map((text, idx) => ({ text, isCorrect: idx === q.answerIndex }));
    return renderChoice(q, opts);
  }
  if(q.type === "pn"){
    // Positive / Negative / Both
    const opts = [
      { text:"P", isCorrect: q.correct === "P" },
      { text:"N", isCorrect: q.correct === "N" },
      { text:"P+N", isCorrect: q.correct === "P+N" }
    ];
    return renderChoice(q, opts);
  }
  if(q.type === "tfnm"){
    const opts = [
      { text:"True", isCorrect: q.correct === "True" },
      { text:"False", isCorrect: q.correct === "False" },
      { text:"Not mentioned", isCorrect: q.correct === "Not mentioned" }
    ];
    return renderChoice(q, opts);
  }
  // short / fr_short
  return `<textarea id="ans_${q.id}" placeholder="${q.type === "fr_short" ? "R√©ponds en fran√ßais..." : "Write your answer here..."}"></textarea>`;
}

function renderChoice(q, optionObjects){
  const name = `ans_${q.id}`;

  // ALWAYS shuffle choice options
  const shuffled = shuffle(optionObjects);

  // store which radio value is correct after shuffle
  // value = index in shuffled array
  const correctIndex = shuffled.findIndex(o => o.isCorrect);
  state.mcqCorrectValue[q.id] = String(correctIndex);

  return `
    <div class="opts">
      ${shuffled.map((opt, idx) => `
        <label class="opt">
          <input type="radio" name="${name}" value="${idx}" />
          <div><div><strong>${String.fromCharCode(65+idx)}.</strong> ${escapeHtml(opt.text)}</div></div>
        </label>
      `).join("")}
    </div>
  `;
}

function bindInputs(){
  $$("input[type='radio']").forEach(r => {
    r.addEventListener("change", () => {
      const qid = r.name.replace("ans_","");
      state.answers[qid] = r.value;
    });
  });
  $$("textarea").forEach(t => {
    t.addEventListener("input", () => {
      const id = t.id.replace("ans_","");
      state.answers[id] = t.value;
    });
  });
}

/* -----------------------------
   Auto marking
--------------------------------*/
function markShortAnswer(q, userText){
  const t = norm(userText);
  if(!t) return {score:0, max:q.marks, detail:"Blank answer."};

  const groups = q.keywords || [];
  if(groups.length === 0) return {score:0, max:q.marks, detail:"No keyword rubric set."};

  let hits = 0;
  groups.forEach(g => {
    const found = g.some(k => t.includes(norm(k)));
    if(found) hits++;
  });

  const per = q.marks / groups.length;
  const raw = hits * per;
  const score = Math.max(0, Math.min(q.marks, Math.round(raw*2)/2));

  let detail = `Keyword groups matched: ${hits}/${groups.length}.`;
  if(q.rubric) detail += ` Expected: ${q.rubric}`;
  return {score, max:q.marks, detail};
}

function markChoice(qid, chosenValue, marks){
  const correctValue = state.mcqCorrectValue[qid];
  const ok = String(chosenValue ?? "") === String(correctValue);
  return {
    score: ok ? marks : 0,
    max: marks,
    detail: ok ? "Correct." : "Incorrect."
  };
}

function markTranslation(tObj, userText){
  const t = norm(userText);
  if(!t) return {score:0, max:20, detail:"Blank translation."};

  let hits = 0;
  const ideas = tObj.keyIdeas || [];
  ideas.forEach(group => {
    const ok = group.some(k => t.includes(norm(k)));
    if(ok) hits++;
  });

  // 5 ideas √ó 4 marks
  const score = Math.min(20, hits * 4);
  const detail = `Key ideas matched: ${hits}/${ideas.length}. (4 marks each)`;
  return {score, max:20, detail};
}

function computeTotal(){
  let total = 0;
  let breakdown = [];

  state.selection.passages.forEach(p => {
    p.questions.forEach(q => {
      const ans = state.answers[q.id];
      let res;

      if(["mcq","pn","tfnm"].includes(q.type)){
        res = markChoice(q.id, ans, q.marks);
      }else{
        res = markShortAnswer(q, ans);
      }

      total += res.score;
      breakdown.push({
        qid: q.id,
        passageId: p.id,
        type: q.type,
        prompt: q.prompt,
        score: res.score,
        max: res.max,
        detail: res.detail
      });
    });
  });

  const tAns = state.answers["translation"] ?? $("#ans_translation")?.value ?? "";
  const tRes = markTranslation(state.selection.translation, tAns);
  total += tRes.score;
  breakdown.push({
    qid: "translation",
    passageId: "translation",
    type: "translation",
    prompt: "Translate into Spanish",
    score: tRes.score,
    max: tRes.max,
    detail: tRes.detail
  });

  const totalRounded = Math.round(total*10)/10;
  return { total: totalRounded, max: 100, breakdown };
}

/* -----------------------------
   Submission + saving
--------------------------------*/
function submitPaper(fromAutoTimer=false){
  if(state.submitted) return;

  const { total, max, breakdown } = computeTotal();
  state.submitted = true;
  stopTimer();

  const letter = otonoLetterGrade(total);
  const pmd = passMeritDistinction(total);
  const gcse = gcseEstimate(total);
  const [badgeCls, badgeText] = badgeForScore(total);

  const attempt = {
    paper: "Otono Spanish Reading (SAM) ‚Ä¢ Sample set 1",
    centre: state.centreNo,
    candidateNo: String(state.candidateNo),
    candidateSurname: state.candSurname || "",
    candidateForenames: state.candForenames || "",
    submittedAt: nowISO(),
    timeAllowedMin: parseInt($("#timeAllowed").value,10),
    selectedPassages: state.selection.passages.map(p=>p.id),
    selectedTranslation: state.selection.translation.id,
    score: total,
    maxScore: max,
    otonoGrade: letter,
    gcseEstimated: gcse,
    outcome: pmd,
    breakdown
  };
  addResult(attempt);

  const nameLine = [attempt.candidateSurname, attempt.candidateForenames].filter(Boolean).join(", ");

  const box = $("#markingBox");
  box.classList.remove("hide");
  box.className = "";
  box.innerHTML = `
    <div class="card">
      <div class="hd">
        <div>
          <h2>‚úÖ Marked${fromAutoTimer ? " (auto-submitted)" : ""}</h2>
          <div class="meta">Saved to Results ‚Ä¢ Centre ${escapeHtml(attempt.centre)} ‚Ä¢ Candidate ${escapeHtml(attempt.candidateNo)}${nameLine ? " ‚Ä¢ " + escapeHtml(nameLine) : ""}</div>
        </div>
        <span class="${badgeCls}">${escapeHtml(badgeText)}</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box"><div class="t">Score</div><div class="v">${attempt.score} / ${attempt.maxScore}</div></div>
          <div class="box"><div class="t">Otono grade</div><div class="v">${escapeHtml(attempt.otonoGrade)}</div></div>
          <div class="box"><div class="t">GCSE estimate</div><div class="v">${escapeHtml(String(attempt.gcseEstimated))}</div></div>
          <div class="box"><div class="t">Outcome</div><div class="v">${escapeHtml(attempt.outcome)}</div></div>
        </div>

        <div class="divider"></div>

        <div class="note">
          <strong>Marking notes</strong><br/>
          ‚Ä¢ MCQ / P-N / TFNM are exact (options are shuffled).<br/>
          ‚Ä¢ Written + translation are keyword-based. If you used very different wording, it may under-mark.
        </div>

        <div class="divider"></div>

        <button class="btn" id="btnShowBreakdown">Show question breakdown</button>
        <div id="breakdown" class="hide" style="margin-top:12px"></div>

        <div class="divider"></div>

        <div class="note">
          <strong>Translation model answer (for reference)</strong><br/>
          ${escapeHtml(state.selection.translation.sampleAnswer)}
        </div>
      </div>
    </div>
  `;

  $("#btnShowBreakdown").addEventListener("click", () => {
    const bd = $("#breakdown");
    bd.classList.toggle("hide");
    if(!bd.classList.contains("hide")){
      bd.innerHTML = breakdown.map(b => `
        <div class="attempt">
          <div class="top">
            <div><strong>${escapeHtml(b.qid)}</strong> ‚Ä¢ ${escapeHtml(String(b.type))}</div>
            <div><span class="badge">${b.score} / ${b.max}</span></div>
          </div>
          <div class="meta">
            <div><strong>Prompt:</strong> ${escapeHtml(b.prompt)}</div>
            <div><strong>Marker:</strong> ${escapeHtml(b.detail)}</div>
          </div>
        </div>
      `).join("");
    }
  });

  setBadge("Submitted","badge good");
}

/* -----------------------------
   Results UI
--------------------------------*/
function drawResults(){
  const listEl = $("#resultsList");
  const all = loadResults();
  const filter = ($("#filterCandidate").value || "").replace(/\D/g,"").slice(0,4);

  const filtered = filter ? all.filter(a => String(a.candidateNo) === String(filter)) : all;

  if(filtered.length === 0){
    listEl.innerHTML = `<div class="note">No stored attempts${filter ? " for this candidate" : ""} yet.</div>`;
    return;
  }

  listEl.innerHTML = filtered.map(a => {
    const [cls, txt] = badgeForScore(a.score);
    const nameLine = [a.candidateSurname, a.candidateForenames].filter(Boolean).join(", ");
    return `
      <div class="attempt">
        <div class="top">
          <div>
            <strong>${escapeHtml(a.candidateNo)}</strong>${nameLine ? " ‚Ä¢ " + escapeHtml(nameLine) : ""}
            <span class="badge" style="margin-left:8px">Centre ${escapeHtml(a.centre)}</span>
          </div>
          <div class="${cls}">${escapeHtml(txt)} ‚Ä¢ ${escapeHtml(String(a.score))}/100</div>
        </div>
        <div class="meta">
          <div><strong>Date:</strong> ${escapeHtml(new Date(a.submittedAt).toLocaleString())}</div>
          <div><strong>Selection:</strong> Passages ${escapeHtml(a.selectedPassages.join(", "))} ‚Ä¢ Translation ${escapeHtml(a.selectedTranslation)}</div>
          <div><strong>Grades:</strong> Otono ${escapeHtml(a.otonoGrade)} ‚Ä¢ GCSE ${escapeHtml(String(a.gcseEstimated))} ‚Ä¢ ${escapeHtml(a.outcome)}</div>
        </div>
      </div>
    `;
  }).join("");
}

function exportResults(){
  const all = loadResults();
  $("#exportText").textContent = JSON.stringify(all, null, 2);
  $("#exportBox").classList.remove("hide");
}

function clearResults(){
  if(!confirm("Clear ALL stored Otono Spanish results on this browser?")) return;
  localStorage.removeItem(STORE_KEY);
  drawResults();
  $("#exportBox").classList.add("hide");
}

/* -----------------------------
   Buttons / navigation
--------------------------------*/
$("#btnHome").addEventListener("click", () => {
  state.mode = "home";
  renderHome();
});

$("#btnResults").addEventListener("click", () => {
  state.mode = "results";
  renderResults();
});

$("#btnPreview").addEventListener("click", () => {
  const c = getCandidateNoFromSquares();
  if(!c){
    alert("Enter a candidate number first.");
    return;
  }
  const sel = generateSelection();
  const box = $("#previewBox");
  box.classList.remove("hide");
  box.innerHTML = `<strong>Preview (not started):</strong><br/>${escapeHtml(selectionSummary(sel))}<br/>` +
    sel.passages.map(p => `‚Ä¢ ${escapeHtml(p.title)} (${escapeHtml(p.theme)})`).join("<br/>") +
    `<br/>‚Ä¢ ${escapeHtml(sel.translation.title)} (${escapeHtml(sel.translation.theme)})`;
});

$("#btnStart").addEventListener("click", () => {
  const c = getCandidateNoFromSquares();
  if(!c){
    alert("Candidate number is required.");
    focusDigit(0);
    return;
  }

  state.candidateNo = c;
  state.candSurname = ($("#candSurname").value || "").trim();
  state.candForenames = ($("#candForenames").value || "").trim();

  state.selection = generateSelection();
  state.answers = {};
  renderTest();
});

$("#btnSubmit").addEventListener("click", () => submitPaper(false));

$("#btnReset").addEventListener("click", () => {
  if(!confirm("Reset this paper and generate a NEW random test? Your current answers will be lost.")) return;
  stopTimer();
  state.answers = {};
  state.submitted = false;
  state.selection = generateSelection();
  renderTest();
});

/* Results filters & tabs */
$("#filterCandidate").addEventListener("input", (e) => {
  e.target.value = e.target.value.replace(/\D/g,"").slice(0,4);
  drawResults();
});

$("#tabAll").addEventListener("click", () => {
  $("#tabAll").classList.add("active");
  $("#tabCandidate").classList.remove("active");
  $("#filterCandidate").value = "";
  drawResults();
});

$("#tabCandidate").addEventListener("click", () => {
  $("#tabCandidate").classList.add("active");
  $("#tabAll").classList.remove("active");
  $("#filterCandidate").focus();
});

$("#btnExport").addEventListener("click", exportResults);
$("#btnClear").addEventListener("click", clearResults);

/* Initial */
setCentre("50749");
renderHome();

/* -----------------------------
   Anti-cheat / source protection
   (as requested)
--------------------------------*/
const disabledKeys = ["u", "I"];
const showAlert = e => {
  e.preventDefault();
  return alert("Hahaha, I challenge you, valiant soldier, to uproot the source codes yourself!!!");
};
document.addEventListener("contextmenu", e => { showAlert(e); });
document.addEventListener("keydown", e => {
  if ((e.ctrlKey && disabledKeys.includes(e.key)) || e.key === "F12") {
    showAlert(e);
  }
});
</script>

</body>
</html>
