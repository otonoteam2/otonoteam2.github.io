<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üü£ Otono French ‚Äî Reading (SAM) ‚Ä¢ Sample set 2</title>
  <style>
    :root{
      --bg1:#2b0a3d; --bg2:#7a0036;
      --card:#0f0b18cc; --card2:#120c22e6;
      --text:#f4efff; --muted:#c9b9ff;
      --accent:#b000ff; --accent2:#ff1b6a;
      --good:#19ff9a; --warn:#ffd166; --bad:#ff4d6d;
      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(176,0,255,.22), transparent 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(255,27,106,.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:22px;}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky; top:14px; z-index:20; backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0; font-size:16px; letter-spacing:.3px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); font-family:var(--mono); font-size:12px;
      display:flex; gap:10px; align-items:center;
    }
    .pill strong{color:#fff}
    .btn{
      border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.33); border-color:rgba(255,255,255,.22)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(176,0,255,.55), rgba(255,27,106,.45));
      border-color:rgba(255,255,255,.22);
    }
    .btn.danger{background:rgba(255,77,109,.18); border-color:rgba(255,77,109,.35)}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .topbar{position:static} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .hd .meta{font-size:12px; color:var(--muted); line-height:1.25}
    .card .bd{padding:16px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}

    input[type="text"], input[type="number"], textarea, select{
      width:100%; border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; outline:none;
      font-family:var(--sans);
    }
    textarea{min-height:90px; resize:vertical}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > div{flex:1 1 180px}

    .note{
      font-size:12px; color:var(--muted); line-height:1.4;
      padding:10px 12px; border-radius:14px; border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
    }
    .badge{
      font-family:var(--mono); font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.20);
      display:inline-flex; align-items:center; gap:6px;
    }
    .badge.good{border-color:rgba(25,255,154,.35); background:rgba(25,255,154,.12)}
    .badge.warn{border-color:rgba(255,209,102,.35); background:rgba(255,209,102,.12)}
    .badge.bad{border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.12)}
    .divider{height:1px; background:var(--line); margin:14px 0}
    .passage{
      padding:12px 14px; border:1px solid var(--line); border-radius:16px;
      background:rgba(0,0,0,.22); line-height:1.5;
    }
    .q{
      margin-top:14px; padding:12px 14px; border:1px solid var(--line);
      border-radius:16px; background:rgba(0,0,0,.20);
    }
    .q h3{margin:0 0 8px; font-size:13px}
    .opts{display:grid; gap:8px; margin-top:8px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px; border-radius:14px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      cursor:pointer;
    }
    .opt input{margin-top:3px}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 980px){ .kpi{grid-template-columns:repeat(2,1fr)} }
    .kpi .box{
      border:1px solid var(--line); border-radius:16px; padding:10px 12px;
      background:rgba(0,0,0,.22);
    }
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .kpi .box .v{font-size:18px; font-weight:800; margin-top:4px}
    .small{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:rgba(0,0,0,.22); cursor:pointer; font-weight:700}
    .tab.active{background:linear-gradient(135deg, rgba(176,0,255,.35), rgba(255,27,106,.22)); border-color:rgba(255,255,255,.22)}
    .resultsList{display:grid; gap:10px}
    .attempt{
      border:1px solid var(--line); border-radius:16px; padding:12px 14px;
      background:rgba(0,0,0,.20);
    }
    .attempt .top{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .attempt .top strong{font-family:var(--mono)}
    .attempt .meta{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.4}
    .copy{font-family:var(--mono); font-size:12px; white-space:pre-wrap; word-break:break-word}
    .hide{display:none !important}

    /* Candidate number 4 squares */
    .digitRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .digitRow .digit{
      width:52px; text-align:center; font-family:var(--mono);
      font-size:18px; font-weight:900; padding:12px 0;
      border-radius:14px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); color:var(--text);
      outline:none;
    }
    .digitRow .hint{font-size:12px; color:var(--muted)}
    .miniRow{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    .miniRow > *{flex:1 1 160px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>üü£ Otono French ‚Äî Paper 3 ‚Ä¢ Reading ‚Ä¢ Sample Assessment Material ‚Ä¢ Sample set 2</h1>
        <div class="sub">
          Auto marking ‚Ä¢ 4 random passages √ó 20 + 1 translation √ó 20 = 100 ‚Ä¢ Centre:
          <strong id="centreTop">50749</strong>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
        <div class="pill">
          <span>‚è±Ô∏è Timer:</span>
          <strong id="timerText">--:--</strong>
        </div>
        <button class="btn" id="btnResults">Results</button>
        <button class="btn primary" id="btnHome">Test</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: main -->
      <div class="card" id="panelHome">
        <div class="hd">
          <div>
            <h2>Candidate setup</h2>
            <div class="meta">No dictionary ‚Ä¢ No translator ‚Ä¢ Answer from the text ‚Ä¢ Auto marking for written answers uses keywords (not perfect).</div>
          </div>
          <span class="badge" id="statusBadge">Ready</span>
        </div>

        <div class="bd" id="homeBody">
          <div class="miniRow">
            <div>
              <label>Centre number</label>
              <input type="text" id="centreNo" value="50749" disabled />
              <div class="small" style="margin-top:6px">
                Default is <strong>50749</strong>. You can change it (optional) with the button.
              </div>
            </div>
            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
              <button class="btn" id="btnEditCentre">Customise centre</button>
              <button class="btn" id="btnResetCentre">Reset centre</button>
            </div>
          </div>

          <div class="divider"></div>

          <div>
            <label>Candidate number (required, 4 digits)</label>
            <div class="digitRow" aria-label="Candidate number 4 digits">
              <input class="digit" id="candD1" inputmode="numeric" maxlength="1" />
              <input class="digit" id="candD2" inputmode="numeric" maxlength="1" />
              <input class="digit" id="candD3" inputmode="numeric" maxlength="1" />
              <input class="digit" id="candD4" inputmode="numeric" maxlength="1" />
              <span class="hint">Digits only ‚Ä¢ auto-advance</span>
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <div>
              <label>Candidate surname (optional)</label>
              <input type="text" id="candSurname" placeholder="Surname" />
            </div>
            <div>
              <label>Candidate forename(s) (optional)</label>
              <input type="text" id="candForenames" placeholder="Forename(s)" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>How the random paper works (SAM set 1):</strong><br/>
            ‚Ä¢ The system selects <strong>4 random passages</strong> (each worth <strong>20</strong>) and <strong>1 random translation</strong> (worth <strong>20</strong>).<br/>
            ‚Ä¢ You‚Äôll get a mix of <strong>MCQ</strong>, <strong>P/N/P+N</strong>, <strong>True/False/Not mentioned</strong>, and <strong>written answers</strong>.<br/>
            ‚Ä¢ Some passages include <strong>questions answered in French</strong> (you must answer in French).<br/>
            ‚Ä¢ Written + translation answers are marked by <strong>keyword coverage</strong> (so write clear, direct answers).<br/>
            ‚Ä¢ Your attempt is saved to this browser using <strong>localStorage</strong>.
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label>Time allowed</label>
              <select id="timeAllowed">
                <option value="75" selected>75 minutes (recommended)</option>
                <option value="60">60 minutes</option>
                <option value="45">45 minutes</option>
              </select>
            </div>
            <div>
              <label>Question order</label>
              <select id="shuffleMode">
                <option value="shuffleAll" selected>Shuffle questions (harder)</option>
                <option value="keepOrder">Keep original order</option>
              </select>
            </div>
            <div>
              <label>On timer end</label>
              <select id="autoSubmit">
                <option value="yes" selected>Auto-submit</option>
                <option value="no">Do not auto-submit</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap">
            <button class="btn primary" id="btnStart">Start Random Paper</button>
            <button class="btn" id="btnPreview">Preview Random Selection</button>
          </div>

          <div id="previewBox" class="note hide" style="margin-top:12px"></div>
        </div>

        <!-- Test body -->
        <div class="bd hide" id="testBody">
          <div class="kpi">
            <div class="box"><div class="t">Candidate</div><div class="v" id="kpiCandidate">‚Äî</div></div>
            <div class="box"><div class="t">Selected passages</div><div class="v" id="kpiPassages">‚Äî</div></div>
            <div class="box"><div class="t">Translation</div><div class="v" id="kpiTranslation">‚Äî</div></div>
            <div class="box"><div class="t">Max score</div><div class="v">100</div></div>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>Instructions reminder:</strong>
            No dictionary. Do not copy from outside. Base answers on the passage. For written answers, include the key idea(s) clearly.
          </div>

          <div id="paper"></div>

          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btnSubmit">Submit & Auto-Mark</button>
            <button class="btn" id="btnReset">Reset (new random paper)</button>
          </div>

          <div id="markingBox" class="hide" style="margin-top:14px"></div>
        </div>
      </div>

      <!-- Right: results / help -->
      <div class="card" id="panelSide">
        <div class="hd">
          <div>
            <h2 id="sideTitle">Otono grading</h2>
            <div class="meta" id="sideMeta">Score ‚Üí Otono grade + GCSE estimate + Pass/Merit/Distinction.</div>
          </div>
        </div>

        <div class="bd" id="sideBody">
          <div class="note">
            <strong>Pass/Merit/Distinction</strong><br/>
            PASS: 66+<br/>
            MERIT: 80+<br/>
            DISTINCTION: 90+<br/>
          </div>
          <div class="divider"></div>
          <div class="note">
            <strong>Otono grades (A‚ÄìH + secret S)</strong><br/>
            S: 101+ (secret)<br/>
            A*: 95‚Äì100<br/>
            A: 90‚Äì94<br/>
            B: 80‚Äì89<br/>
            C: 70‚Äì79<br/>
            D: 66‚Äì69<br/>
            E: 55‚Äì65<br/>
            F: 45‚Äì54<br/>
            G: 30‚Äì44<br/>
            H: 15‚Äì29<br/>
            U: 0‚Äì14
          </div>
          <div class="divider"></div>
          <div class="note">
            <strong>GCSE 9‚Äì1 estimate (simple mapping)</strong><br/>
            9: 90‚Äì100 ‚Ä¢ 8: 80‚Äì89 ‚Ä¢ 7: 70‚Äì79 ‚Ä¢ 6: 60‚Äì69 ‚Ä¢ 5: 50‚Äì59<br/>
            4: 40‚Äì49 ‚Ä¢ 3: 30‚Äì39 ‚Ä¢ 2: 20‚Äì29 ‚Ä¢ 1: 10‚Äì19 ‚Ä¢ U: 0‚Äì9
          </div>
          <div class="divider"></div>
          <div class="small">
            Tip: results are stored locally on this device/browser only. If you clear site data, they disappear.
          </div>
        </div>

        <!-- Results panel -->
        <div class="bd hide" id="resultsBody">
          <div class="tabs">
            <div class="tab active" id="tabAll">All attempts</div>
            <div class="tab" id="tabCandidate">By candidate</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Filter candidate number (4 digits)</label>
              <input type="text" id="filterCandidate" placeholder="e.g. 1105" inputmode="numeric" />
            </div>
            <div>
              <label>Actions</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" id="btnExport">Export JSON</button>
                <button class="btn danger" id="btnClear">Clear stored results</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="resultsList" id="resultsList"></div>

          <div id="exportBox" class="note hide" style="margin-top:12px">
            <div><strong>Exported JSON</strong> (copy/save it):</div>
            <div class="divider"></div>
            <div class="copy" id="exportText"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   OTONO BANK (STRAIGHTFORWARD TEXT, SIMILAR LENGTH)
   Each passage total = 20 marks
--------------------------------*/

// ‚úÖ UPDATED: P/N/P+N questions restored + each passage now totals 20 marks
// ‚úÖ NOT every passage has 6 questions anymore (some have 5, some 7)
// ‚úÖ ALL questions + rubrics are in ENGLISH (only prompts marked ‚ÄúEn fran√ßais‚Äù require French answers)

const PASSAGES = [
  {
    id: 1,
    title: "Passage 1 ‚Äî Madame Munn et la r√®gle du crayon",
    theme: "Theme 1 ‚Äî School",
    unit: "Unit 4 (Mock exam rules)",
    text: `Avant les examens blancs, Madame Munn r√©unit la classe pour clarifier une rumeur. Elle dit que les √©l√®ves ont trop entendu ‚Äú√ßa d√©pend‚Äù et qu‚Äôil faut une r√®gle simple. Elle parle d‚Äôune voix s√©rieuse, puis elle lit une phrase qu‚Äôelle a √©crite pour que tout le monde s‚Äôen souvienne : ¬´ Moi et Monsieur Young avons d√©cid√© : si des copies sont √©crites au crayon, elles ne seront pas corrig√©es. ¬ª

Dans la salle, certains √©l√®ves √©changent des regards. Quelques-uns utilisent souvent le crayon parce qu‚Äôils aiment pouvoir effacer. Madame Munn insiste : ce n‚Äôest pas une punition ‚Äúpour √™tre m√©chante‚Äù, mais une fa√ßon d‚Äô√©viter les disputes apr√®s l‚Äô√©preuve. Elle ajoute qu‚Äôavant le vrai examen, les r√®gles seront expliqu√©es officiellement, et que les consignes √©crites sur la feuille seront la r√©f√©rence.

Red note la r√®gle dans son carnet, mais il remarque aussi le mot important : ‚Äúexamens blancs‚Äù. Pour lui, cela signifie que la situation peut encore √©voluer. Il se dit qu‚Äôil doit toujours v√©rifier la consigne finale le jour J, plut√¥t que de se fier √† une phrase entendue dans un couloir.`,
    questions: [
      { id:"p1q1", type:"mcq", marks:2,
        prompt:"(E) When does Madame Munn explain this rule?",
        options:["Before mock exams","After the real GCSE exam","During a sports lesson","On a school trip"],
        answerIndex:0
      },
      { id:"p1q2", type:"tfnm", marks:2,
        prompt:"(E) Will the paper be marked if it's written in pencil? (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p1q3", type:"short", marks:4,
        prompt:"(E) Give TWO reasons Madame Munn gives for making a clear rule.",
        rubric:"Any TWO: students heard too much ‚Äòit depends‚Äô; she wants a simple rule; to avoid arguments/disputes after the paper; to stop confusion caused by rumours.",
        keywords:[
          ["rumeur","rumour"],
          ["√ßa d√©pend","it depends"],
          ["r√®gle simple","simple rule"],
          ["√©viter","avoid","disputes","dispute","discuter","arguments"]
        ]
      },
      { id:"p1q4", type:"pn", marks:2,
        prompt:"(E) Madame Munn‚Äôs message about rules is mostly‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p1q5", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Pourquoi certains √©l√®ves utilisent-ils le crayon ? Donne UNE raison.",
        rubric:"Because they like being able to erase / correct easily (answer in French).",
        keywords:[
          ["effacer","effacer facilement"],
          ["corriger","corriger facilement"],
          ["aiment","ils aiment"]
        ]
      },
      { id:"p1q6", type:"tfnm", marks:2,
        prompt:"(E) Madame Munn says the written instructions on the paper will be the final reference. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p1q7", type:"short", marks:4,
        prompt:"(H) Explain why Red thinks the situation could change, using TWO details.",
        rubric:"Because she speaks about ‚Äòmock exams‚Äô (not the real exam) AND she says official rules will be explained later / written instructions on the paper will be the reference; Red therefore plans to check the final instruction on the day.",
        keywords:[
          ["examens blancs","mock"],
          ["vrai examen","real exam"],
          ["officiellement","official"],
          ["consignes √©crites","written instructions","feuille"],
          ["v√©rifier","check","jour J","day"]
        ]
      }
    ]
  },

  {
    id: 2,
    title: "Passage 2 ‚Äî Les objets interdits : petits d√©tails, gros stress",
    theme: "Theme 1 ‚Äî School",
    unit: "Unit 4 (Forbidden materials)",
    text: `Le matin d‚Äôun examen, l‚Äôinvigilateur affiche une liste d‚Äôobjets interdits. Beaucoup d‚Äô√©l√®ves pensent imm√©diatement au t√©l√©phone, mais la liste est plus longue. On y voit : surligneurs utilis√©s dans les r√©ponses, stylos gel dans les r√©ponses, stylos effa√ßables, buvard (blotting paper) et m√™me certains accessoires ‚Äúinnocents‚Äù que les √©l√®ves gardent par habitude.

Une √©l√®ve demande : ‚ÄúM√™me un surligneur, c‚Äôest interdit ?‚Äù L‚Äôinvigilateur r√©pond que surligner la question est acceptable si la consigne l‚Äôautorise, mais que surligner OU √©crire des r√©ponses au gel peut poser un probl√®me de lecture ou de scan. Pour √©viter la confusion, l‚Äô√©cole pr√©f√®re interdire ces objets pendant l‚Äô√©preuve.

Red observe que la r√®gle n‚Äôest pas seulement ‚Äúpour emb√™ter‚Äù. Il comprend que le but est de rendre les copies lisibles pour tous. OWing, lui, arrive avec une trousse minimale : un stylo simple, une r√®gle, et rien d‚Äôautre. Il dit que c‚Äôest la seule fa√ßon d‚Äô√™tre s√ªr de ne pas perdre du temps ni des points.`,
    questions: [
      { id:"p2q1", type:"mcq", marks:2,
        prompt:"(E) Which item is explicitly mentioned as forbidden?",
        options:["Erasable pens","A water bottle","A calculator for French","A coat"],
        answerIndex:0
      },
      { id:"p2q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says phones are the ONLY forbidden item. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p2q3", type:"short", marks:4,
        prompt:"(E) List FOUR forbidden materials mentioned.",
        rubric:"Any FOUR: highlighters used in answers; gel pens in answers; erasable pens; blotting paper/buvard; (accept: ‚Äòaccessories kept by habit‚Äô only if accompanied by a correct example).",
        keywords:[
          ["surligneur","highlighter","surligneurs"],
          ["stylo gel","gel pen","gel"],
          ["effa√ßable","erasable","stylos effa√ßables"],
          ["buvard","blotting paper"]
        ]
      },
      { id:"p2q4", type:"pn", marks:2,
        prompt:"(E) The passage presents the rule about forbidden items as‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p2q5", type:"tfnm", marks:2,
        prompt:"(E) The invigilator says highlighting the QUESTION is always forbidden. (True / False / Not mentioned)",
        correct:"Not mentioned"
      },
      { id:"p2q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Quel est le but principal de ces r√®gles, selon Red ?",
        rubric:"To make copies readable for everyone / avoid reading or scanning problems (answer in French).",
        keywords:[
          ["lisibles","lisible"],
          ["lecture","probl√®me de lecture"],
          ["scan","scanner"],
          ["pour tous","tout le monde"]
        ]
      },
      { id:"p2q7", type:"short", marks:4,
        prompt:"(H) Why does OWing bring a minimal pencil case? Give TWO reasons from the passage.",
        rubric:"Any TWO: to be sure nothing is forbidden; to avoid losing time; to avoid losing marks; to remove confusion.",
        keywords:[
          ["trousse minimale","minimal"],
          ["√™tre s√ªr","sure"],
          ["interdit","forbidden"],
          ["perdre du temps","lose time"],
          ["perdre des points","lose marks"],
          ["confusion"]
        ]
      }
    ]
  },

  {
    id: 3,
    title: "Passage 3 ‚Äî OWing et le GCSE de maths en avance",
    theme: "Theme 1 ‚Äî School",
    unit: "Unit 3 (Early GCSE)",
    text: `√Ä Otono, OWing a eu une opportunit√© rare : il a pu passer le GCSE de maths plus t√¥t que la majorit√©. Ses professeurs ont expliqu√© que ce n‚Äô√©tait pas ‚Äúun privil√®ge gratuit‚Äù, mais une d√©cision bas√©e sur sa pr√©paration. OWing acceptait la pression, mais il voulait aussi que l‚Äôexp√©rience reste normale : m√™mes r√®gles, m√™me salle, m√™me s√©rieux.

Le jour de l‚Äô√©preuve, il ne cherchait pas √† impressionner qui que ce soit. Il s‚Äôest concentr√© sur les bases : lire lentement, v√©rifier les unit√©s, et revenir sur les questions douteuses. Apr√®s l‚Äôexamen, il a dit que le plus difficile n‚Äô√©tait pas le niveau des questions, mais le mental : rester stable pendant tout le temps.

Red le f√©licite, mais il remarque un autre d√©tail : OWing parle tr√®s peu de son score. Il dit surtout ce qu‚Äôil a appris sur la m√©thode. Pour Red, c‚Äôest une diff√©rence importante : certains veulent ‚Äúmontrer‚Äù, OWing veut ‚Äúcomprendre‚Äù.`,
    questions: [
      { id:"p3q1", type:"mcq", marks:2,
        prompt:"(E) Why was OWing allowed to take GCSE maths early?",
        options:["Because teachers believed he was prepared","Because he won a sports trophy","Because he refused homework","Because he moved schools"],
        answerIndex:0
      },
      { id:"p3q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says OWing took the exam early to get special rules. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p3q3", type:"pn", marks:2,
        prompt:"(E) OWing‚Äôs approach to the exam is mostly‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p3q4", type:"short", marks:6,
        prompt:"(H) Describe THREE methods OWing uses during the exam.",
        rubric:"Any THREE: reads slowly; checks units; returns to doubtful questions; focuses on basics; stays stable mentally.",
        keywords:[
          ["lire lentement","lentement"],
          ["v√©rifier","unit√©s","units"],
          ["revenir","questions douteuses","douteuses"],
          ["bases","basics"],
          ["mental","stable","rester stable"]
        ]
      },
      { id:"p3q5", type:"tfnm", marks:2,
        prompt:"(E) OWing says the hardest part was the mental side. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p3q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Quelle diff√©rence Red voit-il entre ‚Äòmontrer‚Äô et ‚Äòcomprendre‚Äô ?",
        rubric:"He thinks some people want to show off results, while OWing focuses on understanding the method (answer in French).",
        keywords:[
          ["certains","montrer"],
          ["r√©sultat","score"],
          ["OWing","comprendre"],
          ["m√©thode","method"]
        ]
      },
      { id:"p3q7", type:"short", marks:2,
        prompt:"(E) What does Red do after the exam, according to the passage?",
        rubric:"He congratulates OWing.",
        keywords:[
          ["f√©licite","congratulates"]
        ]
      }
    ]
  },

  {
    id: 4,
    title: "Passage 4 ‚Äî Clayton et la note parfaite",
    theme: "Theme 4 ‚Äî Perfection vs progress",
    unit: "Unit 10 (Maths result)",
    text: `Clayton a obtenu une note parfaite en GCSE maths : 160 sur 160. √Ä l‚Äô√©cole, la nouvelle circule vite. Certains √©l√®ves sont impressionn√©s, d‚Äôautres se sentent imm√©diatement ‚Äúpetits‚Äù. Un professeur explique que ce genre de r√©sultat ne tombe pas du ciel : il faut une m√©thode, de la r√©p√©tition, et une vraie discipline.

Clayton, lui, r√©pond avec une phrase simple : ‚ÄúCe n‚Äôest pas une magie. J‚Äôai juste corrig√© mes erreurs √† chaque fois.‚Äù Il dit qu‚Äôil n‚Äôa pas travaill√© une seule nuit ‚Äújusqu‚Äô√† 3h du matin‚Äù, mais plut√¥t un peu, r√©guli√®rement. Il admet que la perfection peut √™tre dangereuse si elle fait peur aux autres, mais il insiste : le but n‚Äôest pas d‚Äô√©craser une classe, c‚Äôest de prouver que la m√©thode marche.

Red √©coute et retient un point : Clayton parle de correction, pas de talent. Pour lui, c‚Äôest une le√ßon utile, m√™me si la perfection reste intimidante.`,
    questions: [
      { id:"p4q1", type:"mcq", marks:2,
        prompt:"(E) What score did Clayton achieve?",
        options:["160/160","150/160","120/160","160/200"],
        answerIndex:0
      },
      { id:"p4q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says Clayton revised only the night before. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p4q3", type:"pn", marks:2,
        prompt:"(E) Reactions to Clayton‚Äôs result are shown as‚Ä¶ (P / N / P+N)",
        answer:"P+N"
      },
      { id:"p4q4", type:"short", marks:6,
        prompt:"(H) Give THREE reasons the teacher gives for this kind of result.",
        rubric:"Method; repetition/practice; discipline (accept: consistent effort).",
        keywords:[
          ["m√©thode","method"],
          ["r√©p√©tition","r√©p√©ter","practice"],
          ["discipline"],
          ["r√©guli√®rement","regular"]
        ]
      },
      { id:"p4q5", type:"tfnm", marks:2,
        prompt:"(E) Clayton says ‚Äòit‚Äôs magic talent‚Äô. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p4q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Pourquoi Clayton dit-il que la perfection peut √™tre ‚Äòdangereuse‚Äô ?",
        rubric:"Because it can scare or intimidate other students (answer in French).",
        keywords:[
          ["dangereuse","danger"],
          ["faire peur","peur"],
          ["intimidante","intimider"],
          ["aux autres","others"]
        ]
      },
      { id:"p4q7", type:"short", marks:2,
        prompt:"(E) What key idea does Red remember?",
        rubric:"That Clayton talks about correcting mistakes, not talent.",
        keywords:[
          ["corriger","mistakes","erreurs"],
          ["pas","talent"]
        ]
      }
    ]
  },

  {
    id: 5,
    title: "Passage 5 ‚Äî Dans la salle : silence et consignes",
    theme: "Theme 1 ‚Äî School",
    unit: "Unit 4 (Exam room)",
    text: `Quand les √©l√®ves entrent dans la salle d‚Äôexamen, le bruit du couloir dispara√Æt. Les tables sont espac√©es, et les sacs vont √† l‚Äôavant. L‚Äôinvigilateur attend que tout le monde s‚Äôinstalle, puis il lit les consignes, lentement, pour √©viter toute confusion.

Il rappelle qu‚Äôil faut √©crire clairement, v√©rifier le num√©ro de candidat, et ne pas toucher aux objets interdits. √Ä ce moment-l√†, un √©l√®ve r√©alise qu‚Äôil a gard√© un surligneur dans sa poche. Il devient p√¢le, puis il l√®ve la main. L‚Äôinvigilateur reste calme : il r√©cup√®re l‚Äôobjet et note l‚Äôincident.

Red comprend un d√©tail important : paniquer ne r√©sout rien. Il se concentre sur la feuille, relit la premi√®re question, et commence par ce qu‚Äôil sait. Pour lui, le silence est √©trange, mais il peut aussi aider : moins de discussions, plus de concentration.`,
    questions: [
      { id:"p5q1", type:"mcq", marks:2,
        prompt:"(E) Where are bags placed in the exam room?",
        options:["At the front","On the tables","Under each chair","Outside the building"],
        answerIndex:0
      },
      { id:"p5q2", type:"tfnm", marks:2,
        prompt:"(E) The invigilator reads instructions quickly to save time. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p5q3", type:"pn", marks:2,
        prompt:"(E) The invigilator‚Äôs behaviour is‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p5q4", type:"short", marks:4,
        prompt:"(E) Give TWO instructions mentioned.",
        rubric:"Any TWO: write clearly; check candidate number; do not touch forbidden items; read instructions carefully (implied).",
        keywords:[
          ["√©crire","clairement"],
          ["num√©ro de candidat","candidate number"],
          ["objets interdits","forbidden items","interdits"],
          ["consignes","instructions"]
        ]
      },
      { id:"p5q5", type:"tfnm", marks:2,
        prompt:"(E) A student realises they have a highlighter in their pocket. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p5q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Pourquoi Red pense-t-il que paniquer ne sert √† rien ?",
        rubric:"Because it does not solve the problem; he focuses on reading and starting with what he knows (answer in French).",
        keywords:[
          ["paniquer","panic"],
          ["ne r√©sout rien","ne sert √† rien"],
          ["se concentre","concentre"],
          ["relit","question"],
          ["commence","ce qu‚Äôil sait"]
        ]
      },
      { id:"p5q7", type:"short", marks:4,
        prompt:"(H) Explain TWO ways silence can affect students in the room, based on the passage.",
        rubric:"It can feel strange; it reduces discussion; it can increase concentration; small noises feel more noticeable (accept if linked to silence).",
        keywords:[
          ["silence","strange","√©trange"],
          ["moins de discussions","less discussion"],
          ["concentration","concentrer"],
          ["bruit","noticeable","remarque"]
        ]
      }
    ]
  },

  {
    id: 6,
    title: "Passage 6 ‚Äî Projet : vitesse, pr√©cision et m√©thode",
    theme: "Theme 2 ‚Äî Free time",
    unit: "Unit 5 (Projects)",
    text: `Dans un projet en √©quipe, il y a souvent un d√©bat : faut-il aller vite ou √™tre pr√©cis ? Une personne veut finir rapidement pour voir un r√©sultat. Une autre pr√©f√®re v√©rifier chaque d√©tail, pour √©viter les erreurs. Les deux attitudes ont une logique, mais elles peuvent se contredire.

Un jour, l‚Äô√©quipe d√©cide d‚Äôessayer une r√®gle : deux phases. D‚Äôabord, on construit une version simple rapidement. Ensuite, on ralentit et on v√©rifie tout : alignements, erreurs, et coh√©rence. Red reconna√Æt que cette m√©thode est plus efficace que de se disputer pendant une heure.

OWing ajoute une id√©e : si on v√©rifie trop t√¥t, on perd de l‚Äô√©nergie, mais si on ne v√©rifie jamais, on perd du temps √† refaire. Pour lui, la bonne solution est un rythme clair. Le projet devient plus calme, et chacun sait quand acc√©l√©rer et quand contr√¥ler.`,
    questions: [
      { id:"p6q1", type:"mcq", marks:2,
        prompt:"(E) What rule does the team try?",
        options:["Two phases: build fast, then check","Never check anything","Only check before starting","Work alone"],
        answerIndex:0
      },
      { id:"p6q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says checking is always a waste of time. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p6q3", type:"pn", marks:2,
        prompt:"(E) The passage presents the ‚Äòtwo phases‚Äô method as‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p6q4", type:"short", marks:6,
        prompt:"(H) Describe the two phases with THREE details.",
        rubric:"Phase 1: quick simple version / finish a basic build. Phase 2: slow down and check details such as alignment, errors, coherence (any three details total).",
        keywords:[
          ["d‚Äôabord","premi√®re","first"],
          ["version simple","basic version","rapidement"],
          ["ensuite","then"],
          ["ralentit","slow down"],
          ["v√©rifie","check"],
          ["alignements","alignment"],
          ["erreurs","errors"],
          ["coh√©rence","coherence"]
        ]
      },
      { id:"p6q5", type:"tfnm", marks:2,
        prompt:"(E) Red thinks the method is more efficient than arguing. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p6q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Pourquoi OWing dit-il que v√©rifier ‚Äòtrop t√¥t‚Äô peut √™tre un probl√®me ?",
        rubric:"Because it can waste energy / slow progress before the basic version exists (answer in French).",
        keywords:[
          ["trop t√¥t","too early"],
          ["perdre","√©nergie"],
          ["ralentir","slow"],
          ["progr√®s","avancer"]
        ]
      },
      { id:"p6q7", type:"short", marks:2,
        prompt:"(E) What changes in the project atmosphere after the method is used?",
        rubric:"It becomes calmer and clearer; everyone knows when to speed up and when to check.",
        keywords:[
          ["plus calme","calmer"],
          ["rythme","clear rhythm"],
          ["sait","quand","acc√©l√©rer","contr√¥ler"]
        ]
      }
    ]
  },

  {
    id: 7,
    title: "Passage 7 ‚Äî Luke et l‚Äôencre : simplicit√© avant tout",
    theme: "Theme 1 ‚Äî School",
    unit: "Unit 2 (Writing tools)",
    text: `Luke aime l‚Äôencre noire parce qu‚Äôelle est nette et facile √† lire. Il dit que, quand une copie est scann√©e, les √©critures p√¢les peuvent √™tre un probl√®me. Pourtant, il ne veut pas transformer la question du stylo en drame. Pour lui, la r√®gle la plus intelligente est : lire la consigne de la feuille.

Avant une √©valuation, certains √©l√®ves arrivent avec plusieurs stylos ‚Äúau cas o√π‚Äù. Luke trouve que cela cr√©e plus de stress. Il pr√©f√®re choisir un stylo simple et garder une solution de secours, mais sans collectionner du mat√©riel. Il rappelle aussi une autre id√©e : si une consigne interdit un type d‚Äôencre, ce n‚Äôest pas forc√©ment une attaque personnelle, c‚Äôest juste une r√®gle du document.

Red approuve la m√©thode, car elle est claire : on suit le papier officiel, pas les rumeurs. Il dit que cette attitude √©vite des pertes de temps inutiles avant le d√©but de l‚Äô√©preuve.`,
    questions: [
      { id:"p7q1", type:"mcq", marks:2,
        prompt:"(E) Why does Luke like black ink?",
        options:["It is neat and easy to read, especially when scanned","It disappears on paper","It is only used in art","It is forbidden everywhere"],
        answerIndex:0
      },
      { id:"p7q2", type:"tfnm", marks:2,
        prompt:"(E) Luke says you should follow rumours about pens. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p7q3", type:"pn", marks:2,
        prompt:"(E) The passage presents Luke‚Äôs approach as‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p7q4", type:"short", marks:4,
        prompt:"(E) Give TWO reasons bringing many pens can be negative, according to Luke.",
        rubric:"Any TWO: it creates more stress; it turns the pen topic into drama; it complicates preparation; it wastes time.",
        keywords:[
          ["stress"],
          ["drame","drama"],
          ["compliquer","complicates"],
          ["perdre du temps","waste time"],
          ["plusieurs stylos","many pens"]
        ]
      },
      { id:"p7q5", type:"tfnm", marks:2,
        prompt:"(E) The passage mentions pale writing can be a problem when scanning. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p7q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Quelle est la r√®gle ‚Äòla plus intelligente‚Äô selon Luke ?",
        rubric:"To read/follow the instruction on the exam paper (answer in French).",
        keywords:[
          ["lire","consigne"],
          ["feuille","papier"],
          ["suivre","officiel","officielle"]
        ]
      },
      { id:"p7q7", type:"short", marks:4,
        prompt:"(H) Explain why Red agrees with this approach, giving TWO ideas.",
        rubric:"Because it is clear and official; it avoids rumours; it prevents wasting time before the exam starts.",
        keywords:[
          ["clair","clear"],
          ["officiel","official"],
          ["rumeurs","rumours"],
          ["√©vite","avoid"],
          ["perte de temps","waste time"],
          ["d√©but","√©preuve"]
        ]
      }
    ]
  },

  {
    id: 8,
    title: "Passage 8 ‚Äî Choisir une option : d√©cision et doute",
    theme: "Theme 1 ‚Äî School",
    unit: "Unit 3 (Options)",
    text: `Choisir une option GCSE peut sembler simple, mais beaucoup d‚Äô√©l√®ves h√©sitent. Certains ont peur de se tromper. D‚Äôautres aiment plusieurs mati√®res et n‚Äôarrivent pas √† d√©cider. L‚Äô√©cole, en plus, doit organiser les groupes : il y a des places limit√©es et des horaires qui peuvent se chevaucher.

Un √©l√®ve explique qu‚Äôil aime le fran√ßais, mais qu‚Äôil n‚Äôest pas s√ªr d‚Äô√™tre ‚Äúassez bon‚Äù. Un professeur r√©pond qu‚Äôune mati√®re ne se choisit pas seulement avec la confiance du moment. Il dit qu‚Äôon peut progresser vite avec une m√©thode et de la r√©gularit√©. L‚Äôid√©e rassure un peu la classe, m√™me si le stress ne dispara√Æt pas totalement.

Red entend surtout une phrase : ‚Äúon apprend en avan√ßant‚Äù. Pour lui, h√©siter n‚Äôest pas un crime. Il pense que le vrai danger, c‚Äôest de choisir sans r√©fl√©chir, puis de regretter en silence.`,
    questions: [
      { id:"p8q1", type:"mcq", marks:2,
        prompt:"(E) Why can option choices be difficult?",
        options:["Fear of choosing wrong and timetable/places constraints","Because exams are cancelled","Because students must move country","Because teachers refuse options"],
        answerIndex:0
      },
      { id:"p8q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says there are unlimited places in every class. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p8q3", type:"pn", marks:2,
        prompt:"(E) The passage presents hesitation as‚Ä¶ (P / N / P+N)",
        answer:"P+N"
      },
      { id:"p8q4", type:"short", marks:4,
        prompt:"(E) Give TWO reasons students hesitate, from the passage.",
        rubric:"Any TWO: fear of making the wrong choice; like several subjects; worry about being good enough; stress.",
        keywords:[
          ["peur","tromper","wrong"],
          ["plusieurs","mati√®res","several subjects"],
          ["assez bon","good enough"],
          ["stress"]
        ]
      },
      { id:"p8q5", type:"tfnm", marks:2,
        prompt:"(E) A teacher says you can progress quickly with method and regularity. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p8q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Quel est le ‚Äòvrai danger‚Äô selon Red ?",
        rubric:"Choosing without thinking and then regretting in silence (answer in French).",
        keywords:[
          ["choisir","sans r√©fl√©chir"],
          ["regretter","regrets"],
          ["en silence"]
        ]
      },
      { id:"p8q7", type:"short", marks:4,
        prompt:"(H) Explain why the teacher thinks confidence ‚Äòof the moment‚Äô is not enough, using TWO ideas.",
        rubric:"Because choice should not rely only on current feelings; progress can come quickly through method and regular practice, so initial doubt doesn‚Äôt decide everything.",
        keywords:[
          ["pas seulement","confiance du moment"],
          ["progresser","progress"],
          ["m√©thode","method"],
          ["r√©gularit√©","regularity"],
          ["vite","quickly"]
        ]
      }
    ]
  },

  {
    id: 9,
    title: "Passage 9 ‚Äî Le stress : lire trop vite",
    theme: "Theme 1 ‚Äî School",
    unit: "Unit 4 (Exam technique)",
    text: `Avant un contr√¥le, beaucoup d‚Äô√©l√®ves stressent. Ils connaissent la le√ßon, mais ils ont peur de perdre leurs moyens. Un probl√®me revient souvent : sous stress, on lit trop vite. On saute un mot comme ‚Äúdeux‚Äù, on oublie ‚Äújustifier‚Äù, et on r√©pond √† une question diff√©rente sans s‚Äôen rendre compte.

Un professeur propose une routine simple : respirer quelques secondes, puis lire la consigne deux fois. Ensuite, entourer un mot cl√©. Cela ne prend pas longtemps, mais √ßa √©vite des erreurs b√™tes. Certains √©l√®ves trouvent que c‚Äôest ‚Äútrop lent‚Äù, mais le professeur r√©pond : perdre vingt secondes vaut mieux que perdre six points.

Red adopte cette routine. Il dit qu‚Äôelle ne supprime pas le stress, mais qu‚Äôelle transforme le stress en concentration. √Ä la fin, il v√©rifie ses r√©ponses, surtout celles o√π il avait h√©sit√©.`,
    questions: [
      { id:"p9q1", type:"mcq", marks:2,
        prompt:"(E) What common mistake happens under stress in the passage?",
        options:["Reading too fast and missing key words","Forgetting to bring shoes","Talking loudly in the corridor","Sleeping during the exam"],
        answerIndex:0
      },
      { id:"p9q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says stress always means you do not know the lesson. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p9q3", type:"pn", marks:2,
        prompt:"(E) The routine suggested is presented as‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p9q4", type:"short", marks:6,
        prompt:"(H) Describe THREE steps of the routine suggested.",
        rubric:"Any THREE: breathe for a few seconds; read the instruction twice; circle a key word; (accept: check answers at end if linked to routine mindset).",
        keywords:[
          ["respirer","breathe"],
          ["lire","deux fois","twice"],
          ["entourer","circle"],
          ["mot cl√©","key word"],
          ["v√©rifier","check"]
        ]
      },
      { id:"p9q5", type:"tfnm", marks:2,
        prompt:"(E) The teacher says losing 20 seconds is better than losing 6 marks. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p9q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Comment Red d√©crit-il l‚Äôeffet de la routine ?",
        rubric:"It turns stress into concentration; it does not remove stress completely (answer in French).",
        keywords:[
          ["transforme","transformer"],
          ["stress"],
          ["concentration"],
          ["ne supprime pas","pas totalement"]
        ]
      },
      { id:"p9q7", type:"short", marks:4,
        prompt:"(H) Give TWO examples of key words students might miss if they read too fast.",
        rubric:"Any TWO from passage: ‚Äòdeux‚Äô (two), ‚Äòjustifier‚Äô (justify). (Accept other valid exam command words only if also includes at least one of these.)",
        keywords:[
          ["deux","two"],
          ["justifier","justify"]
        ]
      }
    ]
  },

  {
    id: 10,
    title: "Passage 10 ‚Äî Travail en groupe : r√¥le obligatoire",
    theme: "Theme 2 ‚Äî Free time",
    unit: "Unit 5 (Team roles)",
    text: `Dans un projet de groupe, les tensions naissent souvent quand les r√¥les ne sont pas clairs. Une personne fait tout, une autre se tait, et le travail devient injuste. Pour √©viter cela, un professeur impose une r√®gle : chaque √©l√®ve doit avoir un r√¥le √©crit d√®s le d√©but.

Les r√¥les sont simples : planifier, √©crire la version finale, v√©rifier les d√©tails. Le professeur ajoute une condition : tout le monde doit parler au moins une fois, m√™me si c‚Äôest une petite id√©e. Il dit que ‚Äúdispara√Ætre‚Äù dans un groupe n‚Äôest pas acceptable.

Red trouve la r√®gle efficace, parce qu‚Äôelle emp√™che le silence total d‚Äôun membre. Il remarque aussi que la qualit√© monte : si quelqu‚Äôun v√©rifie, il y a moins d‚Äôerreurs. L‚Äô√©quipe avance plus vite, car chacun sait quoi faire.`,
    questions: [
      { id:"p10q1", type:"mcq", marks:2,
        prompt:"(E) What is the teacher‚Äôs main rule for group projects?",
        options:["Each student must have a written role from the start","Only one person should talk","Groups must be silent","No checking is allowed"],
        answerIndex:0
      },
      { id:"p10q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says it is acceptable to ‚Äòdisappear‚Äô in a group. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p10q3", type:"pn", marks:2,
        prompt:"(E) Group work here is shown as‚Ä¶ (P / N / P+N)",
        answer:"P+N"
      },
      { id:"p10q4", type:"short", marks:4,
        prompt:"(E) Give TWO roles mentioned.",
        rubric:"Any TWO: planning; writing final version; checking details.",
        keywords:[
          ["planifier","plan"],
          ["version finale","final version","√©crire"],
          ["v√©rifier","check","d√©tails"]
        ]
      },
      { id:"p10q5", type:"tfnm", marks:2,
        prompt:"(E) Everyone must speak at least once. (True / False / Not mentioned)",
        correct:"True"
      },
      { id:"p10q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Pourquoi Red pense-t-il que la r√®gle est efficace ? Donne DEUX id√©es.",
        rubric:"Two ideas (in French): it prevents a member from staying silent/disappearing; it improves quality by reducing errors; it helps speed because everyone knows what to do.",
        keywords:[
          ["emp√™che","silence","se tait"],
          ["dispara√Ætre","disparaitre"],
          ["qualit√©","quality"],
          ["moins d‚Äôerreurs","erreurs"],
          ["plus vite","avance plus vite"],
          ["chacun sait","quoi faire"]
        ]
      },
      { id:"p10q7", type:"short", marks:4,
        prompt:"(H) Explain ONE cause of tension and ONE improvement after roles are assigned.",
        rubric:"Cause: roles unclear so one person does everything and another says nothing. Improvement: fewer errors due to checking OR faster progress because each person knows their job.",
        keywords:[
          ["r√¥les","pas clairs","unclear"],
          ["une personne","fait tout","does everything"],
          ["se tait","silent"],
          ["moins d‚Äôerreurs","fewer errors"],
          ["avance plus vite","faster"],
          ["sait","job"]
        ]
      }
    ]
  },

  {
    id: 11,
    title: "Passage 11 ‚Äî Otono Airways : avis rapide, d√©tail important",
    theme: "Theme 3 ‚Äî Otono Team",
    unit: "Unit 8 (Otono Airways basics)",
    text: `Sur un vol Otono Airways, plusieurs passagers remarquent d‚Äôabord l‚Äôorganisation. L‚Äôembarquement avance bien, les indications sont claires, et la cabine semble soign√©e. M√™me en classe √©conomique, certains disent qu‚Äôils peuvent s‚Äôinstaller sans se sentir ‚Äú√©cras√©s‚Äù.

Mais un d√©tail revient dans les commentaires : le service est parfois tr√®s rapide. Le repas arrive vite, ce qui pla√Æt √† certains, mais d‚Äôautres auraient aim√© un peu plus de temps pour poser des questions √† l‚Äô√©quipage. Un passager dit que ce n‚Äôest pas un vrai d√©faut, juste une question d‚Äôattente : certains veulent de l‚Äôefficacit√©, d‚Äôautres veulent plus d‚Äô√©changes.

Red note que l‚Äô√©quilibre est difficile. Il dit que la qualit√© d‚Äôune compagnie n‚Äôest pas seulement le confort, mais aussi la clart√© des r√®gles et la coh√©rence du service. Pour lui, un bon vol est celui o√π les passagers comprennent ce qui se passe, sans surprise inutile.`,
    questions: [
      { id:"p11q1", type:"mcq", marks:2,
        prompt:"(E) What is one thing passengers notice first?",
        options:["Organisation and clear guidance","A free phone upgrade","A concert in the aisle","No seats at all"],
        answerIndex:0
      },
      { id:"p11q2", type:"tfnm", marks:2,
        prompt:"(E) The passage gives a specific seat pitch number. (True / False / Not mentioned)",
        correct:"Not mentioned"
      },
      { id:"p11q3", type:"pn", marks:2,
        prompt:"(E) The flight experience is presented as‚Ä¶ (P / N / P+N)",
        answer:"P+N"
      },
      { id:"p11q4", type:"short", marks:4,
        prompt:"(E) Give TWO positive points mentioned.",
        rubric:"Any TWO: boarding goes well; clear signs/instructions; cabin looks cared for/clean; economy feels not cramped.",
        keywords:[
          ["embarquement","boarding"],
          ["indications","claires","clear"],
          ["cabine","soign√©e","clean"],
          ["√©conomique","pas √©cras√©s","not cramped"]
        ]
      },
      { id:"p11q5", type:"tfnm", marks:2,
        prompt:"(E) Everyone dislikes the fast meal service. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p11q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Pourquoi le service rapide n‚Äôest-il pas ‚Äòun vrai d√©faut‚Äô selon un passager ?",
        rubric:"Because it depends on expectations: some want efficiency, others want more interaction (answer in French).",
        keywords:[
          ["pas un vrai d√©faut","defaut"],
          ["attente","expectations"],
          ["efficacit√©","efficacite"],
          ["√©changes","discuter","crew","√©quipage"]
        ]
      },
      { id:"p11q7", type:"short", marks:4,
        prompt:"(H) According to Red, what THREE elements contribute to an airline‚Äôs quality?",
        rubric:"Comfort + clarity of rules + consistency/coherence of service (three elements).",
        keywords:[
          ["confort","comfort"],
          ["clart√©","r√®gles","rules"],
          ["coh√©rence","service","consistency"]
        ]
      }
    ]
  },

  {
    id: 12,
    title: "Passage 12 ‚Äî R√©viser sans se punir",
    theme: "Theme 4 ‚Äî Perfection vs progress",
    unit: "Unit 10 (Regularity)",
    text: `Pendant la p√©riode de r√©vision, certains √©l√®ves se punissent d√®s qu‚Äôils ratent une journ√©e. Ils se disent : ‚Äúc‚Äôest fini, je suis en retard.‚Äù Puis ils perdent la motivation. Un professeur rappelle que la r√©gularit√© ne signifie pas √™tre parfait. Cela signifie revenir, m√™me apr√®s un mauvais jour.

La classe discute d‚Äôune strat√©gie simple : petites t√¢ches, objectifs r√©alistes, et ajustement. Si on n‚Äôa pas fini un exercice, on le d√©place au lendemain. Si on a trop pr√©vu, on r√©duit. Le professeur insiste : mieux vaut vingt minutes bien faites que deux heures dans la panique.

Red √©crit une phrase dans sa t√™te : ‚Äúje corrige, je continue.‚Äù Il pense que cette attitude prot√®ge le mental. Selon lui, l‚Äô√©cole valorise les r√©sultats, mais on oublie parfois le chemin. La r√©gularit√©, ce n‚Äôest pas un sprint : c‚Äôest une m√©thode pour tenir jusqu‚Äôau bout.`,
    questions: [
      { id:"p12q1", type:"mcq", marks:2,
        prompt:"(E) What is the main message about revision?",
        options:["Regularity matters more than perfection","You must punish yourself for mistakes","Only long sessions work","Never adjust plans"],
        answerIndex:0
      },
      { id:"p12q2", type:"tfnm", marks:2,
        prompt:"(E) The passage says regularity means being perfect every day. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p12q3", type:"pn", marks:2,
        prompt:"(E) The tone about revision is mostly‚Ä¶ (P / N / P+N)",
        answer:"P"
      },
      { id:"p12q4", type:"short", marks:6,
        prompt:"(H) Give THREE parts of the class strategy.",
        rubric:"Any THREE: small tasks; realistic goals; adjusting; moving unfinished work to tomorrow; reducing the plan if too big; 20 minutes well done beats panic hours.",
        keywords:[
          ["petites t√¢ches","small tasks"],
          ["objectifs r√©alistes","realistic goals"],
          ["ajustement","adjust"],
          ["d√©place","lendemain","tomorrow"],
          ["r√©duit","reduce"],
          ["vingt minutes","20 minutes"],
          ["panique","panic"]
        ]
      },
      { id:"p12q5", type:"tfnm", marks:2,
        prompt:"(E) The teacher prefers two hours of panic to twenty minutes done well. (True / False / Not mentioned)",
        correct:"False"
      },
      { id:"p12q6", type:"fr_short", marks:4,
        prompt:"(M) En fran√ßais : Pourquoi Red pense-t-il que cette attitude ‚Äòprot√®ge le mental‚Äô ?",
        rubric:"Because it helps you continue after a bad day; you correct and keep going instead of giving up (answer in French).",
        keywords:[
          ["prot√®ge","mental"],
          ["mauvais jour","bad day"],
          ["corrige","corriger"],
          ["continue","continuer"],
          ["abandonner","give up"]
        ]
      },
      { id:"p12q7", type:"short", marks:4,
        prompt:"(H) Explain what Red means by ‚Äòit‚Äôs not a sprint‚Äô, using TWO ideas from the passage.",
        rubric:"Revision is about lasting to the end; it‚Äôs a method/long-term rhythm with adjustments, not one intense burst; regularity supports the journey, not just results.",
        keywords:[
          ["jusqu‚Äôau bout","to the end"],
          ["m√©thode","method"],
          ["rythme","rhythm"],
          ["ajuster","adjust"],
          ["chemin","journey"],
          ["pas un sprint","not a sprint"]
        ]
      }
    ]
  }
];

/* -----------------------------
   TRANSLATIONS (LONGER + STRICT KEY IDEAS)
   Each translation = 20 marks
   Marking: 5 idea-groups √ó 4 marks = 20
--------------------------------*/

const SECTION3_TASKS = [
  {
    type: "translation",
    id: "S3-T1",
    title: "Section 3 ‚Äî Translation (20 marks)",
    theme: "Theme 1 ‚Äî School",
    text: "Before a test, I read the instruction twice and I circle the key words. If I rush, I can miss an important detail and lose marks. This routine helps me stay calm and answer fully.",
    keyIdeas: [
      ["avant un contr√¥le", "avant un test", "avant une √©valuation"],
      ["je lis la consigne deux fois", "lire la consigne deux fois", "je relis la consigne"],
      ["j‚Äôentoure", "entourer", "mots cl√©s", "mot-cl√©"],
      ["si je me pr√©cipite", "si je vais trop vite", "si je me d√©p√™che"],
      ["manquer un d√©tail important", "rater un d√©tail important"],
      ["perdre des points"],
      ["cette routine", "cette m√©thode"],
      ["rester calme"],
      ["r√©pondre compl√®tement", "r√©pondre en entier"]
    ],
    sampleAnswer:
      "Avant un contr√¥le, je lis la consigne deux fois et j‚Äôentoure les mots cl√©s. Si je me pr√©cipite, je peux rater un d√©tail important et perdre des points. Cette routine m‚Äôaide √† rester calme et √† r√©pondre compl√®tement."
  },

  {
    type: "gapfill",
    id: "S3-G1",
    title: "Section 3 ‚Äî Gap Fill (10 gaps √ó 2 = 20 marks)",
    theme: "Theme 1 ‚Äî School",
    instructions:
      "Fill each gap with the correct form. Each gap is worth 2 marks. If partially correct (right idea but wrong ending/agreement), award 1 mark.",
    textWithGaps:
      "Avant l‚Äô√©preuve, Red (1) _______ (rester) calme et il (2) _______ (lire) la consigne. Il (3) _______ (entourer) un mot-cl√©, puis il (4) _______ (commencer) par les questions simples. OWing (5) _______ (pr√©f√©rer) une trousse minimale : il (6) _______ (√©viter) les objets interdits. Un √©l√®ve (7) _______ (oublier) un surligneur dans sa poche, mais l‚Äôinvigilateur le (8) _______ (r√©cup√©rer) sans crier. Apr√®s, la classe (9) _______ (comprendre) que paniquer ne (10) _______ (servir) √† rien.",
    answers: [
      { gap: 1, accept: ["reste", "est rest√©", "restait"] },
      { gap: 2, accept: ["lit", "a lu", "lisait"] },
      { gap: 3, accept: ["entoure", "a entour√©", "entourait"] },
      { gap: 4, accept: ["commence", "a commenc√©", "commen√ßait"] },
      { gap: 5, accept: ["pr√©f√®re", "a pr√©f√©r√©", "pr√©f√©rait"] },
      { gap: 6, accept: ["√©vite", "a √©vit√©", "√©vitait"] },
      { gap: 7, accept: ["oublie", "a oubli√©", "oubliait"] },
      { gap: 8, accept: ["r√©cup√®re", "a r√©cup√©r√©", "r√©cup√©rait"] },
      { gap: 9, accept: ["comprend", "a compris", "comprenait"] },
      { gap:10, accept: ["sert", "a servi", "servait"] }
    ]
  },

  {
    type: "numbers",
    id: "S3-N1",
    title: "Section 3 ‚Äî Numbers (20 marks)",
    theme: "Theme 1 ‚Äî Core language",
    prompt: "Write these numbers in French words: 70, 80, 90. Accents and hyphens matter.",
    marking: "70 = 7 marks, 80 = 7 marks, 90 = 6 marks. Minor hyphen/spelling errors: -1 each if meaning still clear.",
    answers: [
      { number: 70, correct: ["soixante-dix"] },
      { number: 80, correct: ["quatre-vingts"] },
      { number: 90, correct: ["quatre-vingt-dix"] }
    ]
  }
];

/* -----------------------------
   Utilities
--------------------------------*/
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function nowISO(){ return new Date().toISOString(); }

function norm(s){
  return (s ?? "")
    .toString()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function hasPassage(selection, id){
  return !!selection?.passages?.some(p => p.id === id);
}

function pickRandom(arr, n){
  return shuffle(arr).slice(0, n);
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function otonoLetterGrade(score){
  if(score >= 101) return "S";
  if(score >= 95) return "A*";
  if(score >= 90) return "A";
  if(score >= 80) return "B";
  if(score >= 70) return "C";
  if(score >= 66) return "D";
  if(score >= 55) return "E";
  if(score >= 45) return "F";
  if(score >= 30) return "G";
  if(score >= 15) return "H";
  return "U";
}

function passMeritDistinction(score){
  if(score >= 90) return "DISTINCTION";
  if(score >= 80) return "MERIT";
  if(score >= 66) return "PASS";
  return "FAIL";
}

function gcseEstimate(score){
  if(score >= 90) return 9;
  if(score >= 80) return 8;
  if(score >= 70) return 7;
  if(score >= 60) return 6;
  if(score >= 50) return 5;
  if(score >= 40) return 4;
  if(score >= 30) return 3;
  if(score >= 20) return 2;
  if(score >= 10) return 1;
  return "U";
}

function badgeForScore(score){
  if(score >= 101) return ["badge good","üèÜ SECRET SCORE"];
  if(score >= 90) return ["badge good","üèÜ DISTINCTION"];
  if(score >= 80) return ["badge good","‚≠ê MERIT"];
  if(score >= 66) return ["badge warn","‚úÖ PASS"];
  return ["badge bad","‚ùå FAIL"];
}

/* -----------------------------
   Local storage
--------------------------------*/
const STORE_KEY = "otonoFrenchReadingSAM_set1_results_v2";

function loadResults(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveResults(list){
  localStorage.setItem(STORE_KEY, JSON.stringify(list));
}
function addResult(attempt){
  const list = loadResults();
  list.unshift(attempt);
  saveResults(list);
}

/* -----------------------------
   App state
--------------------------------*/
let state = {
  mode: "home",
  timer: null,
  remainingSec: 0,
  startedAt: null,

  centreNo: "50749",

  candidateNo: null,         // 4 digits
  candSurname: "",
  candForenames: "",

  selection: null,
  answers: {},               // qid -> user answer (string)
  mcqCorrectValue: {},       // qid -> correct radio value after shuffling
  submitted: false
};

/* -----------------------------
   Centre number controls
--------------------------------*/
function setCentre(no){
  state.centreNo = String(no);
  $("#centreNo").value = state.centreNo;
  $("#centreTop").textContent = state.centreNo;
}

$("#btnEditCentre").addEventListener("click", () => {
  const val = prompt("Enter centre number (digits only, e.g. 50749):", state.centreNo);
  if(val === null) return;
  const clean = String(val).replace(/\D/g,"").slice(0, 10);
  if(clean.length < 5){
    alert("Centre number must be digits only (at least 5 digits).");
    return;
  }
  setCentre(clean);
});

$("#btnResetCentre").addEventListener("click", () => setCentre("50749"));

/* -----------------------------
   Candidate number 4 squares
--------------------------------*/
const digitIds = ["#candD1","#candD2","#candD3","#candD4"];

function getCandidateNoFromSquares(){
  const d = digitIds.map(id => ($(id).value || "").trim());
  if(d.some(x => x.length !== 1 || !/^\d$/.test(x))) return "";
  return d.join("");
}

function focusDigit(i){
  const el = $(digitIds[i]);
  if(el) el.focus();
}

function wireDigitSquares(){
  digitIds.forEach((id, idx) => {
    const el = $(id);

    el.addEventListener("input", () => {
      // keep digits only
      el.value = (el.value || "").replace(/\D/g,"").slice(0,1);
      if(el.value && idx < digitIds.length-1) focusDigit(idx+1);
    });

    el.addEventListener("keydown", (e) => {
      if(e.key === "Backspace" && !el.value && idx > 0){
        focusDigit(idx-1);
      }
      if(e.key === "ArrowLeft" && idx > 0){
        e.preventDefault(); focusDigit(idx-1);
      }
      if(e.key === "ArrowRight" && idx < digitIds.length-1){
        e.preventDefault(); focusDigit(idx+1);
      }
    });

    el.addEventListener("paste", (e) => {
      e.preventDefault();
      const txt = (e.clipboardData || window.clipboardData).getData("text") || "";
      const digits = txt.replace(/\D/g,"").slice(0,4).split("");
      digits.forEach((ch, j) => {
        const target = $(digitIds[j]);
        if(target) target.value = ch;
      });
      // focus next empty
      const joined = getCandidateNoFromSquares();
      if(joined.length === 4) focusDigit(3);
      else{
        const firstEmpty = digitIds.findIndex(did => !$(did).value);
        if(firstEmpty >= 0) focusDigit(firstEmpty);
      }
    });
  });
}
wireDigitSquares();

/* -----------------------------
   Build paper (4 passages + 1 translation)
--------------------------------*/
function generateSelection(){
  const passages = pickRandom(PASSAGES, 4);
  const section3 = pickRandom(TRANSLATIONS, 1)[0];
  return { passages, section3 };
}
function selectionSummary(sel){
  const p = sel.passages.map(x=>`#${x.id}`).join(", ");
  return `Passages: ${p} ‚Ä¢ Section 3: ${sel.section3.id}`;
}

/* -----------------------------
   Rendering
--------------------------------*/
function setBadge(text, cls="badge"){
  const b = $("#statusBadge");
  b.className = cls;
  b.textContent = text;
}

function renderHome(){
  $("#homeBody").classList.remove("hide");
  $("#testBody").classList.add("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideTitle").textContent = "Otono grading";
  $("#sideMeta").textContent = "Score ‚Üí Otono grade + GCSE estimate + Pass/Merit/Distinction.";
  $("#sideBody").classList.remove("hide");
  setBadge("Ready","badge");
  $("#timerText").textContent = "--:--";
}

function renderResults(){
  $("#homeBody").classList.add("hide");
  $("#testBody").classList.add("hide");
  $("#sideBody").classList.add("hide");
  $("#resultsBody").classList.remove("hide");
  $("#sideTitle").textContent = "Saved results";
  $("#sideMeta").textContent = "Stored per candidate in this browser (localStorage).";
  setBadge("Results","badge");
  $("#timerText").textContent = "--:--";
  drawResults();
}

function stopTimer(){
  if(state.timer){
    clearInterval(state.timer);
    state.timer = null;
  }
}

function startTimer(minutes){
  stopTimer();
  state.remainingSec = Math.max(1, Math.floor(minutes*60));
  state.startedAt = Date.now();

  const tick = () => {
    if(state.submitted) return;
    const m = Math.floor(state.remainingSec/60);
    const s = state.remainingSec%60;
    $("#timerText").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    state.remainingSec--;
    if(state.remainingSec < 0){
      stopTimer();
      const auto = $("#autoSubmit").value === "yes";
      if(auto) submitPaper(true);
      else alert("Time is up. You can still submit manually.");
    }
  };

  tick();
  state.timer = setInterval(tick, 1000);
}

function renderTest(){
  $("#homeBody").classList.add("hide");
  $("#testBody").classList.remove("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideBody").classList.remove("hide");

  const candNameLine = [
    state.candSurname ? state.candSurname : "",
    state.candForenames ? state.candForenames : ""
  ].filter(Boolean).join(", ");

  const cand = `${state.candidateNo}${candNameLine ? " ‚Ä¢ " + candNameLine : ""}`;
  $("#kpiCandidate").textContent = cand;
  $("#kpiPassages").textContent = state.selection.passages.map(p=>`#${p.id}`).join(" ");
  $("#kpiTranslation").textContent = state.selection.section3.id;

  const shuffleMode = $("#shuffleMode").value;
  const paper = $("#paper");
  paper.innerHTML = "";

  // reset per-paper MCQ mapping
  state.mcqCorrectValue = {};

  const sel = state.selection;
  const themes = sel.passages.map(p => `${p.title} (${p.theme}, ${p.unit})`);
  const head = document.createElement("div");
  head.className = "note";
  head.innerHTML = `<strong>Selected content</strong><br/>` +
    themes.map(t => `‚Ä¢ ${escapeHtml(t)}`).join("<br/>") +
    `<br/>‚Ä¢ ${escapeHtml(sel.translation.title)} (${escapeHtml(sel.translation.theme)})`;
  paper.appendChild(head);

  let allBlocks = [];

  sel.passages.forEach(p => {
    const block = document.createElement("div");
    block.className = "card";
    block.style.marginTop = "14px";

    block.innerHTML = `
      <div class="hd">
        <div>
          <h2>${escapeHtml(p.title)}</h2>
          <div class="meta">${escapeHtml(p.theme)} ‚Ä¢ ${escapeHtml(p.unit)} ‚Ä¢ <strong>20 marks</strong></div>
        </div>
        <span class="badge">${escapeHtml("#"+p.id)}</span>
      </div>
      <div class="bd">
        <div class="passage">${escapeHtml(p.text).replace(/\n/g,"<br/>")}</div>
        <div class="divider"></div>
        <div class="small">MCQ/choice options are always shuffled. Written answers are auto-marked using keyword coverage.</div>
        <div class="qs"></div>
      </div>
    `;

    const qs = block.querySelector(".qs");
    let qsList = p.questions.slice();
    if(shuffleMode === "shuffleAll") qsList = shuffle(qsList);

    qsList.forEach(q => {
      const qWrap = document.createElement("div");
      qWrap.className = "q";
      qWrap.dataset.qid = q.id;

      const markTag = `<span class="badge" title="Marks for this question">${q.marks} marks</span>`;
      const instruction = (q.type === "fr_short")
        ? "Answer in French. Auto-mark uses keywords."
        : (["mcq","pn","tfnm"].includes(q.type) ? "Select one option." : "Auto-mark uses keywords. Write concise, direct answers.");

      qWrap.innerHTML = `
        <h3>${escapeHtml(q.prompt)} ${markTag}</h3>
        ${renderQuestion(q)}
        <div class="small" style="margin-top:8px">${escapeHtml(instruction)}</div>
      `;
      qs.appendChild(qWrap);
    });

    allBlocks.push(block);
  });

  // Translation block
  const t = sel.translation;
  const tBlock = document.createElement("div");
  tBlock.className = "card";
  tBlock.style.marginTop = "14px";
  tBlock.innerHTML = `
    <div class="hd">
      <div>
        <h2>${escapeHtml(t.title)}</h2>
        <div class="meta">${escapeHtml(t.theme)} ‚Ä¢ <strong>20 marks</strong></div>
      </div>
      <span class="badge">TRANSLATION</span>
    </div>
    <div class="bd">
      <div class="passage">${escapeHtml(t.text)}</div>
      <div class="divider"></div>
      <div class="q" data-qid="translation">
        <h3>Translate into French (write naturally). <span class="badge">20 marks</span></h3>
        <textarea id="ans_translation" placeholder="Type your French translation here..."></textarea>
        <div class="small" style="margin-top:8px">Auto-mark checks key ideas. It‚Äôs strict: include the meaning clearly.</div>
      </div>
    </div>
  `;
  allBlocks.push(tBlock);

  allBlocks.forEach(b => paper.appendChild(b));

  bindInputs();

  const mins = parseInt($("#timeAllowed").value,10);
  startTimer(mins);
  state.submitted = false;

  $("#markingBox").classList.add("hide");
  $("#markingBox").innerHTML = "";
  setBadge("In progress","badge warn");
}

function renderQuestion(q){
  if(q.type === "mcq"){
    const opts = q.options.map((text, idx) => ({ text, isCorrect: idx === q.answerIndex }));
    return renderChoice(q, opts);
  }
  if(q.type === "pn"){
  const key = q.correct ?? q.answer; // ‚úÖ supports both
  const opts = [
    { text:"P", isCorrect: key === "P" },
    { text:"N", isCorrect: key === "N" },
    { text:"P+N", isCorrect: key === "P+N" }
  ];
  return renderChoice(q, opts);
}
  if(q.type === "tfnm"){
    const opts = [
      { text:"True", isCorrect: q.correct === "True" },
      { text:"False", isCorrect: q.correct === "False" },
      { text:"Not mentioned", isCorrect: q.correct === "Not mentioned" }
    ];
    return renderChoice(q, opts);
  }
  // short / fr_short
  return `<textarea id="ans_${q.id}" placeholder="${q.type === "fr_short" ? "R√©ponds en fran√ßais..." : "Write your answer here..."}"></textarea>`;
}

function renderChoice(q, optionObjects){
  const name = `ans_${q.id}`;

  // ALWAYS shuffle choice options
  const shuffled = shuffle(optionObjects);

  // store which radio value is correct after shuffle
  // value = index in shuffled array
  const correctIndex = shuffled.findIndex(o => o.isCorrect);
  state.mcqCorrectValue[q.id] = String(correctIndex);

  return `
    <div class="opts">
      ${shuffled.map((opt, idx) => `
        <label class="opt">
          <input type="radio" name="${name}" value="${idx}" />
          <div><div><strong>${String.fromCharCode(65+idx)}.</strong> ${escapeHtml(opt.text)}</div></div>
        </label>
      `).join("")}
    </div>
  `;
}

function bindInputs(){
  $$("input[type='radio']").forEach(r => {
    r.addEventListener("change", () => {
      const qid = r.name.replace("ans_","");
      state.answers[qid] = r.value;
    });
  });
  $$("textarea").forEach(t => {
    t.addEventListener("input", () => {
      const id = t.id.replace("ans_","");
      state.answers[id] = t.value;
    });
  });
}

/* -----------------------------
   Auto marking
--------------------------------*/
function markShortAnswer(q, userText){
  const t = norm(userText);
  if(!t) return {score:0, max:q.marks, detail:"Blank answer."};

  const groups = q.keywords || [];
  if(groups.length === 0) return {score:0, max:q.marks, detail:"No keyword rubric set."};

  let hits = 0;
  groups.forEach(g => {
    const found = g.some(k => t.includes(norm(k)));
    if(found) hits++;
  });

  const per = q.marks / groups.length;
  const raw = hits * per;
  const score = Math.max(0, Math.min(q.marks, Math.round(raw*2)/2));

  let detail = `Keyword groups matched: ${hits}/${groups.length}.`;
  if(q.rubric) detail += ` Expected: ${q.rubric}`;
  return {score, max:q.marks, detail};
}

function markChoice(qid, chosenValue, marks){
  const correctValue = state.mcqCorrectValue[qid];
  const ok = String(chosenValue ?? "") === String(correctValue);
  return {
    score: ok ? marks : 0,
    max: marks,
    detail: ok ? "Correct." : "Incorrect."
  };
}

function markTranslation(tObj, userText){
  const t = norm(userText);
  if(!t) return {score:0, max:20, detail:"Blank translation."};

  let hits = 0;
  const ideas = tObj.keyIdeas || [];
  ideas.forEach(group => {
    const ok = group.some(k => t.includes(norm(k)));
    if(ok) hits++;
  });

  // 5 ideas √ó 4 marks
  const score = Math.min(20, hits * 4);
  const detail = `Key ideas matched: ${hits}/${ideas.length}. (4 marks each)`;
  return {score, max:20, detail};
}

function computeTotal(){
  let total = 0;
  let breakdown = [];

  state.selection.passages.forEach(p => {
    p.questions.forEach(q => {
      const ans = state.answers[q.id];
      let res;

      if(["mcq","pn","tfnm"].includes(q.type)){
        res = markChoice(q.id, ans, q.marks);
      }else{
        res = markShortAnswer(q, ans);
      }

      total += res.score;
      breakdown.push({
        qid: q.id,
        passageId: p.id,
        type: q.type,
        prompt: q.prompt,
        score: res.score,
        max: res.max,
        detail: res.detail
      });
    });
  });

  const tAns = state.answers["translation"] ?? $("#ans_translation")?.value ?? "";
  const tRes = markTranslation(state.selection.translation, tAns);
  total += tRes.score;
  breakdown.push({
    qid: "translation",
    passageId: "translation",
    type: "translation",
    prompt: "Translate into French",
    score: tRes.score,
    max: tRes.max,
    detail: tRes.detail
  });

   const totalRounded = Math.round(total*10)/10;

  // ‚úÖ Secret S unlock: perfect paper + Passage 11 selected = +1 bonus
  let finalTotal = totalRounded;
  const unlockS = (finalTotal === 100) && hasPassage(state.selection, 11);

  if(unlockS){
    finalTotal = 101;
    breakdown.push({
      qid: "bonus_s",
      passageId: 11,
      type: "bonus",
      prompt: "Secret bonus: perfect paper + Passage 11 selected",
      score: 1,
      max: 1,
      detail: "Unlocked Grade S bonus (+1)."
    });
  }

  // keep 'max' as 100 (base marks), bonus sits on top
  return { total: finalTotal, max: 100, breakdown };
}

/* -----------------------------
   Submission + saving
--------------------------------*/
function submitPaper(fromAutoTimer=false){
  if(state.submitted) return;

let { total, max, breakdown } = computeTotal();

// Secret S bonus: only if perfect 100 AND Passage 11 selected
const unlockS = (total === 100) && hasPassage(state.selection, 11);
if (unlockS) {
  total = 101;
  breakdown.push({
    qid: "bonus_s",
    passageId: 11,
    type: "bonus",
    prompt: "Secret bonus: perfect paper + Passage 11 selected",
    score: 1,
    max: 1,
    detail: "Unlocked Grade S bonus (+1)."
  });
}

  state.submitted = true;
  stopTimer();

  const letter = otonoLetterGrade(total);
  const pmd = passMeritDistinction(total);
  const gcse = gcseEstimate(total);
  const [badgeCls, badgeText] = badgeForScore(total);

  const attempt = {
    paper: "Otono French Reading (SAM) ‚Ä¢ Sample set 2",
    centre: state.centreNo,
    candidateNo: String(state.candidateNo),
    candidateSurname: state.candSurname || "",
    candidateForenames: state.candForenames || "",
    submittedAt: nowISO(),
    timeAllowedMin: parseInt($("#timeAllowed").value,10),
    selectedPassages: state.selection.passages.map(p=>p.id),
    selectedTranslation: state.selection.translation.id,
    score: total,
    maxScore: max,
    otonoGrade: letter,
    gcseEstimated: gcse,
    outcome: pmd,
    breakdown
  };
  addResult(attempt);

  const nameLine = [attempt.candidateSurname, attempt.candidateForenames].filter(Boolean).join(", ");

  const box = $("#markingBox");
  box.classList.remove("hide");
  box.className = "";
  box.innerHTML = `
    <div class="card">
      <div class="hd">
        <div>
          <h2>‚úÖ Marked${fromAutoTimer ? " (auto-submitted)" : ""}</h2>
          <div class="meta">Saved to Results ‚Ä¢ Centre ${escapeHtml(attempt.centre)} ‚Ä¢ Candidate ${escapeHtml(attempt.candidateNo)}${nameLine ? " ‚Ä¢ " + escapeHtml(nameLine) : ""}</div>
        </div>
        <span class="${badgeCls}">${escapeHtml(badgeText)}</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box"><div class="t">Score</div><div class="v">${attempt.score} / ${attempt.maxScore}</div></div>
          <div class="box"><div class="t">Otono grade</div><div class="v">${escapeHtml(attempt.otonoGrade)}</div></div>
          <div class="box"><div class="t">GCSE estimate</div><div class="v">${escapeHtml(String(attempt.gcseEstimated))}</div></div>
          <div class="box"><div class="t">Outcome</div><div class="v">${escapeHtml(attempt.outcome)}</div></div>
        </div>

        <div class="divider"></div>

        <div class="note">
          <strong>Marking notes</strong><br/>
          ‚Ä¢ MCQ / P-N / TFNM are exact (options are shuffled).<br/>
          ‚Ä¢ Written + translation are keyword-based. If you used very different wording, it may under-mark.
        </div>

        <div class="divider"></div>

        <button class="btn" id="btnShowBreakdown">Show question breakdown</button>
        <div id="breakdown" class="hide" style="margin-top:12px"></div>

        <div class="divider"></div>

        <div class="note">
          <strong>Translation model answer (for reference)</strong><br/>
          ${escapeHtml(state.selection.translation.sampleAnswer)}
        </div>
      </div>
    </div>
  `;

  $("#btnShowBreakdown").addEventListener("click", () => {
    const bd = $("#breakdown");
    bd.classList.toggle("hide");
    if(!bd.classList.contains("hide")){
      bd.innerHTML = breakdown.map(b => `
        <div class="attempt">
          <div class="top">
            <div><strong>${escapeHtml(b.qid)}</strong> ‚Ä¢ ${escapeHtml(String(b.type))}</div>
            <div><span class="badge">${b.score} / ${b.max}</span></div>
          </div>
          <div class="meta">
            <div><strong>Prompt:</strong> ${escapeHtml(b.prompt)}</div>
            <div><strong>Marker:</strong> ${escapeHtml(b.detail)}</div>
          </div>
        </div>
      `).join("");
    }
  });

  setBadge("Submitted","badge good");
}

/* -----------------------------
   Results UI
--------------------------------*/
function drawResults(){
  const listEl = $("#resultsList");
  const all = loadResults();
  const filter = ($("#filterCandidate").value || "").replace(/\D/g,"").slice(0,4);

  const filtered = filter ? all.filter(a => String(a.candidateNo) === String(filter)) : all;

  if(filtered.length === 0){
    listEl.innerHTML = `<div class="note">No stored attempts${filter ? " for this candidate" : ""} yet.</div>`;
    return;
  }

  listEl.innerHTML = filtered.map(a => {
    const [cls, txt] = badgeForScore(a.score);
    const nameLine = [a.candidateSurname, a.candidateForenames].filter(Boolean).join(", ");
    return `
      <div class="attempt">
        <div class="top">
          <div>
            <strong>${escapeHtml(a.candidateNo)}</strong>${nameLine ? " ‚Ä¢ " + escapeHtml(nameLine) : ""}
            <span class="badge" style="margin-left:8px">Centre ${escapeHtml(a.centre)}</span>
          </div>
          <div class="${cls}">${escapeHtml(txt)} ‚Ä¢ ${escapeHtml(String(a.score))}/100</div>
        </div>
        <div class="meta">
          <div><strong>Date:</strong> ${escapeHtml(new Date(a.submittedAt).toLocaleString())}</div>
          <div><strong>Selection:</strong> Passages ${escapeHtml(a.selectedPassages.join(", "))} ‚Ä¢ Translation ${escapeHtml(a.selectedTranslation)}</div>
          <div><strong>Grades:</strong> Otono ${escapeHtml(a.otonoGrade)} ‚Ä¢ GCSE ${escapeHtml(String(a.gcseEstimated))} ‚Ä¢ ${escapeHtml(a.outcome)}</div>
        </div>
      </div>
    `;
  }).join("");
}

function exportResults(){
  const all = loadResults();
  $("#exportText").textContent = JSON.stringify(all, null, 2);
  $("#exportBox").classList.remove("hide");
}

function clearResults(){
  if(!confirm("Clear ALL stored Otono French results on this browser?")) return;
  localStorage.removeItem(STORE_KEY);
  drawResults();
  $("#exportBox").classList.add("hide");
}

/* -----------------------------
   Buttons / navigation
--------------------------------*/
$("#btnHome").addEventListener("click", () => {
  state.mode = "home";
  renderHome();
});

$("#btnResults").addEventListener("click", () => {
  state.mode = "results";
  renderResults();
});

$("#btnPreview").addEventListener("click", () => {
  const c = getCandidateNoFromSquares();
  if(!c){
    alert("Enter a candidate number first.");
    return;
  }
  const sel = generateSelection();
  const box = $("#previewBox");
  box.classList.remove("hide");
  box.innerHTML = `<strong>Preview (not started):</strong><br/>${escapeHtml(selectionSummary(sel))}<br/>` +
    sel.passages.map(p => `‚Ä¢ ${escapeHtml(p.title)} (${escapeHtml(p.theme)})`).join("<br/>") +
    `<br/>‚Ä¢ ${escapeHtml(sel.translation.title)} (${escapeHtml(sel.translation.theme)})`;
});

$("#btnStart").addEventListener("click", () => {
  const c = getCandidateNoFromSquares();
  if(!c){
    alert("Candidate number is required.");
    focusDigit(0);
    return;
  }

  state.candidateNo = c;
  state.candSurname = ($("#candSurname").value || "").trim();
  state.candForenames = ($("#candForenames").value || "").trim();

  state.selection = generateSelection();
  state.answers = {};
  renderTest();
});

$("#btnSubmit").addEventListener("click", () => submitPaper(false));

$("#btnReset").addEventListener("click", () => {
  if(!confirm("Reset this paper and generate a NEW random test? Your current answers will be lost.")) return;
  stopTimer();
  state.answers = {};
  state.submitted = false;
  state.selection = generateSelection();
  renderTest();
});

/* Results filters & tabs */
$("#filterCandidate").addEventListener("input", (e) => {
  e.target.value = e.target.value.replace(/\D/g,"").slice(0,4);
  drawResults();
});

$("#tabAll").addEventListener("click", () => {
  $("#tabAll").classList.add("active");
  $("#tabCandidate").classList.remove("active");
  $("#filterCandidate").value = "";
  drawResults();
});

$("#tabCandidate").addEventListener("click", () => {
  $("#tabCandidate").classList.add("active");
  $("#tabAll").classList.remove("active");
  $("#filterCandidate").focus();
});

$("#btnExport").addEventListener("click", exportResults);
$("#btnClear").addEventListener("click", clearResults);

/* Initial */
setCentre("50749");
renderHome();

/* -----------------------------
   Anti-cheat / source protection
   (as requested)
--------------------------------*/
const disabledKeys = ["u", "I"];
const showAlert = e => {
  e.preventDefault();
  return alert("Hahaha, I challenge you, valiant soldier, to uproot the source codes yourself!!!");
};
document.addEventListener("contextmenu", e => { showAlert(e); });
document.addEventListener("keydown", e => {
  if ((e.ctrlKey && disabledKeys.includes(e.key)) || e.key === "F12") {
    showAlert(e);
  }
});
</script>

</body>
</html>
