<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üü£ Otono Spanish ‚Äî Paper 3 (Writing, Randomised, Auto Marking)</title>
  <style>
    :root{
      --bg1:#2b0a3d; --bg2:#7a0036;
      --card:#0f0b18cc; --card2:#120c22e6;
      --text:#f4efff; --muted:#c9b9ff;
      --accent:#b000ff; --accent2:#ff1b6a;
      --good:#19ff9a; --warn:#ffd166; --bad:#ff4d6d;
      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(176,0,255,.22), transparent 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(255,27,106,.18), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:22px;}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:sticky; top:14px; z-index:20; backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0; font-size:16px; letter-spacing:.3px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.25); font-family:var(--mono); font-size:12px;
      display:flex; gap:10px; align-items:center;
    }
    .pill strong{color:#fff}
    .btn{
      border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(0,0,0,.33); border-color:rgba(255,255,255,.22)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(176,0,255,.55), rgba(255,27,106,.45));
      border-color:rgba(255,255,255,.22);
    }
    .btn.danger{background:rgba(255,77,109,.18); border-color:rgba(255,77,109,.35)}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .topbar{position:static} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .hd .meta{font-size:12px; color:var(--muted); line-height:1.25}
    .card .bd{padding:16px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; border:1px solid var(--line); background:rgba(0,0,0,.25);
      color:var(--text); padding:10px 12px; border-radius:14px; outline:none;
      font-family:var(--sans);
    }
    textarea{min-height:110px; resize:vertical; line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > div{flex:1 1 180px}
    .note{
      font-size:12px; color:var(--muted); line-height:1.4;
      padding:10px 12px; border-radius:14px; border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
    }
    .badge{
      font-family:var(--mono); font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.20);
      display:inline-flex; align-items:center; gap:6px;
    }
    .badge.good{border-color:rgba(25,255,154,.35); background:rgba(25,255,154,.12)}
    .badge.warn{border-color:rgba(255,209,102,.35); background:rgba(255,209,102,.12)}
    .badge.bad{border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.12)}
    .divider{height:1px; background:var(--line); margin:14px 0}
    .task{
      padding:12px 14px; border:1px solid var(--line); border-radius:16px;
      background:rgba(0,0,0,.22);
    }
    .task h3{margin:0 0 8px; font-size:13px}
    .bullets{margin:10px 0 0; padding-left:18px; color:var(--muted); font-size:12px}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 980px){ .kpi{grid-template-columns:repeat(2,1fr)} }
    .kpi .box{
      border:1px solid var(--line); border-radius:16px; padding:10px 12px;
      background:rgba(0,0,0,.22);
    }
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .kpi .box .v{font-size:18px; font-weight:800; margin-top:4px}
    .small{font-size:12px; color:var(--muted)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:rgba(0,0,0,.22); cursor:pointer; font-weight:700}
    .tab.active{background:linear-gradient(135deg, rgba(176,0,255,.35), rgba(255,27,106,.22)); border-color:rgba(255,255,255,.22)}
    .resultsList{display:grid; gap:10px}
    .attempt{
      border:1px solid var(--line); border-radius:16px; padding:12px 14px;
      background:rgba(0,0,0,.20);
    }
    .attempt .top{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .attempt .top strong{font-family:var(--mono)}
    .attempt .meta{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.4}
    .copy{font-family:var(--mono); font-size:12px; white-space:pre-wrap; word-break:break-word}
    .hide{display:none !important}
    .mcChoice{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      padding:10px 12px; border-radius:14px; margin-top:8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>üü£ Otono Spanish ‚Äî Paper 3 (Writing, Randomised)</h1>
        <div class="sub">Auto marking (meaning + quality + structure) ‚Ä¢ Centre: <strong>50749</strong> ‚Ä¢ Pass/Merit/Distinction is independent of 9‚Äì1</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">
        <div class="pill">
          <span>‚è±Ô∏è Timer:</span>
          <strong id="timerText">--:--</strong>
        </div>
        <button class="btn" id="btnResults">Results</button>
        <button class="btn primary" id="btnHome">Test</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card" id="panelHome">
        <div class="hd">
          <div>
            <h2>Candidate setup</h2>
            <div class="meta">
              Sensible integer marking:
              Translation = ideas + Spanish quality; Writing = content + timeframes + opinion + range + word count + soft relevance multiplier.
            </div>
          </div>
          <span class="badge" id="statusBadge">Ready</span>
        </div>

        <div class="bd" id="homeBody">
          <div class="row">
            <div>
              <label>Centre number (fixed)</label>
              <input type="text" value="50749" disabled />
            </div>
            <div>
              <label>Candidate number (required)</label>
              <input type="number" id="candidateNo" placeholder="e.g. 1105" min="1" />
            </div>
            <div>
              <label>Candidate name (optional)</label>
              <input type="text" id="candidateName" placeholder="Name" />
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <div>
              <label>Tier</label>
              <select id="tier">
                <option value="foundation">Foundation Tier (grade 1‚Äì5, capped)</option>
                <option value="higher">Higher Tier (grade 4‚Äì9, allow 3)</option>
              </select>
            </div>

            <div>
              <label>Time allowed</label>
              <select id="timeAllowed"></select>
              <div class="small" id="timeNote" style="margin-top:6px"></div>
            </div>

            <div>
              <label>On timer end</label>
              <select id="autoSubmit">
                <option value="yes" selected>Auto-submit</option>
                <option value="no">Do not auto-submit</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>How marking works (so cheating doesn‚Äôt work):</strong><br/>
            ‚Ä¢ Marks come from <strong>covering the bullet points</strong> + showing <strong>past/present/future</strong> + giving an <strong>opinion</strong> + using <strong>theme vocabulary</strong>.<br/>
            ‚Ä¢ Writing something random like ‚ÄúUsa tinta negra‚Äù is <strong>irrelevant</strong> and will score ~0 unless the task is actually about ink and you cover the required points.<br/>
            ‚Ä¢ Auto marking cannot truly judge ‚Äúbeauty‚Äù of Spanish, but it enforces structure and relevance.
          </div>

          <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap">
            <button class="btn" id="btnPreview">Preview random selection</button>
            <button class="btn primary" id="btnStart">Start random paper</button>
          </div>

          <div id="previewBox" class="note hide" style="margin-top:12px"></div>
        </div>

        <!-- Test -->
        <div class="bd hide" id="testBody">
          <div class="kpi">
            <div class="box"><div class="t">Candidate</div><div class="v" id="kpiCandidate">‚Äî</div></div>
            <div class="box"><div class="t">Tier</div><div class="v" id="kpiTier">‚Äî</div></div>
            <div class="box"><div class="t">Max score</div><div class="v" id="kpiMax">‚Äî</div></div>
            <div class="box"><div class="t">Theme 4?</div><div class="v" id="kpiTheme4">‚Äî</div></div>
          </div>

          <div class="divider"></div>

          <div class="note" id="paperInfo"></div>

          <div id="paper"></div>

          <div class="divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btnSubmit">Submit & Auto-Mark</button>
            <button class="btn" id="btnReset">Reset (new random paper)</button>
          </div>

          <div id="markingBox" class="hide" style="margin-top:14px"></div>
        </div>
      </div>

      <!-- Right: grading + results -->
      <div class="card" id="panelSide">
        <div class="hd">
          <div>
            <h2 id="sideTitle">Grading rules</h2>
            <div class="meta" id="sideMeta">Pass/Merit/Distinction stays the same regardless of 9‚Äì1 grade.</div>
          </div>
        </div>

        <div class="bd" id="sideBody">
          <div class="note">
            <strong>Pass/Merit/Distinction (always)</strong><br/>
            PASS: 66+<br/>
            MERIT: 80+<br/>
            DISTINCTION: 90+<br/>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>9‚Äì1 system</strong><br/>
            Higher tier: grade 4‚Äì9 (allowed grade 3)<br/>
            Foundation tier: grade 1‚Äì5 (capped)<br/>
          </div>

          <div class="divider"></div>

          <div class="note">
            <strong>A‚ÄìH system (CHANGED boundaries)</strong><br/>
            <u>Higher tier</u> (A*‚ÄìE + allowed F; no G/H):<br/>
            A*: 95+ ‚Ä¢ A: 90+ B: 80+ ‚Ä¢ C: 66+ ‚Ä¢ D: 55+ ‚Ä¢ E: 45+ ‚Ä¢ F: 40+ ‚Ä¢ below 40 = U<br/><br/>
            <u>Foundation tier</u> (capped at C; G/H appear):<br/>
            C: 75+ ‚Ä¢ D: 66+ ‚Ä¢ E: 50+ ‚Ä¢ F: 40+ ‚Ä¢ G: 30+ ‚Ä¢ H: 20+ ‚Ä¢ below 20 = U
          </div>

          <div class="divider"></div>
          <div class="small">
            Results are saved locally on this browser (localStorage).
          </div>
        </div>

        <!-- Results panel -->
        <div class="bd hide" id="resultsBody">
          <div class="tabs">
            <div class="tab active" id="tabAll">All attempts</div>
            <div class="tab" id="tabCandidate">By candidate</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Filter candidate number</label>
              <input type="number" id="filterCandidate" placeholder="e.g. 6427" min="1" />
            </div>
            <div>
              <label>Actions</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" id="btnExport">Export JSON</button>
                <button class="btn danger" id="btnClear">Clear stored results</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="resultsList" id="resultsList"></div>

          <div id="exportBox" class="note hide" style="margin-top:12px">
            <div><strong>Exported JSON</strong> (copy/save it):</div>
            <div class="divider"></div>
            <div class="copy" id="exportText"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   HELPERS
========================================================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function escapeHtml(str){
  return (str ?? "").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function nowISO(){ return new Date().toISOString(); }
function norm(s){
  return (s ?? "")
    .toString().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ").trim();
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function pickRandom(arr, n){ return shuffle(arr).slice(0,n); }
function wordCount(text){
  const t = (text ?? "").trim();
  if(!t) return 0;
  return t.split(/\s+/).filter(Boolean).length;
}
function setBadge(text, cls="badge"){ const b=$("#statusBadge"); b.className=cls; b.textContent=text; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

/* =========================================================
   TIMER
========================================================= */
let timer = null;
let remainingSec = 0;

function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function startTimer(minutes, onEnd){
  stopTimer();
  remainingSec = Math.max(1, Math.floor(minutes*60));
  const tick = () => {
    const m = Math.floor(remainingSec/60);
    const s = remainingSec%60;
    $("#timerText").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    remainingSec--;
    if(remainingSec < 0){
      stopTimer();
      onEnd?.();
    }
  };
  tick();
  timer = setInterval(tick, 1000);
}

/* =========================================================
   STORAGE
========================================================= */
const STORE_KEY = "otonoSpanishWritingResults_v2_sensible";
function loadResults(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveResults(list){ localStorage.setItem(STORE_KEY, JSON.stringify(list)); }
function addResult(attempt){
  const list = loadResults();
  list.unshift(attempt);
  saveResults(list);
}

/* =========================================================
   GRADING
========================================================= */
function passMeritDistinction(score){
  if(score >= 90) return "DISTINCTION";
  if(score >= 80) return "MERIT";
  if(score >= 66) return "PASS";
  return "FAIL";
}
function grade9to1(score, tier){
  if(tier==="foundation"){
    if(score >= 90) return 5;
    if(score >= 80) return 5;
    if(score >= 70) return 4;
    if(score >= 60) return 4;
    if(score >= 50) return 3;
    if(score >= 40) return 2;
    if(score >= 20) return 1;
    return "U";
  }else{
    if(score >= 90) return 9;
    if(score >= 80) return 8;
    if(score >= 70) return 7;
    if(score >= 60) return 6;
    if(score >= 50) return 5;
    if(score >= 40) return 4;
    return 3;
  }
}
function gradeAH(score, tier){
  if(tier==="higher"){
    if(score >= 95) return "A";
    if(score >= 80) return "B";
    if(score >= 66) return "C";
    if(score >= 55) return "D";
    if(score >= 45) return "E";
    if(score >= 40) return "F";
    return "U";
  }else{
    if(score >= 75) return "D";
    if(score >= 66) return "E";
    if(score >= 50) return "F";
    if(score >= 35) return "G";
    if(score >= 20) return "H";
    return "U";
  }
}
function badgeForScore(score){
  if(score >= 90) return ["badge good","üèÜ DISTINCTION"];
  if(score >= 80) return ["badge good","‚≠ê MERIT"];
  if(score >= 66) return ["badge warn","‚úÖ PASS"];
  return ["badge bad","‚ùå FAIL"];
}

/* =========================================================
   QUESTION BANKS (SPANISH, slightly different & more ‚ÄúSpanish‚Äù)
========================================================= */

/* Theme vocabulary buckets for relevance checks (Spanish) */
const THEME_VOCAB = {
  t1: ["escuela","instituto","clase","clases","profesor","profe","examen","examenes","ex√°menes","regla","reglas","norma","normas","instrucciones","boligrafo","bol√≠grafo","tinta","negra","amarilla","vigilante","opcion","opci√≥n","gcse","mates","matematicas","matem√°ticas","ciencias","se√±or","senor","barley","director","uniforme"],
  t2: ["tiempo","libre","ocio","juego","juegos","gaming","minecraft","roblox","servidor","carrera","carreras","velocidad","musica","m√∫sica","piano","violin","viol√≠n","trompeta","region","regi√≥n","casa","habitacion","habitaci√≥n","piso","atico","√°tico","barrio","zona","parque"],
  t3: ["otono","airways","vuelo","vuelos","avion","avi√≥n","a380","cabina","asiento","clase","economica","econ√≥mica","business","primera","premium","lounge","salon","sal√≥n","mansion","mansi√≥n","habitaciones","residencia","pasillo","normas"],
  t4: ["clayton","puntuacion","puntuaci√≥n","perfecta","perfecto","160","mates","matematicas","matem√°ticas","adelantado","adelantada","antelacion","antelaci√≥n","presion","presi√≥n","comparacion","comparaci√≥n","envidia","admiracion","admiraci√≥n","reputacion","reputaci√≥n","progreso","perfeccion","perfecci√≥n"]
};

/* Detection phrases in Spanish */
const DETECT = {
  opinion: ["creo que","pienso que","en mi opinion","en mi opini√≥n","para mi","para m√≠","me parece","me gusta","me encanta","no me gusta","odio","prefiero","es importante","es mejor","es peor"],
  past: ["ayer","anteayer","la semana pasada","el ano pasado","el a√±o pasado","fui","estuve","hice","tuve","vi","jugu√©","jogue","practique","practiqu√©","estaba","era","me sent√≠","me senti","aprend√≠","aprendi"],
  present: ["hoy","ahora","normalmente","a menudo","siempre","generalmente","actualmente","estoy","tengo","hago","juego","vivo","voy a clase","voy al instituto","me siento"],
  future: ["manana","ma√±ana","la semana que viene","el proximo ano","el pr√≥ximo a√±o","el ano que viene","voy a","en el futuro","mas tarde","m√°s tarde","quiero","me gustaria","me gustar√≠a","har√©","hare","ser√°","sera","podr√©","podre","voy a intentar"]
};

/* Foundation translation: 5 sentences, 25 marks */
const FOUNDATION_TRANSLATION_POOL = [
  { en:"I like my school because the rules are clear.", esKeys:[["me gusta"],["mi escuela","mi instituto"],["porque"],["las reglas","las normas"],["claras","clara"]] },
  { en:"Yesterday, I revised for an exam in black ink.", esKeys:[["ayer"],["repas√©","repase","estudi√©","estudie"],["para"],["un examen"],["tinta negra","en negro"]] },
  { en:"My favourite teacher explains things calmly.", esKeys:[["mi profesor favorito","mi profe favorito"],["explica"],["con calma","tranquilamente"]] },
  { en:"Next year, I will choose Spanish as an option.", esKeys:[["el a√±o que viene","el ano que viene","el pr√≥ximo a√±o","el proximo ano"],["voy a elegir","elegir√©","elegire"],["espa√±ol","espanol"],["como opci√≥n","como opcion","de opci√≥n","de opcion"]] },
  { en:"In my opinion, exams are stressful but important.", esKeys:[["en mi opini√≥n","en mi opinion","creo que","pienso que"],["los ex√°menes","los examenes"],["estresantes","estresante"],["pero"],["importantes","importante"]] },
  { en:"At home, I play games after finishing my homework.", esKeys:[["en casa"],["juego"],["a videojuegos","a juegos","juegos"],["despu√©s","despues"],["los deberes","mis deberes"]] },
  { en:"The invigilator repeats the instructions before the exam.", esKeys:[["el vigilante","el supervisor"],["repite"],["las instrucciones"],["antes"],["del examen"]] },
  { en:"Luke uses black ink because he thinks it is serious.", esKeys:[["luke"],["usa"],["tinta negra","negro"],["porque"],["serio","es serio"]] }
];

/* Higher translation: 1 paragraph, 20 marks (ideas + quality) */
const HIGHER_TRANSLATION_POOL = [
  {
    id:"HT-A",
    en:`At Otono, students quickly learn that respecting rules is as important as knowledge. A small mistake, like using the wrong pen, can affect results. Good organisation reduces stress.`,
    keyIdeas: [
      ["en otono","en el otono","otono"],
      ["los alumnos","los estudiantes"],
      ["aprenden","aprendemos"],
      ["respetar las reglas","respetar las normas","el respeto de las reglas"],
      ["tan importante como","igual de importante que"],
      ["los conocimientos","el conocimiento"],
      ["un peque√±o error","un pequeno error"],
      ["bol√≠grafo incorrecto","boligrafo incorrecto","el bol√≠grafo equivocado","el boligrafo equivocado"],
      ["puede afectar","puede cambiar","puede influir"],
      ["la organizaci√≥n","la organizacion","reduce el estr√©s","reduce el estres","menos estr√©s","menos estres"]
    ]
  },
  {
    id:"HT-B",
    en:`Travelling with Otono Airways feels like a perfectly controlled system. Every detail is planned to guarantee comfort and efficiency, even in economy class.`,
    keyIdeas: [
      ["viajar","cuando viajas"],
      ["otono airways"],
      ["se siente como","parece","da la impresi√≥n","da la impresion"],
      ["un sistema"],
      ["perfectamente controlado","muy controlado","bien controlado"],
      ["cada detalle"],
      ["est√° planeado","esta planeado","se planifica","est√° planificado","esta planificado"],
      ["para garantizar","para asegurar"],
      ["comodidad"],
      ["eficiencia","y eficiencia"],
      ["incluso en clase econ√≥mica","incluso en clase economica","hasta en clase econ√≥mica","clase econ√≥mica","clase economica"]
    ]
  }
];

/* Grammar gap-fill (Foundation): 5 gaps from pool (15 total) */
const GRAMMAR_POOL = [
  { prompt:"Ayer, yo ______ (repasar) para mi examen.", answer:"repas√©", alt:["repase"] },
  { prompt:"En el instituto, ______ muchas reglas.", answer:"hay", alt:[] },
  { prompt:"El a√±o que viene, ______ (ir) a elegir espa√±ol.", answer:"voy", alt:[] },
  { prompt:"Nosotros ______ (escribir) siempre con tinta negra.", answer:"escribimos", alt:[] },
  { prompt:"Mi casa ______ (ser) grande y moderna.", answer:"es", alt:[] },
  { prompt:"Mi profesor ______ (explicar) bien las instrucciones.", answer:"explica", alt:[] },
  { prompt:"Yo ______ (hacer) mis deberes despu√©s de cenar.", answer:"hago", alt:[] }
];

/* 40-word prompts (Foundation Q3) ‚Äî themes 1‚Äì3 only */
const PROMPTS_40 = {
  t1: {
    themeName:"Tema 1 ‚Äî Instituto",
    title:"40 palabras: Mi vida en el instituto Otono",
    bullets:[
      "Describe your school (one detail).",
      "Say one rule you follow.",
      "Mention a subject or a teacher.",
      "Give your opinion."
    ],
    required:{
      bulletVocab: [
        [...THEME_VOCAB.t1],
        ["regla","norma","prohibido","obligatorio","instrucciones","tinta","bol√≠grafo","boligrafo","uniforme"],
        ["mates","matem√°ticas","matematicas","ciencias","espa√±ol","espanol","profesor","barley"],
        [...DETECT.opinion]
      ],
      wordMin:34, wordMax:55,
      mustHaveOpinion:true,
      must:{},
      themeKey:["t1"]
    }
  },
  t2: {
    themeName:"Tema 2 ‚Äî Ocio / regi√≥n",
    title:"40 palabras: Mis aficiones y mi zona",
    bullets:[
      "Say what you do in your free time.",
      "Mention a game or activity.",
      "Describe your house or area (one detail).",
      "Give your opinion."
    ],
    required:{
      bulletVocab: [
        [...THEME_VOCAB.t2],
        ["minecraft","roblox","juego","juegos","videojuegos","m√∫sica","musica","piano","viol√≠n","violin","trompeta","carrera","velocidad"],
        ["casa","habitaci√≥n","habitacion","barrio","zona","regi√≥n","region","√°tico","atico","piso","parque"],
        [...DETECT.opinion]
      ],
      wordMin:34, wordMax:55,
      mustHaveOpinion:true,
      must:{},
      themeKey:["t2"]
    }
  },
  t3: {
    themeName:"Tema 3 ‚Äî Otono Team",
    title:"40 palabras: El mundo Otono (avi√≥n o mansi√≥n)",
    bullets:[
      "Mention Otono Airways or Otono Mansion.",
      "Give one detail (plane/rooms).",
      "Explain why you like it.",
      "Give your opinion."
    ],
    required:{
      bulletVocab: [
        ["otono","airways","mansi√≥n","mansion","residencia"],
        ["a380","avi√≥n","avion","cabina","asiento","sal√≥n","salon","habitaciones","pasillo","lounge"],
        ["porque","ya que","me gusta","me encanta"],
        [...DETECT.opinion]
      ],
      wordMin:34, wordMax:55,
      mustHaveOpinion:true,
      must:{},
      themeKey:["t3"]
    }
  }
};

/* 70-word prompt bank: themes 1‚Äì4 (theme 4 only in higher) */
const PROMPTS_70 = {
  t1: [
    { code:"T1-A", title:"Tema 1: Reglas y ex√°menes", bullets:[
        "Describe your school (one detail).",
        "Give one exam rule (ink / instructions).",
        "Describe one past experience.",
        "Give your opinion."
      ],
      required:{
        wordMin:60, wordMax:90,
        must:{ past:true, present:true, future:true, opinion:true },
        bulletVocab:[
          [...THEME_VOCAB.t1],
          ["tinta","instrucciones","prohibido","obligatorio","vigilante","bol√≠grafo","boligrafo","examen"],
          [...DETECT.past],
          [...DETECT.opinion]
        ],
        themeKey:["t1"]
      }
    },
    { code:"T1-C", title:"Tema 1: Mi clase ideal", bullets:[
        "Say what your ideal class is like.",
        "Say what the teacher does.",
        "Mention one past problem you had.",
        "Say what you will change next time + opinion."
      ],
      required:{
        wordMin:60, wordMax:90,
        must:{ past:true, present:true, future:true, opinion:true },
        bulletVocab:[
          ["clase","profesor","instrucciones","reglas","normas","ambiente"],
          ["explica","ayuda","corrige","organiza","organiza"],
          [...DETECT.past],
          [...DETECT.opinion]
        ],
        themeKey:["t1"]
      }
    }
  ],
  t2: [
    { code:"T2-A", title:"Tema 2: Juegos y competici√≥n", bullets:[
        "Say what you do in your free time.",
        "Describe a past gaming moment.",
        "Say a future plan (next week).",
        "Give your opinion."
      ],
      required:{
        wordMin:60, wordMax:90,
        must:{ past:true, present:true, future:true, opinion:true },
        bulletVocab:[
          [...THEME_VOCAB.t2],
          ["minecraft","roblox","juego","juegos","servidor","carrera","velocidad"],
          [...DETECT.future],
          [...DETECT.opinion]
        ],
        themeKey:["t2"]
      }
    },
    { code:"T2-B", title:"Tema 2: M√∫sica y disciplina", bullets:[
        "Say what instrument/music you do now.",
        "Describe a past practice moment.",
        "Give a future goal.",
        "Give your opinion."
      ],
      required:{
        wordMin:60, wordMax:90,
        must:{ past:true, present:true, future:true, opinion:true },
        bulletVocab:[
          ["m√∫sica","musica","piano","viol√≠n","violin","trompeta","instrumento","practicar","ensayar"],
          [...DETECT.past],
          [...DETECT.future],
          [...DETECT.opinion]
        ],
        themeKey:["t2"]
      }
    }
  ],
  t3: [
    { code:"T3-A", title:"Tema 3: Un vuelo con Otono Airways", bullets:[
        "Describe the cabin/experience.",
        "Mention a class (economy/business/first).",
        "Give a past detail.",
        "Give a future trip plan + opinion."
      ],
      required:{
        wordMin:60, wordMax:90,
        must:{ past:true, present:true, future:true, opinion:true },
        bulletVocab:[
          ["otono","airways","vuelo","avi√≥n","avion","a380","cabina","asiento","comodidad","organizaci√≥n","organizacion"],
          ["clase econ√≥mica","clase economica","business","primera","premium","sal√≥n","salon","lounge"],
          [...DETECT.past],
          [...DETECT.opinion]
        ],
        themeKey:["t3"]
      }
    },
    { code:"T3-B", title:"Tema 3: Vivir en Otono Mansion", bullets:[
        "Describe the mansion.",
        "Mention shared spaces/rules.",
        "Describe a past moment.",
        "Give a future plan + opinion."
      ],
      required:{
        wordMin:60, wordMax:90,
        must:{ past:true, present:true, future:true, opinion:true },
        bulletVocab:[
          ["otono","mansi√≥n","mansion","residencia","habitaciones","pasillo","sal√≥n","salon","normas","reglas"],
          ["espacios","compartidos","silencio","limpieza","organizaci√≥n","organizacion"],
          [...DETECT.past],
          [...DETECT.opinion]
        ],
        themeKey:["t3"]
      }
    }
  ],
  t4: [
    { code:"T4-A", title:"Tema 4: Clayton y el 160/160 (solo higher)", bullets:[
        "Explain what happened (the score).",
        "Describe at least two reactions.",
        "Mention pressure/comparison.",
        "Give a future plan + opinion."
      ],
      required:{
        wordMin:60, wordMax:90,
        must:{ past:true, present:true, future:true, opinion:true },
        bulletVocab:[
          ["clayton","160","puntuaci√≥n","puntuacion","perfecto","perfecta","mates","matem√°ticas","adelantado","antelaci√≥n","antelacion"],
          ["admiraci√≥n","admiracion","envidia","reacci√≥n","reaccion","reacciones","comentarios"],
          ["presi√≥n","presion","comparaci√≥n","comparacion","estr√©s","estres"],
          [...DETECT.opinion]
        ],
        themeKey:["t4"]
      }
    }
  ]
};

/* 110-word prompt bank (Higher only): choose 4 questions, themes 1‚Äì4 allowed */
const PROMPTS_110 = {
  t1: [
    { code:"H1-1", title:"Tema 1: Reglas escolares ‚Äî ¬ønecesarias o demasiado estrictas?", bullets:[
        "Discuss rules/procedures (ink / instructions) with examples.",
        "Give your opinion with justification + future plan."
      ],
      required:{
        wordMin:95, wordMax:140,
        must:{ opinion:true, past:true, future:true },
        bulletVocab:[
          ["reglas","normas","instrucciones","examen","tinta","bol√≠grafo","boligrafo","prohibido","obligatorio","instituto","escuela"],
          [...DETECT.opinion]
        ],
        themeKey:["t1"]
      }
    }
  ],
  t2: [
    { code:"H2-1", title:"Tema 2: Competici√≥n ‚Äî presi√≥n y progreso", bullets:[
        "Explain how competition affects you (games/music/sport).",
        "Give your opinion with past example + future goals."
      ],
      required:{
        wordMin:95, wordMax:140,
        must:{ opinion:true, past:true, future:true },
        bulletVocab:[
          ["competici√≥n","competicion","presi√≥n","presion","progreso","puntuaci√≥n","puntuacion","estr√©s","estres","mejorar","entrenar"],
          [...DETECT.opinion]
        ],
        themeKey:["t2"]
      }
    }
  ],
  t3: [
    { code:"H3-1", title:"Tema 3: Otono Airways ‚Äî calidad y comodidad", bullets:[
        "Describe the passenger experience and organisation.",
        "Give your opinion and travel plans."
      ],
      required:{
        wordMin:95, wordMax:140,
        must:{ opinion:true, past:true, future:true },
        bulletVocab:[
          ["otono","airways","vuelo","avi√≥n","avion","a380","cabina","asiento","comodidad","organizaci√≥n","organizacion","clase econ√≥mica","clase economica","sal√≥n","salon"],
          [...DETECT.opinion]
        ],
        themeKey:["t3"]
      }
    },
    { code:"H3-2", title:"Tema 3: Otono Mansion ‚Äî ventajas y desaf√≠os", bullets:[
        "Describe life in a mega-residence (rules/shared spaces).",
        "Give your opinion + a future idea to improve it."
      ],
      required:{
        wordMin:95, wordMax:140,
        must:{ opinion:true, past:true, future:true },
        bulletVocab:[
          ["otono","mansi√≥n","mansion","residencia","habitaciones","pasillo","sal√≥n","salon","reglas","normas","espacios compartidos","limpieza","silencio"],
          [...DETECT.opinion]
        ],
        themeKey:["t3"]
      }
    }
  ],
  t4: [
    { code:"H4-1", title:"Tema 4: Perfecci√≥n vs progreso (Clayton)", bullets:[
        "Explain the situation and reactions (at least two).",
        "Give your opinion about pressure and progress + future plan."
      ],
      required:{
        wordMin:95, wordMax:140,
        must:{ opinion:true, past:true, future:true },
        bulletVocab:[
          ["clayton","160","puntuaci√≥n","puntuacion","perfecci√≥n","perfeccion","progreso","presi√≥n","presion","comparaci√≥n","comparacion","admiraci√≥n","admiracion","envidia","reputaci√≥n","reputacion"],
          [...DETECT.opinion]
        ],
        themeKey:["t4"]
      }
    }
  ]
};

/* =========================================================
   TIME OPTIONS (Foundation cannot use 75)
========================================================= */
function populateTimeOptions(){
  const tier = $("#tier").value;
  const sel = $("#timeAllowed");
  const prev = sel.value;

  sel.innerHTML = "";
  let options;

  if(tier === "foundation"){
    options = [{ v:60, label:"60 minutes" },{ v:45, label:"45 minutes" }];
    $("#timeNote").innerHTML = "Foundation tier: <strong>75 minutes is not allowed</strong>.";
  } else {
    options = [{ v:75, label:"75 minutes (recommended)" },{ v:60, label:"60 minutes" },{ v:45, label:"45 minutes" }];
    $("#timeNote").innerHTML = "Higher tier: 75 minutes allowed.";
  }

  const validValues = new Set(options.map(o => String(o.v)));
  const useValue = validValues.has(String(prev)) ? String(prev) : String(options[0].v);

  options.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = String(o.v);
    opt.textContent = o.label;
    if(opt.value === useValue) opt.selected = true;
    sel.appendChild(opt);
  });
}
$("#tier").addEventListener("change", populateTimeOptions);

/* =========================================================
   PAPER GENERATION
========================================================= */
let state = {
  mode:"home",
  submitted:false,
  candidateNo:null,
  candidateName:"",
  tier:"foundation",
  paper:null
};

function generatePaper(tier){
  const includeTheme4 = (tier==="higher") && (Math.random() < 0.45);
  const themesAllowed70 = tier==="foundation" ? ["t1","t2","t3"] : (includeTheme4 ? ["t1","t2","t3","t4"] : ["t1","t2","t3"]);
  const themesAllowed110 = ["t1","t2","t3","t4"];

  const q = {};
  if(tier==="foundation"){
    q.translation = pickRandom(FOUNDATION_TRANSLATION_POOL, 5);
    q.grammar = pickRandom(GRAMMAR_POOL, 5);
    const t40 = pickRandom(["t1","t2","t3"],1)[0];
    q.w40 = PROMPTS_40[t40];

    let pool70 = [];
    themesAllowed70.forEach(k => pool70 = pool70.concat(PROMPTS_70[k]));
    q.w70 = pickRandom(pool70, 3);
  }else{
    q.translation = pickRandom(HIGHER_TRANSLATION_POOL, 1)[0];

    let pool70 = [];
    themesAllowed70.forEach(k => pool70 = pool70.concat(PROMPTS_70[k]));
    q.w70 = pickRandom(pool70, 3);

    let pool110 = [];
    themesAllowed110.forEach(k => pool110 = pool110.concat(PROMPTS_110[k]));
    q.w110 = pickRandom(pool110, 4);
  }
  return { tier, includeTheme4, questions:q };
}

/* =========================================================
   RENDERING
========================================================= */
function renderHome(){
  $("#homeBody").classList.remove("hide");
  $("#testBody").classList.add("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideBody").classList.remove("hide");
  $("#sideTitle").textContent = "Grading rules";
  $("#sideMeta").textContent = "Pass/Merit/Distinction stays the same regardless of 9‚Äì1 grade.";
  $("#timerText").textContent = "--:--";
  setBadge("Ready","badge");
}

function renderTest(){
  $("#homeBody").classList.add("hide");
  $("#testBody").classList.remove("hide");
  $("#resultsBody").classList.add("hide");
  $("#sideBody").classList.remove("hide");

  const tier = state.tier;
  const cand = `${state.candidateNo}${state.candidateName ? " ‚Ä¢ "+state.candidateName : ""}`;
  $("#kpiCandidate").textContent = cand;
  $("#kpiTier").textContent = tier.toUpperCase();
  $("#kpiMax").textContent = tier==="foundation" ? "90" : "100";
  $("#kpiTheme4").textContent = state.paper.includeTheme4 ? "YES" : "NO";

  const mins = parseInt($("#timeAllowed").value,10);
  const auto = $("#autoSubmit").value === "yes";
  $("#paperInfo").innerHTML = `
    <strong>Instructions:</strong> No dictionary/translator. Answer the bullet points. Show time frames when required.
    <br/><strong>Tier:</strong> ${escapeHtml(tier.toUpperCase())} ‚Ä¢ <strong>Time:</strong> ${mins} min ‚Ä¢ <strong>Auto-submit:</strong> ${auto ? "ON" : "OFF"}
  `;

  const paperDiv = $("#paper");
  paperDiv.innerHTML = "";
  $("#markingBox").classList.add("hide");
  $("#markingBox").innerHTML = "";
  state.submitted = false;

  const q = state.paper.questions;

  if(tier==="foundation"){
    paperDiv.appendChild(renderFoundationTranslation(q.translation));
    paperDiv.appendChild(renderFoundationGrammar(q.grammar));
    paperDiv.appendChild(render40(q.w40));
    paperDiv.appendChild(render70Choice(q.w70, "foundation"));
  }else{
    paperDiv.appendChild(renderHigherTranslation(q.translation));
    paperDiv.appendChild(render70Choice(q.w70, "higher"));
    paperDiv.appendChild(render110Choice(q.w110));
  }

  startTimer(mins, () => {
    if($("#autoSubmit").value==="yes") submitPaper(true);
    else alert("Time is up. You can still submit manually.");
  });

  setBadge("In progress","badge warn");
}

function makeTaskCard(title, meta, innerHtml){
  const wrap = document.createElement("div");
  wrap.className = "task";
  wrap.innerHTML = `
    <h3>${escapeHtml(title)}</h3>
    <div class="small">${escapeHtml(meta)}</div>
    <div class="divider"></div>
    ${innerHtml}
  `;
  return wrap;
}

function renderFoundationTranslation(items){
  const lines = items.map((it,i)=>`
    <div class="mcChoice">
      <strong>Sentence ${i+1}</strong> (5 marks)<br/>
      <div class="small" style="margin-top:6px">${escapeHtml(it.en)}</div>
      <label>Your Spanish</label>
      <textarea id="ft_s${i+1}" placeholder="Write the Spanish translation here..."></textarea>
    </div>
  `).join("");
  return makeTaskCard("Q1 Translation into Spanish", "25 marks ‚Ä¢ 5 sentences ‚Ä¢ Meaning + accuracy", lines);
}

function renderHigherTranslation(item){
  const html = `
    <div class="note">
      <strong>Translate into Spanish</strong> (Higher Tier)<br/>
      Marking: <strong>ideas</strong> + <strong>Spanish quality</strong> (Spanish-ness, connectors, length).<br/>
      <div class="divider"></div>
      <div class="small">${escapeHtml(item.en)}</div>
    </div>

    <label>Your Spanish translation</label>
    <textarea id="ht_par" placeholder="Write your full Spanish paragraph here..."></textarea>
    <div class="small" id="ht_wc"></div>
  `;
  const card = makeTaskCard("Q1 Translation into Spanish", "20 marks ‚Ä¢ ideas (10) + quality (10)", html);
  setTimeout(()=>wireWordCount("ht_par","ht_wc"), 0);
  return card;
}

function renderFoundationGrammar(items){
  const lines = items.map((it,i)=>`
    <div class="mcChoice">
      <strong>Gap ${i+1}</strong> (3 marks)<br/>
      <div class="small" style="margin-top:6px">${escapeHtml(it.prompt)}</div>
      <label>Your answer (one word/short phrase)</label>
      <input type="text" id="gg_${i+1}" placeholder="e.g. repas√©" />
    </div>
  `).join("");
  return makeTaskCard("Q2 Grammar gap-fill","15 marks ‚Ä¢ 5 gaps ‚Ä¢ 3 marks each", lines);
}

function render40(p){
  const html = `
    <div class="note">
      <strong>${escapeHtml(p.themeName)}</strong><br/>
      Write about <strong>40 words</strong>. Answer all 4 bullet points. (No choice)
      <ul class="bullets">
        ${p.bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}
      </ul>
    </div>

    <label>Your 40-word answer (Spanish)</label>
    <textarea id="w40" placeholder="‚âà 40 words..."></textarea>
    <div class="small" id="w40_wc"></div>
  `;
  const card = makeTaskCard("Q3 40-word writing","20 marks ‚Ä¢ bullets + opinion + relevance", html);
  setTimeout(()=>wireWordCount("w40","w40_wc"), 0);
  return card;
}

function render70Choice(items, tier){
  const html = `
    <div class="note">
      Write about <strong>70 words</strong>. Choose <strong>ONE</strong> question.
      You must include: <strong>past + present + future + opinion</strong>.
    </div>

    <div id="w70_choices">
      ${items.map((q,i)=>`
        <div class="mcChoice">
          <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer">
            <input type="radio" name="w70_pick" value="${i}" style="margin-top:3px" ${i===0?"checked":""}/>
            <div>
              <strong>Option ${String.fromCharCode(65+i)} ‚Äî ${escapeHtml(q.title)}</strong>
              <ul class="bullets">${q.bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}</ul>
              <div class="small">Code: ${escapeHtml(q.code)}</div>
            </div>
          </label>
        </div>
      `).join("")}
    </div>

    <label>Your 70-word answer (Spanish)</label>
    <textarea id="w70" placeholder="‚âà 70 words..."></textarea>
    <div class="small" id="w70_wc"></div>
  `;
  const title = tier==="foundation" ? "Q4 70-word writing (choose 1 of 3)" : "Q2 70-word writing (choose 1 of 3)";
  const meta = `30 marks ‚Ä¢ content + timeframes + opinion + range + relevance`;
  const card = makeTaskCard(title, meta, html);
  setTimeout(()=>wireWordCount("w70","w70_wc"), 0);
  return card;
}

function render110Choice(items){
  const html = `
    <div class="note">
      Write about <strong>110 words</strong>. Choose <strong>ONE</strong> question.
      Develop your ideas clearly.
    </div>

    <div id="w110_choices">
      ${items.map((q,i)=>`
        <div class="mcChoice">
          <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer">
            <input type="radio" name="w110_pick" value="${i}" style="margin-top:3px" ${i===0?"checked":""}/>
            <div>
              <strong>Option ${i+1} ‚Äî ${escapeHtml(q.title)}</strong>
              <ul class="bullets">${q.bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join("")}</ul>
              <div class="small">Code: ${escapeHtml(q.code)}</div>
            </div>
          </label>
        </div>
      `).join("")}
    </div>

    <label>Your 110-word answer (Spanish)</label>
    <textarea id="w110" placeholder="‚âà 110 words..."></textarea>
    <div class="small" id="w110_wc"></div>
  `;
  const card = makeTaskCard("Q3 110-word writing (choose 1 of 4)","50 marks ‚Ä¢ content + timeframes + opinion + range + relevance", html);
  setTimeout(()=>wireWordCount("w110","w110_wc"), 0);
  return card;
}

function wireWordCount(textareaId, outId){
  const ta = $("#"+textareaId);
  const out = $("#"+outId);
  if(!ta || !out) return;
  const draw = () => out.textContent = `Word count: ${wordCount(ta.value)}`;
  ta.addEventListener("input", draw);
  draw();
}

/* =========================================================
   NEW ‚ÄúSENSIBLE‚Äù MARKING (same logic as French sensible version)
========================================================= */
function containsAny(textNorm, phrases){
  return phrases.some(p => textNorm.includes(norm(p)));
}
function countHits(textNorm, vocab){
  let hits = 0;
  vocab.forEach(w=>{
    const k = norm(w);
    if(k && textNorm.includes(k)) hits++;
  });
  return hits;
}

/* Spanish markers */
const SPANISH_MARKERS = [
  "yo","tu","t√∫","el","√©l","ella","nosotros","vosotros","ustedes",
  "porque","pero","aunque","sin embargo","por eso","ademas","adem√°s",
  "hoy","ayer","manana","ma√±ana","ahora","en el futuro","la semana",
  "mi","mis","un","una","unos","unas","de","del","al","con","sin"
];
const CONNECTORS = ["porque","aunque","sin embargo","por eso","adem√°s","ademas","por ejemplo","tambi√©n","en cambio","mientras","cuando"];
const RANGE_MARKERS = ["que","si","cuando","mientras","para que","antes de","despu√©s de","despues de","a pesar de","ya que","por ejemplo","lo que"];

/* Higher translation marking:
   - Ideas: 10 (1 per idea group hit)
   - Quality: 10 (Spanish-ness markers + connectors + sensible length)
*/
function markHigherTranslation(user, keyIdeas){
  const t = norm(user);
  const wc = wordCount(user);
  if(!t) return {score:0, max:20, detail:"Blank.", parts:{ideas:0, quality:0}};

  let ideaHits = 0;
  keyIdeas.forEach(group=>{
    const alts = Array.isArray(group) ? group : [group];
    if(alts.some(k => t.includes(norm(k)))) ideaHits++;
  });
  const ideas = clamp(ideaHits, 0, 10);

  let markerHits = 0;
  SPANISH_MARKERS.forEach(m => { if(t.includes(norm(m))) markerHits++; });
  const markerScore = clamp(Math.round((markerHits/12)*6), 0, 6); // up to 6

  const connScore = clamp(countHits(t, CONNECTORS) >= 1 ? 2 : 0, 0, 2); // up to 2

  let lenScore = 0;
  if(wc >= 18 && wc <= 70) lenScore = 2;
  else if(wc >= 12 && wc <= 90) lenScore = 1;

  const quality = clamp(markerScore + connScore + lenScore, 0, 10);

  const score = ideas + quality;
  const detail = `Ideas: ${ideas}/10 (hits ${ideaHits}). Quality: ${quality}/10 (markers ${markerScore}/6, connectors ${connScore}/2, length ${lenScore}/2, WC ${wc}).`;
  return {score, max:20, detail, parts:{ideas, quality}};
}

/* Foundation translation marking (integer) */
function markFoundationTranslationSentence(user, keys){
  const t = norm(user);
  if(!t) return {score:0, max:5, detail:"Blank."};
  let groups = keys.length;
  let hit = 0;
  keys.forEach(g => { if(g.some(k => t.includes(norm(k)))) hit++; });
  const raw = (hit / groups) * 5;
  const score = clamp(Math.round(raw), 0, 5);
  return {score, max:5, detail:`Matched ${hit}/${groups} key chunks.`};
}

/* Grammar marking: 3 correct, 2 close, 1 partial, 0 wrong */
function markGap(user, answer, alt){
  const u = norm(user);
  const a = norm(answer);
  const alts = (alt||[]).map(norm);
  if(!u) return {score:0, max:3, detail:"Blank."};
  if(u === a || alts.includes(u)) return {score:3, max:3, detail:"Correct."};

  const aTokens = a.split(" ").filter(Boolean);
  const hitAll = aTokens.every(tok => u.includes(tok));
  if(hitAll) return {score:2, max:3, detail:"Close: right idea but not exact form."};

  const core = aTokens[aTokens.length-1];
  if(core && u.includes(core)) return {score:1, max:3, detail:"Partially correct form."};
  return {score:0, max:3, detail:"Incorrect."};
}

/* Writing marking:
   - Content/bullets (40%)
   - Time frames (20%)
   - Opinion (10%)
   - Range (20%)
   - Word count (10%)
   - Relevance multiplier (0.25..1.0) not a hard cap
*/
function markWriting(text, spec, maxMarks, themeKey){
  const t = norm(text);
  const wc = wordCount(text);
  if(!t) return {score:0, max:maxMarks, detail:"Blank.", parts:{}};

  const wcMax = Math.round(maxMarks * 0.10);
  const min = spec.wordMin ?? 0;
  const max = spec.wordMax ?? 9999;
  let wcScore = 0;
  if(wc >= min && wc <= max) wcScore = wcMax;
  else if(wc >= Math.round(min*0.8) && wc <= Math.round(max*1.25)) wcScore = Math.round(wcMax*0.6);
  else if(wc >= Math.round(min*0.6)) wcScore = Math.round(wcMax*0.3);

  const contentMax = Math.round(maxMarks * 0.40);
  const bulletGroups = spec.bulletVocab || [];
  let bulletHits = 0;
  bulletGroups.forEach(group => { if(containsAny(t, group)) bulletHits++; });
  const contentScore = bulletGroups.length
    ? Math.round((bulletHits / bulletGroups.length) * contentMax)
    : contentMax;

  const tfMax = Math.round(maxMarks * 0.20);
  let tfHits = 0, tfNeed = 0;
  if(spec.must?.past){ tfNeed++; if(containsAny(t, DETECT.past)) tfHits++; }
  if(spec.must?.present){ tfNeed++; if(containsAny(t, DETECT.present)) tfHits++; }
  if(spec.must?.future){ tfNeed++; if(containsAny(t, DETECT.future)) tfHits++; }
  const tfScore = tfNeed ? Math.round((tfHits / tfNeed) * tfMax) : tfMax;

  const opMax = Math.round(maxMarks * 0.10);
  const opScore = containsAny(t, DETECT.opinion) ? opMax : (spec.mustHaveOpinion ? Math.round(opMax*0.5) : 0);

  const rangeMax = Math.round(maxMarks * 0.20);
  const connHits = countHits(t, CONNECTORS);
  const rangeHits = countHits(t, RANGE_MARKERS);
  const neg = (t.includes(" no ") || t.startsWith("no ")) ? 1 : 0;
  const rawRange = connHits + rangeHits + neg;
  const rangeScore = clamp(Math.round((rawRange/6) * rangeMax), 0, rangeMax);

  // relevance multiplier
  let vocabPool = [];
  if(themeKey==="t1") vocabPool = THEME_VOCAB.t1;
  if(themeKey==="t2") vocabPool = THEME_VOCAB.t2;
  if(themeKey==="t3") vocabPool = THEME_VOCAB.t3;
  if(themeKey==="t4") vocabPool = THEME_VOCAB.t4;
  if(!vocabPool.length) vocabPool = [].concat(THEME_VOCAB.t1, THEME_VOCAB.t2, THEME_VOCAB.t3, THEME_VOCAB.t4);

  const themeHits = countHits(t, vocabPool);
  const expected = maxMarks <= 20 ? 2 : (maxMarks <= 30 ? 3 : 4);
  let mult = 1.0;
  if(themeHits < 1) mult = 0.25;
  else if(themeHits < expected) mult = 0.65;
  else if(themeHits < expected + 2) mult = 0.85;

  const raw = wcScore + contentScore + tfScore + opScore + rangeScore;
  const score = clamp(Math.round(raw * mult), 0, maxMarks);

  const detail =
    `WC ${wc} => ${wcScore}/${wcMax}; content ${bulletHits}/${bulletGroups.length} => ${contentScore}/${contentMax}; `+
    `timeframes ${tfHits}/${tfNeed} => ${tfScore}/${tfMax}; opinion => ${opScore}/${opMax}; range(raw ${rawRange}) => ${rangeScore}/${rangeMax}; `+
    `themeHits ${themeHits} => multiplier ${mult.toFixed(2)}; final ${score}/${maxMarks}.`;

  return {score, max:maxMarks, detail, parts:{wcScore, contentScore, tfScore, opScore, rangeScore, themeHits, mult}};
}

/* =========================================================
   SUBMIT + TOTAL
========================================================= */
function guessThemeKeyFrom70(code){
  if(code.startsWith("T1")) return "t1";
  if(code.startsWith("T2")) return "t2";
  if(code.startsWith("T3")) return "t3";
  if(code.startsWith("T4")) return "t4";
  return null;
}
function guessThemeKeyFrom110(code){
  if(code.startsWith("H1")) return "t1";
  if(code.startsWith("H2")) return "t2";
  if(code.startsWith("H3")) return "t3";
  if(code.startsWith("H4")) return "t4";
  return null;
}
function guessThemeKeyFrom40(themeName){
  const tn = themeName || "";
  if(tn.includes("Tema 1") || tn.includes("Theme 1")) return "t1";
  if(tn.includes("Tema 2") || tn.includes("Theme 2")) return "t2";
  if(tn.includes("Tema 3") || tn.includes("Theme 3")) return "t3";
  return null;
}

function computeTotal(){
  const tier = state.tier;
  const q = state.paper.questions;
  let total = 0;
  let breakdown = [];

  if(tier==="foundation"){
    let tScore = 0;
    q.translation.forEach((it,i)=>{
      const ans = $("#ft_s"+(i+1)).value;
      const res = markFoundationTranslationSentence(ans, it.esKeys);
      tScore += res.score;
      breakdown.push({part:`Q1 Sentence ${i+1}`, score:res.score, max:res.max, detail:res.detail});
    });
    total += tScore;

    let gScore = 0;
    q.grammar.forEach((it,i)=>{
      const ans = $("#gg_"+(i+1)).value;
      const res = markGap(ans, it.answer, it.alt);
      gScore += res.score;
      breakdown.push({part:`Q2 Gap ${i+1}`, score:res.score, max:res.max, detail:`${res.detail} (expected: ${it.answer})`});
    });
    total += gScore;

    const w40Text = $("#w40").value;
    const tKey = guessThemeKeyFrom40(q.w40.themeName);
    const w40 = markWriting(w40Text, q.w40.required, 20, tKey);
    total += w40.score;
    breakdown.push({part:"Q3 40-word", score:w40.score, max:w40.max, detail:w40.detail});

    const pick = parseInt(($("input[name='w70_pick']:checked")?.value ?? "0"),10);
    const chosen = q.w70[pick];
    const w70Text = $("#w70").value;
    const themeKey = guessThemeKeyFrom70(chosen.code);
    const w70 = markWriting(w70Text, chosen.required, 30, themeKey);
    total += w70.score;
    breakdown.push({part:`Q4 70-word (${chosen.code})`, score:w70.score, max:w70.max, detail:w70.detail});

    return { total: clamp(Math.round(total),0,90), max: 90, breakdown, chosenCodes:{w70:chosen.code, w40:q.w40.title} };
  }

  const tAns = $("#ht_par").value;
  const tRes = markHigherTranslation(tAns, q.translation.keyIdeas);
  total += tRes.score;
  breakdown.push({part:`Q1 Translation (${q.translation.id})`, score:tRes.score, max:20, detail:tRes.detail});

  const pick70 = parseInt(($("input[name='w70_pick']:checked")?.value ?? "0"),10);
  const chosen70 = q.w70[pick70];
  const w70TextH = $("#w70").value;
  const theme70 = guessThemeKeyFrom70(chosen70.code);
  const w70H = markWriting(w70TextH, chosen70.required, 30, theme70);
  total += w70H.score;
  breakdown.push({part:`Q2 70-word (${chosen70.code})`, score:w70H.score, max:30, detail:w70H.detail});

  const pick110 = parseInt(($("input[name='w110_pick']:checked")?.value ?? "0"),10);
  const chosen110 = q.w110[pick110];
  const w110Text = $("#w110").value;
  const theme110 = guessThemeKeyFrom110(chosen110.code);
  const w110 = markWriting(w110Text, chosen110.required, 50, theme110);
  total += w110.score;
  breakdown.push({part:`Q3 110-word (${chosen110.code})`, score:w110.score, max:50, detail:w110.detail});

  return { total: clamp(Math.round(total),0,100), max: 100, breakdown, chosenCodes:{w70:chosen70.code, w110:chosen110.code} };
}

function submitPaper(fromAuto=false){
  if(state.submitted) return;
  state.submitted = true;
  stopTimer();

  const res = computeTotal();
  const total = res.total;
  const tier = state.tier;

  const pmd = passMeritDistinction(total);
  const g9 = grade9to1(total, tier);
  const gah = gradeAH(total, tier);
  const [cls, txt] = badgeForScore(total);

  const attempt = {
    centre:"50749",
    candidateNo:String(state.candidateNo),
    candidateName:state.candidateName || "",
    tier,
    submittedAt: nowISO(),
    timeAllowedMin: parseInt($("#timeAllowed").value,10),
    includeTheme4: state.paper.includeTheme4,
    maxScore: res.max,
    score: total,
    passMeritDistinction: pmd,
    grade9to1: g9,
    gradeAH: gah,
    chosenCodes: res.chosenCodes,
    breakdown: res.breakdown
  };
  addResult(attempt);

  const box = $("#markingBox");
  box.classList.remove("hide");
  box.innerHTML = `
    <div class="card">
      <div class="hd">
        <div>
          <h2 style="margin:0;font-size:14px">‚úÖ Marked${fromAuto ? " (auto-submitted)" : ""}</h2>
          <div class="meta">Saved to Results ‚Ä¢ Candidate ${escapeHtml(attempt.candidateNo)} ‚Ä¢ Tier ${escapeHtml(tier.toUpperCase())}</div>
        </div>
        <span class="${cls}">${escapeHtml(txt)}</span>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box"><div class="t">Score</div><div class="v">${attempt.score} / ${attempt.maxScore}</div></div>
          <div class="box"><div class="t">Pass/Merit/Dist</div><div class="v">${escapeHtml(attempt.passMeritDistinction)}</div></div>
          <div class="box"><div class="t">9‚Äì1 grade</div><div class="v">${escapeHtml(String(attempt.grade9to1))}</div></div>
          <div class="box"><div class="t">A‚ÄìH grade</div><div class="v">${escapeHtml(String(attempt.gradeAH))}</div></div>
        </div>

        <div class="divider"></div>

        <div class="note">
          <strong>Spanish marking:</strong> Translation = ideas + quality. Writing = content + timeframes + opinion + range + word range + relevance multiplier.
        </div>

        <div class="divider"></div>

        <button class="btn" id="btnShowBreakdown">Show breakdown</button>
        <div id="bdList" class="hide" style="margin-top:12px"></div>
      </div>
    </div>
  `;

  $("#btnShowBreakdown").addEventListener("click", ()=>{
    const d = $("#bdList");
    d.classList.toggle("hide");
    if(!d.classList.contains("hide")){
      d.innerHTML = res.breakdown.map(b=>`
        <div class="attempt">
          <div class="top">
            <div><strong>${escapeHtml(b.part)}</strong></div>
            <div><span class="badge">${b.score} / ${b.max}</span></div>
          </div>
          <div class="meta">${escapeHtml(b.detail)}</div>
        </div>
      `).join("");
    }
  });

  setBadge("Submitted","badge good");
}

/* =========================================================
   RESULTS PANEL
========================================================= */
function drawResults(){
  const listEl = $("#resultsList");
  const all = loadResults();
  const filter = ($("#filterCandidate").value || "").trim();
  const filtered = filter ? all.filter(a => String(a.candidateNo) === String(filter)) : all;

  if(filtered.length === 0){
    listEl.innerHTML = `<div class="note">No stored attempts${filter ? " for this candidate" : ""}.</div>`;
    return;
  }

  listEl.innerHTML = filtered.map(a=>{
    const [cls, txt] = badgeForScore(a.score);
    return `
      <div class="attempt">
        <div class="top">
          <div>
            <strong>${escapeHtml(a.candidateNo)}</strong>${a.candidateName ? " ‚Ä¢ " + escapeHtml(a.candidateName) : ""}
            <span class="badge" style="margin-left:8px">Centre ${escapeHtml(a.centre)}</span>
            <span class="badge" style="margin-left:8px">${escapeHtml(a.tier.toUpperCase())}</span>
          </div>
          <div class="${cls}">${escapeHtml(txt)} ‚Ä¢ ${escapeHtml(String(a.score))}/${escapeHtml(String(a.maxScore))}</div>
        </div>
        <div class="meta">
          <div><strong>Date:</strong> ${escapeHtml(new Date(a.submittedAt).toLocaleString())}</div>
          <div><strong>Grades:</strong> PMD ${escapeHtml(a.passMeritDistinction)} ‚Ä¢ 9‚Äì1 ${escapeHtml(String(a.grade9to1))} ‚Ä¢ A‚ÄìH ${escapeHtml(String(a.gradeAH))}</div>
          <div><strong>Theme 4 included?</strong> ${a.includeTheme4 ? "YES" : "NO"} ‚Ä¢ <strong>Time:</strong> ${escapeHtml(String(a.timeAllowedMin))} min</div>
        </div>
      </div>
    `;
  }).join("");
}
function exportResults(){
  const all = loadResults();
  $("#exportText").textContent = JSON.stringify(all, null, 2);
  $("#exportBox").classList.remove("hide");
}
function clearResults(){
  if(!confirm("Clear ALL stored Spanish Writing results on this browser?")) return;
  localStorage.removeItem(STORE_KEY);
  $("#exportBox").classList.add("hide");
  drawResults();
}

/* =========================================================
   NAVIGATION / EVENTS
========================================================= */
$("#btnHome").addEventListener("click", ()=>{
  state.mode="home";
  renderHome();
});
$("#btnResults").addEventListener("click", ()=>{
  state.mode="results";
  $("#sideBody").classList.add("hide");
  $("#resultsBody").classList.remove("hide");
  $("#sideTitle").textContent = "Saved results";
  $("#sideMeta").textContent = "Stored in this browser (localStorage).";
  setBadge("Results","badge");
  stopTimer();
  $("#timerText").textContent="--:--";
  drawResults();
});

$("#tabAll").addEventListener("click", ()=>{
  $("#tabAll").classList.add("active");
  $("#tabCandidate").classList.remove("active");
  $("#filterCandidate").value="";
  drawResults();
});
$("#tabCandidate").addEventListener("click", ()=>{
  $("#tabCandidate").classList.add("active");
  $("#tabAll").classList.remove("active");
  $("#filterCandidate").focus();
});
$("#filterCandidate").addEventListener("input", drawResults);
$("#btnExport").addEventListener("click", exportResults);
$("#btnClear").addEventListener("click", clearResults);

/* Preview */
$("#btnPreview").addEventListener("click", ()=>{
  const c = ($("#candidateNo").value || "").trim();
  if(!c){ alert("Enter a candidate number first."); return; }
  const tier = $("#tier").value;
  const paper = generatePaper(tier);

  const box = $("#previewBox");
  box.classList.remove("hide");

  if(tier==="foundation"){
    box.innerHTML = `
      <strong>Preview (not started)</strong><br/>
      Tier: <strong>${escapeHtml(tier.toUpperCase())}</strong><br/>
      Q1: 5 translation sentences<br/>
      Q2: 5 grammar gaps<br/>
      Q3: 40-word theme: <strong>${escapeHtml(paper.questions.w40.themeName)}</strong><br/>
      Q4: 70-word options: <strong>${paper.questions.w70.map(x=>escapeHtml(x.code)).join(", ")}</strong>
    `;
  }else{
    box.innerHTML = `
      <strong>Preview (not started)</strong><br/>
      Tier: <strong>${escapeHtml(tier.toUpperCase())}</strong><br/>
      Q1: Translation paragraph: <strong>${escapeHtml(paper.questions.translation.id)}</strong><br/>
      Q2: 70-word options: <strong>${paper.questions.w70.map(x=>escapeHtml(x.code)).join(", ")}</strong><br/>
      Q3: 110-word options: <strong>${paper.questions.w110.map(x=>escapeHtml(x.code)).join(", ")}</strong><br/>
      Theme 4 included somewhere? <strong>${paper.includeTheme4 ? "YES" : "NO"}</strong>
    `;
  }
});

/* Start */
$("#btnStart").addEventListener("click", ()=>{
  const c = ($("#candidateNo").value || "").trim();
  if(!c){ alert("Candidate number is required."); return; }

  state.candidateNo = c;
  state.candidateName = ($("#candidateName").value || "").trim();
  state.tier = $("#tier").value;
  state.paper = generatePaper(state.tier);

  populateTimeOptions();
  renderTest();
});

/* Reset */
$("#btnReset").addEventListener("click", ()=>{
  if(!confirm("Reset and generate a NEW random Spanish writing paper?")) return;
  stopTimer();
  state.paper = generatePaper(state.tier);
  renderTest();
});

/* Submit */
$("#btnSubmit").addEventListener("click", ()=>submitPaper(false));

/* =========================================================
   INITIALISE
========================================================= */
function renderHomeSide(){
  $("#resultsBody").classList.add("hide");
  $("#sideBody").classList.remove("hide");
}
populateTimeOptions();
renderHome();

/* =========================================================
   Anti-cheat (same)
========================================================= */
const disabledKeys = ["u", "I"];
const showAlert = e => {
  e.preventDefault();
  return alert("Hahaha, I challenge you, valiant soldier, to uproot the source codes yourself!!!");
};
document.addEventListener("contextmenu", e => { showAlert(e); });
document.addEventListener("keydown", e => {
  if ((e.ctrlKey && disabledKeys.includes(e.key)) || e.key === "F12") showAlert(e);
});
</script>

</body>
</html>
